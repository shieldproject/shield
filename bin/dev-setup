#!/bin/bash
set -e

cd "$(dirname "${BASH_SOURCE[0]}")"

#if no cli, make cli
if [[ ! -f "../shield" ]]
then
  pushd .. && make shield-cli
  popd
fi

shieldbackend="http://localhost:8181"
shield="../shield -k --raw -D"
jq="jq -Mr"
targetdir=$1
storedir=$2

echo targetdir=$targetdir
echo storedir=$storedir

$shield create-backend localdev $shieldbackend
echo "backend created"
target=$($shield create-target <<EOF | $jq .uuid
{
  "agent"    : "127.0.0.1:5444",
  "endpoint" : "{\"base_dir\":\"${targetdir}\",\"bsdtar\":\"bsdtar\",\"exclude\":\"var/*.db\"}",
  "name"     : "DevTarget",
  "plugin"   : "fs",
  "summary"  : "The working directory of the dev environment."
}
EOF )
if [[ "$target" = "null" ]]; then
  echo >&2 "Failed to create the DevTarget target"
  exit 1
fi
echo "target=$target"

store=$($shield create-store <<EOF | $jq .uuid
{
  "endpoint" : "{\"base_dir\":\"${storedir}\",\"bsdtar\":\"bsdtar\"}",
  "name"     : "DevStore",
  "plugin"   : "fs",
  "summary"  : "A temporary store for the dev environment."
}
EOF )
if [[ "$store" = "null" ]]; then
  echo >&2 "Failed to create the DevStore store"
  exit 1
fi
echo "store=$store"

policy=$($shield create-policy <<EOF | $jq .uuid
{
  "name"    : "DevPolicy",
  "summary" : "A Test Policy",
  "expires" : 86400
}
EOF )
if [[ "$policy" = "null" ]]; then
  echo >&2 "Failed to create the DevPolicy retention policy"
  exit 1
fi
echo "target=$target"
echo "policy=$policy"

$shield create-job <<EOF
{
  "name"      : "DevJob",
  "paused"    : true,
  "retention" : "$policy",
  "schedule"  : "daily 4am",
  "store"     : "$store",
  "summary"   : "A Test Job",
  "target"    : "$target"
}
EOF

$shield run DevJob
sleep 2
$shield run DevJob
$shield edit-target DevTarget<<EOF
{
  "agent"    : "127.0.0.1:5444",
  "endpoint" : "{\"base_dir\":\"/e/no/ent\",\"bsdtar\":\"bsdtar\"}",
  "name"     : "DevTarget",
  "plugin"   : "fs",
  "summary"  : "The working directory of the dev environment."
}
EOF
sleep 3
$shield run DevJob
sleep 3
$shield run DevJob

echo "DONE"
