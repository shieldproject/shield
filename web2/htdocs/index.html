<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/shield.css" />
  </head>
  <body>
    <div class="top-bar"><h1>SHIELD</h1></div>
    <div id="viewport" class="full"></div>

    <script type="text/html" id="tpl--layout"><!-- {{{ -->
      [[#
        {layout}

        The main (authenticated) layout for the UI
      ]]
      <div class="story-sidebar">
        <nav>
          <li><a href="#!/do/backup">Perform an ad hoc backup</a>
              <p>Run a backup job whenever you need to, regardless of the job's
              schedule.</p></li>

          <li><a href="#">Restore data from a backup</a>
              <p>Restore a protected system back to the state it was in when a
              backup archive was taken.</p></li>

          <li><a href="#">Configure a new backup job</a>
              <p>Set up a new protected system, and configure the how, when,
              and for how long of managing its backup archives.</p></li>
        </nav>

        <footer>
          <a target="_blank" href="https://github.com/starkandwayne/shield"><img src="/i/social/github.png"></a>
          <a target="_blank" href="https://cloudfoundry.slack.com"><img src="/i/social/slack.png"></a>
          <a target="_blank" href="https://twitter.com/starkandwayne"><img src="/i/social/twitter.png"></a>
          <p>SHIELD Copyright &copy; 2017 Stark & Wayne</p>
        </footer>
      </div>
      <div class="pane">
        <div class="hud blk" id="hud">
          <div class="x5"><div class="inst">
            <ul>
              <li class="shield">SHIELD &hellip;</li>
            </ul>
          </div></div>

          <div class="x5"><div class="health">
            <div class="fill"></div>
          </div></div>

          <div class="x6"><div class="prot">
            <div class="fill"></div>
          </div></div>
        </div>

        <div class="nav sticky" id="sticky-nav">
          <nav>
            <li><a href="#!/systems">Systems</a></li>
            <li class="current"><a href="#!/stores">Storage</a></li>
            <li><a href="#!/policies">Retention</a></li>
            [[ if ($global.auth.is.system.engineer) { ]]<li><a href="#!/admin">Admin</a></li>[[ } ]]
          </nav>
        </div>

        <div class="nav">
          <nav>
            <li><a href="#!/systems">Systems</a></li>
            <li class="current"><a href="#!/stores">Storage</a></li>
            <li><a href="#!/policies">Retention</a></li>
            [[ if ($global.auth.is.system.engineer) { ]]<li><a href="#!/admin">Admin</a></li>[[ } ]]
          </nav>
        </div>

        <div class="field" id="main">
        <!--
          <div class="gutter blk">
            <h2>Configure A New Backup Job</h2>
            <form>

              <div class="band">
                <div class="info">Lorem ipsum dolor sit amet, cons ectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation ullamcorper suscipit lobortis nisl ut aliquip ex ea commodo conse.</div>
                <div class="ctl">
                  <label>Label</label>
                  <input type="text" placeholder="Placeholder">
                  <p class="hints">(Hints) Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore.</p>
                  <p class="examples">For example: <strong>example 1</strong>, <strong>example 2</strong>, or <strong>example 3</strong>.</p>
                </div>
              </div>


                <div class="band">
                  <div class="info">Lorem ipsum dolor sit amet, cons ectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation ullamcorper suscipit lobortis nisl ut aliquip ex ea commodo conse.</div>
                  <div class="ctl">
                    <label>Label</label>
                    <select>
                      <option>Apples</option>
                      <option>Bananas</option>
                    </select>
                    <p class="hints">(Hints) Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore.</p>
                    <p class="examples">For example: <strong>example 1</strong>, <strong>example 2</strong>, or <strong>example 3</strong>.</p>
                  </div>
                </div>

                <div class="band">
                  <div class="info">Lorem ipsum dolor sit amet, cons ectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation ullamcorper suscipit lobortis nisl ut aliquip ex ea commodo conse.</div>
                  <div class="ctl">
                    <input type="checkbox"> <label>Label</label>
                    <p class="hints">(Hints) Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore.</p>
                    <p class="examples">For example: <strong>example 1</strong>, <strong>example 2</strong>, or <strong>example 3</strong>.</p>
                  </div>
                </div>

                <div class="band">
                  <div class="info">Lorem ipsum dolor sit amet, cons ectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation ullamcorper suscipit lobortis nisl ut aliquip ex ea commodo conse.</div>
                  <div class="ctl">
                    <label>Label</label>
                    <textarea placeholder="your code goes here..."></textarea>
                    <p class="hints">(Hints) Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore.</p>
                    <p class="examples">For example: <strong>example 1</strong>, <strong>example 2</strong>, or <strong>example 3</strong>.</p>
                  </div>
                </div>
              </form>
            </div>
            -->
            <img id="loading" src="/i/loading.svg"/>
          </div>
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--loading"><!-- {{{ -->
      [[#
        {loading} template

        A simple SVG loading screen that keeps the viewer entertained while we
        go talk to SHIELD over AJAX, asynchronously.
      ]]
      <img id="loading" src="/i/loading.svg"/>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--overlay"><!-- {{{ -->
      [[#
        {overlay}

        A page overlay washes out the main page, makes the viewport fixed
        and non-scrollable, and then displays a message, warning, notice,
        or update to ensure that the viewer sees it.
      ]]
      <div id="overlay">
        <div class="header"><h2>[[= maybe(_.title, "SHIELD") ]]</h2></div>
        <div class="frame">
      <p>Neque porro quisquam est, qui dolorem ipsum quia dolor. Nam libero tempore,
      cum soluta nobis est. Duis aute irure dolor in reprehenderit in voluptate velit
      esse cillum dolore eu fugiat nulla. Ut enim ad minim veniam, quis nostrud
      exercitation ullamco laboris. Quis autem vel eum iure reprehenderit qui in ea
      voluptate velit esse quam nihil molestiae consequatur, vel.</p>

      <p>Nemo enim ipsam voluptatem quia. Nam libero tempore, cum soluta nobis est
      eligendi optio cumque. Duis aute irure dolor in reprehenderit in voluptate velit
      esse cillum dolore eu fugiat nulla pariatur. Et harum quidem rerum facilis est et
      expedita distinctio. Ut enim ad minima veniam, quis.</p>

      <p>Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit,
      sed quia consequuntur magni. Excepteur sint occaecat cupidatat non proident, sunt
      in culpa qui officia deserunt mollit. Duis aute irure dolor in reprehenderit in
      voluptate velit esse. Et harum quidem. Ut enim ad minim veniam, quis nostrud
      exercitation ullamco laboris nisi ut aliquip ex ea commodo.</p>

      <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore
      eu fugiat nulla pariatur. Sed ut perspiciatis unde omnis iste natus error sit
      voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae.
      Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut
      aliquip ex ea commodo consequat. At vero eos et accusamus et iusto odio
      dignissimos ducimus qui blanditiis praesentium voluptatum deleniti. Nemo enim
      ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia
      consequuntur magni.</p>

          [[= _.html ]]
        </div>
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--banner"><!-- {{{ -->
      [[#
        {banner} template

        Displays a message at the top of the viewport
      ]]
      <p class="[[= _.type ]]">[[= _.message ]]</p>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--error"><!-- {{{ -->
      [[#
        {error} template

        Displays a page-wide error, for failures involving AJAX requests,
        unhandled exceptions, etc.
      ]]
          <div class="gutter blk error">
            <h2>Uh-oh &mdash; Something broke.</h2>
            <p id="message">[[= _.message ]]</p>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--restore-are-you-sure"><!-- {{{ -->
      [[#
        {restore-are-you-sure}

        A modal interaction screen that requires the operator to acknowledge
        that what they are about to do is in fact to restore data, that it
        might be dangerous, and it might not work out.
      ]]
          <div class="confirm">
            <h2>You Are About To Restore Data</h2>
            <p>You have requested that S.H.I.E.L.D. restore <em>[[= _.target ]]</em>
            from a backup that was taken <em>[[= strftime("on %A, %B %d, %Y at %H:%M%P", _.taken) ]]</em> ([[= duration(tdiff(_.taken, new Date())) ]] ago).
            Any new data created after that point in time <em>will be lost</em>.</p>

            <p>Addtionally, the target system may be <em>offline or non-operational</em>
            while the restore operation is carried out.</p>

            <p class="q">Are you sure you want to restore <em>[[= _.target ]]</em>?</p>
            <div class="a">
              <button class="danger" rel="yes">Yes, Initiate Restore</button>
              <button class="safe" rel="close">No, Cancel This Operation</button>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--login"><!-- {{{ -->
      [[#
        {login} template

        Displays the login screen, which is a slightly different layout than
        most of the interface.  If OAuth2 backends have been configured, those
        are displayed as links to kick off the necessary OAuth2 flows (although
        they are styled as buttons)
      ]]
          <div id="login" class="frontdoor">
            <div[[ if (_.providers.length == 0) { ]] class="local-only"[[ } ]]>
              <h1>SHIELD<span style="color: [[= $global.hud.shield.color || 'green' ]]">[[= $global.hud.shield.env ]]<span></h1>
              <div class="dialog">
                <p class="motd">[[= $global.hud.shield.motd ]]</p>

                [[ if (_.providers.length > 0) { ]]
                <div class="oauth2">
                  <h2>Sign in using...</h2>

                  <ul>
                    [[ $.each(_.providers, function (i, provider) { ]]
                    <li class="provider-[[= provider.type ]]"><a class="login" href="[[= provider.web_entry ]]">[[= provider.name ]]</a></li>
                    [[ }); ]]
                </div>
                [[ } ]]
                <div class="local">
                  <h2>Sign in with your SHIELD account</h2>
                  <p class="divert">Need an account? <a href="#">Sign up for one today.</a></p>

                  <form>
                    <div class="error"></div>
                    <div class="ctl" data-field="username">
                      <label for="local-login-username">Username</label>
                      <div class="errors">
                        <span data-error="missing">Please supply your username.</span>
                      </div>
                      <input type="text" id="local-login-username" name="username">
                    </div>
                    <div class="ctl" data-field="password">
                      <label for="local-login-password">Password</label>
                      <div class="errors">
                        <span data-error="missing">Please supply your password.</span>
                      </div>
                      <input type="password" id="local-login-password" name="password">
                      <a class="forgotpw" href="#">Forgot your password?</a>
                    </div>
                    <div class="ctl cb">
                      <div class="cbdark">
                        <input type="checkbox" id="local-login-remember-me" name="remember-me">
                        <label for="local-login-remember-me"></label>
                      </div>
                      <label for="local-login-remember-me">Remember me</label>
                    </div>
                    <button>Sign in</button>
                  <form>
                </div>
              </div>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--cliauth"><!-- {{{ -->
      [[#
        {cliauth} template

        Displays the session ID for an authenticated session, so that the CLI
        can be told what that session ID is.
      ]]
          <div id="cliauth" class="frontdoor">
            <div>
              <h1>SHIELD<span>Production<span></h1>
              <div class="dialog">
                <h2>CLI Authentication Credentials</h2>
                <img src="/i/terminal.png" class="highlight">

                <p>Here are your SHIELD CLI authentication
                credentials:</p>

                <pre id="creds">[[= _.s ]]</pre>

                <p>You will need to copy-and-paste those into
                the terminal session where you ran the SHIELD
                command-line interface, to complete the
                authentication process.</p>
              </div>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--logging-in"><!-- {{{ -->
      [[#
        {logging-in} template

        A simple loading screen that keeps the viewer apprised of
        our login efforts, while the browser processes the actual
        login and/or redirection.
      ]]
      <div id="logging-in">
        <p><img src="/i/loading-icon.svg"/>
           Signing into <span>SHIELD</span> via <span>[[= _.auth ]]</span>...</p>
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--BOOM"><!-- {{{ -->
      [[#
        {BOOM} template

        Displays a viewport-bound error message (without the hud/sidebar chrome)
        when SHIELD fails to boot up properly.  Typically, this means that we
        failed in our AJAX request to get the Authentication Providers to render
        the login page.
      ]]
          <div id="BOOM" class="frontdoor">
            <div>
              <h1>SHIELD<span>Production<span></h1>
              <div class="dialog">
                <h2>SOMETHING BROKE</h2>
                <img src="/i/boom.png" class="highlight">
                <p>An error has occurred, and SHIED was unable to recover from it.
                Your SHIELD site administrator may be able to peruse the SHIELD
                logs on this installation to shed some light on this conundrum.</p>

                <p>Most of the time, this is related to an inability to retrieve
                the authentication parameters for this SHIELD instance.  You may
                want to check to make sure you are connected to the internet, and
                if you need to hook up to any VPNs to access SHIELD, ensure that
                they too are connected.</p>
              </div>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--top-bar"><!-- {{{ -->
      [[#
        {top-bar} template

        Renders the top-most bar, with the SHIELD name / environment, and the
        current users name / tenant and "personal settings" menu.
      ]]
        <h1><a href="#!/systems">SHIELD [[ if (_.shield.color) { ]]<span style="color:[[= _.shield.color ]]">[[ } ]][[= _.shield.env ]]</span> <span>[[= _.shield.ip ]]</span></a></h1>
        [[ if (_.user) { ]]
        <a href="#!/account" rel="account">[[= _.user.name ]][[ if (_.tenant) { ]] ([[= _.tenant.name ]])[[ } ]]</a>
        <div class="flyout ephemeral">
          <div class="menu">
            <div class="header">Signed in as [[= _.user.account ]]
              <span>[[= _.user.backend ]]</span>
            </div>
            <div class="divider"></div>
            [[ if (_.tenants.length == 0) { ]]
            <span class="dropdown odd">you have no tenants</span>
            [[ } else { ]]
            [[   $.each(_.tenants, function (i, tenant) { ]]
            <a class="dropdown[[ if (tenant.uuid == _.tenant.uuid) { ]] current-tenant[[ } ]]" href="switchto:[[= tenant.uuid ]]">[[= tenant.name ]]</a>
            [[   }); ]]
            [[ } ]]
            <div class="divider"></div>
            <!--a class="dropdown" href="#!/settings">Settings</a-->
            <a class="dropdown" href="#!/logout">Sign Out</a>
          </div>
        </div>
        [[ } ]]
    <!-- }}} --></script>
    <script type="text/html" id="tpl--hud"><!-- {{{ -->
        [[#
          {hud} template

          Renders the "health and wellness" heads-up display (HUD), with more
          information about this SHIELD instance (name / env / IP / version),
          health and key metrics.
        ]]
            <div class="x5"><div class="inst">
              <ul>
                <li class="shield">SHIELD <span class="v">[[= _.shield.version ]]</span></li>
                <li class="ip">[[= _.shield.ip ]]</li>
                <li class="fqdn">[[= _.shield.fqdn ]]</li>
                <li class="env"><span style="color: [[= maybe(_.shield.color, "#8CC63F") ]]">[[= _.shield.env ]]</span></li>
              </ul>
            </div></div>

            <div class="x5"><div class="health">
              <div class="preload" style="display: none">
                <object type="image/svg+xml" data="i/api-ok.svg"></object>
                <object type="image/svg+xml" data="i/api-fail.svg"></object>
                <object type="image/svg+xml" data="i/cloud-ok.svg"></object>
                <object type="image/svg+xml" data="i/cloud-fail.svg"></object>
                <object type="image/svg+xml" data="i/job-ok.svg"></object>
                <object type="image/svg+xml" data="i/job-fail.svg"></object>
              </div>
              <ul>
                [[ if (_.health.core == "unsealed" || _.health.core == "unlocked") { ]]
                <li class="ok"><object type="image/svg+xml" data="i/api-ok.svg"></object> SHIELD is <span>up</span></li>
                [[ } else if (_.health.core == "sealed" || _.health.core == "locked") { ]]
                <li class="fail"><object type="image/svg+xml" data="i/api-fail.svg"></object> SHIELD is <span>LOCKED</span></li>
                [[ } else if (_.health.core == "uninitialized") { ]]
                <li class="fail"><object type="image/svg+xml" data="i/api-fail.svg"></object> SHIELD is <span>UNINITIALIZED</span></li>
                [[ } else if (_.health.core == "unreachable") { ]]
                <li class="fail"><object type="image/svg+xml" data="i/api-fail.svg"></object> SHIELD is <span>unreachable</span></li>
                [[ } else { ]]
                <li class="fail"><object type="image/svg+xml" data="i/api-fail.svg"></object> SHIELD is <span>unknown</span></li>
                [[ } ]]
                [[ if (_.health.storage_ok) { ]]
                <li class="ok"><object type="image/svg+xml" data="i/cloud-ok.svg"></object> Cloud Storage is <span>connected</span></li>
                [[ } else { ]]
                <li class="fail"><object type="image/svg+xml" data="i/cloud-fail.svg"></object> Cloud Storage is <span>failing</span></li>
                [[ } ]]
                [[ if (_.health.jobs_ok) { ]]
                <li class="ok"><object type="image/svg+xml" data="i/jobs-ok.svg"></object> All Jobs <span>succeeding</span></li>
                [[ } else { ]]
                <li class="fail"><object type="image/svg+xml" data="i/jobs-fail.svg"></object> Jobs are <span>failing</span></li>
                [[ } ]]
              </ul>
            </div></div>

            <div class="x6"><div class="prot">
              <h3>Data Protection Summary</h3>
              <ul>
                <li>Scheduled Backup Jobs <span>[[= _.stats.jobs ]]</span></li>
                <li>Backup Archives <span>[[= _.stats.archives ]]</span></li>
                <li class="warn">Cloud Storage Used <span>[[= bytes(_.stats.storage) ]]</span></li>
                <li class="ok">Daily Storage Increase <span>[[= bytes(_.stats.daily) ]]</span></li>
              </ul>
            </div></div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--404"><!-- {{{ -->
      [[#
        {404} template

        Help a lost traveller on their way.
      ]]
          <div class="gutter blk e404">
            <h2>Oops.  We Couldn't Find That...</h2>
            <img src="/i/404.png" width="30%">
            <p>Looks like someone or some<em>thing</em> directed you to a part of the SHIELD
            web interface that just doesn't exist.  Bummer.  If you are sure this is SHIELD's
            fault (and it very well could be), please report an issues over at our
            <a href="https://github.com/starkandwayne/shield/issues/new" target="_blank">Github
            Page</a>.</p>

            <pre>You can paste this additional information
      into your Github issue:

      - **Wanted URL**: [[= _.wanted ]]
      - **Arguments**:  ([[= _.args.join(', ') ]])
      - **Referer**:    [[= maybe(_.referer, '_none_') ]]
      </pre>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--account"><!-- {{{ -->
      [[#
        {account}

        Shows the user their current account information,
        including a form for changing their name (and, if
        local, their password), and a list of all tenants
        that they belong to, and their roles therein.
      ]]
          <div class="gutter blk account">
            <h2>My Account</h2>

            <form>
              <p><label for="name">Display</label>
              <input type="text" value="" /></p>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--roles-menu"><!-- {{{ -->
      [[#
        {roles-menu}

        A flyout menu for selecting roles, on either tenants
        (if given {type: "tenant"}) or the system ({type: "system"}).
      ]]
      <div class="roles-menu ephemeral">
        [[ if (_.type == 'tenant') { ]]
        <div[[ if (_.current == "admin") { ]] class="current"[[ } ]] data-role="admin">
          <strong>Administrator</strong>
          <p>Full control over this tenant.</p>
        </div>
        <div[[ if (_.current == "engineer") { ]] class="current"[[ } ]] data-role="engineer">
          <strong>Engineer</strong>
          <p>Can do everything except manage other peoples
             access to this tenant.</p>
        </div>
        <div[[ if (_.current == "operator") { ]] class="current"[[ } ]] data-role="operator">
          <strong>Operator</strong>
          <p>View access to most things, with the ability to
             pause and unpause jobs, run ad hoc backups, and
             perform restore operations.</p>
        </div>
        [[ } else { ]]
        <div[[ if (_.current == "admin") { ]] class="current"[[ } ]] data-role="admin">
          <strong>Administrator</strong>
          <p>Full control over SHIELD.</p>
        </div>
        <div[[ if (_.current == "manager") { ]] class="current"[[ } ]] data-role="manager">
          <strong>Manager</strong>
          <p>Can create and edit tenants, manage tenant/user
             memberships, and manage user accounts and access rights.</p>
        </div>
        <div[[ if (_.current == "engineer") { ]] class="current"[[ } ]] data-role="engineer">
          <strong>Engineer</strong>
          <p>Manages global configuration, including shared cloud
             storage configurations and retention policy templates.</p>
        </div>
        [[ } ]]
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--you-have-no-tenants"><!-- {{{ -->
      [[#
        {you-have-no-tenants} template

        What do you do when someone tries to access the parts of
        SHIELD that require a tenancy context, yet they have no
        tenants to speak of?  Why, you show them this little screen,
        of course!
      ]]
          <div class="gutter blk e404">
            <h2>Hrmm.  You Don't Seem To Belong To Any Tenants</h2>
            <p>This part of SHIELD only makes sense in the context of a tenant.
            However, it seems that your account has not been invited to participate
            in any tenants yet.</p>

            <p>You may want to reach out to your SHIELD administrator and ask them
            to assign you to a tenant, or check their configuration if they believe
            you ought to just be automagically assigned to one by the system.</p>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--access-denied"><!-- {{{ -->
      [[#
        {access-denied} template

        What do you do when someone tries to access the parts of
        SHIELD that require a certain level of access that is above
        their role assignment?  Try this screen!

        The following data can be provided to tailor the message:

          level: "system"    What level is access being denied at.
                             The value 'system' applies to global,
                             administrative contexts; 'tenant'
                             indicates a per-tenant ACL violation.

          need: "role"       What role is needed to gain access to
                             the given resource.

      ]]
          <div class="gutter blk">
            <h2>Access Denied</h2>
            [[ var want = _.level + '/' + _.need; ]]
            [[ if (want == 'system/admin') { ]]
                 <p>This part of SHIELD requires site-level <strong>administator</strong> access.</p>
                 <p>Only SHIELD site administrators can grant this level of access.</p>
            [[ } else if (want == 'system/manager') { ]]
                 <p>This part of SHIELD requires site-level <strong>manager</strong> access.</p>
                 <p>Only SHIELD site administrators can grant this level of access.</p>
            [[ } else if (want == 'system/engineer') { ]]
                 <p>This part of SHIELD requires site-level <strong>engineer</strong> access.</p>
                 <p>Only SHIELD site administrators can grant this level of access.</p>
            [[ } else if (want == 'tenant/admin') { ]]
                 <p>In order to access this part of SHIELD, you need to be
                 an <strong>administrator</strong> on this tenant.</p>
                 <p>Please contact your SHIELD site operators if you believe
                 you should have this level of access.</p>
            [[ } else if (want == 'tenant/engineer') { ]]
                 <p>In order to modify the configuration of resources on this
                 tenant, you need to be granted <strong>engineer</strong>-level
                 access.</p>
                 <p>Please consult your tenant administrators if you believe
                 you should have this level of access.</p>
            [[ } else if (want == 'tenant/operator') { ]]
                 <p>In order to operate on this tenant, you will need to be
                 granted <strong>operator</strong>-level access.</p>
                 <p>Please consult your tenant administrators if you believe
                 you should have this level of access.</p>
            [[ } else { ]]
                 <p>This part of SHIELD requires <strong>[[= _.level ]]/[[= _.need ]]</strong>
                    access, which seems to be an invalid role.  Please submit a bug report.</p>
            [[ } ]]
          </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--init"><!-- {{{ -->
      [[#
        {init} template

        Renders a form allowing administrators (sys_role = admin) to initialize
        this SHIELD core.
      ]]
        <div class="gutter blk">
          <h2>This SHIELD Core is UNINITIALIZED</h2>
          <p>Et harum quidem rerum. Neque porro quisquam est, qui dolorem ipsum. Nam libero
              tempore. Itaque earum rerum hic tenetur a sapiente delectus, ut aut reiciendis
              voluptatibus maiores alias. At vero eos et accusamus et iusto odio dignissimos.</p>

          <form class="init-shield">
            <div class="error"></div>

            <div class="ctl" data-field="master">
              <label for="init-master">Pick a Master Password</label>
              <span class="errors">
                <span data-error="missing">You must specify a master password</span>
              </span>
              <div class="widget">
                <input type="password" id="init-master" name="master">
              </div>
            </div>

            <div class="ctl" data-field="confirm">
              <label for="init-confirm">Confirm</label>
              <span class="errors">
                <span data-error="missing">You must confirm your master password</span>
                <span data-error="mismatch">Your passwords don't match</span>
              </span>
              <div class="widget">
                <input type="password" id="init-confirm" name="confirm">
                <p class="help">SHIELD will encrypt the secure storage Vault using
                the master password you choose, and then promptly forget it.</p>
              </div>
            </div>

            <button class="go">Initialize</button>
          </form>
        </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--unlock"><!-- {{{ -->
      [[#
        {unlock} template

        Renders a form allowing anyone with knowledge of the SHIELD master
        password to unlock the SHIELD core, and resume normal operations.
      ]]
        <div class="gutter blk">
          <h2>This SHIELD Core is LOCKED</h2>
          <p>Et harum quidem rerum. Neque porro quisquam est, qui dolorem ipsum. Nam libero
              tempore. Itaque earum rerum hic tenetur a sapiente delectus, ut aut reiciendis
              voluptatibus maiores alias. At vero eos et accusamus et iusto odio dignissimos.</p>

          <form class="unlock-shield">
            <label for="unlock-master">Enter your SHIELD Master Password</label>
            <input type="password" id="unlock-master" name="master"><button>Unlock</button>
          </form>
        </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--do-backup"><!-- {{{ -->
      [[#
        {do-backup} - Backup Wizard Template

        Renders a multi-step, interactive wizard to assist operators in
        finding the correct backup archive to restore, based on what
        data system they want to restore, and how fresh the backup needs
        to be.
      ]]
      [[
        var stores = {};
        if (!_.system) {
          _.store = undefined;
          _.policy = undefined;
        }

        if (_.system && !_.store) {
          _.policy = undefined;
          $.each(_.system.jobs, function (i, job) {
            _.store = stores[job.store.uuid] = job.store;
            job.store.plugin = job.to;
          });
          if (_.noauto || Object.keys(stores).length != 1) {
            _.store = undefined;
          }
        }

        var policies = {};
        if (_.system && _.store && !_.policy) {
          $.each(_.system.jobs, function(i, job) {
            if (job.store.uuid = _.store.uuid) {
              _.policy = policies[job.retention.uuid] = job.retention;
            }
          });
          if (_.noauto || Object.keys(policies).length != 1) {
            _.policy = undefined;
          }
        }
      ]]
      <div class="gutter blk wizard do-backup">
        <p class="do-caption">Performing an Ad Hoc Backup</p>
        <div class="picks">
          [[ if (_.system) { ]]
          <div class="job card [[ if (!_.system.ok) { ]]fail[[ } else { ]]ok[[ } ]]">
          <a href="do-backup:unpick">
            <img src="i/shield-[[= _.system.ok ? 'ok' : 'fail' ]].svg">
            <h3>[[= _.system.name ]]</h3>
            <div class="notes">[[= _.system.notes ]]</div>
          </a>
          </div>
          [[ } else { ]]
          <div class="job card empty">Protected System</div>
          [[ } ]]
          [[ if (_.store) { ]]
          <div class="store card [[ if (!_.store.ok) { ]]fail[[ } else { ]]ok[[ } ]]">
          <a href="do-backup:unpick">
            <img src="i/shield-[[= _.store.ok ? 'ok' : 'fail' ]].svg">
            <h3>[[= _.store.name ]]</h3>
            <div class="notes">[[ if (_.store.summary) { ]]
              [[= _.store.summary ]]
            [[ } else { ]]
              <div class="no-data">No summary provided.  Too bad.</div>
            [[ } ]]</div>
            <div class="graph[[ if (!_.store.ok) { ]] fail[[ } ]]">
              <div class="to">[[= _.store.plugin ]]</div>
            </div>
          </a>
          </div>
          [[ } else { ]]
          <div class="store card empty">Cloud Storage</div>
          [[ } ]]
          [[ if (_.policy) { ]]
          <div class="policy card">
          <a href="do-backup:unpick">
            <h3>[[= _.policy.name ]]</h3>
            <ul class="details">
              <li>keep for [[= _.policy.days ]] day[[ if (_.policy.days != 1) { ]]s[[ } ]]</li>
            </ul>
            <div class="notes">[[= _.policy.summary ]]</div>
          </a>
          </div>
          [[ } else { ]]
          <div class="store card empty">Retention Policy</div>
          [[ } ]]
        </div>

        [[ if (!_.system) { ]]
        <div class="step pick-a-system">
          <h3>1. Pick What You Want To Back Up</h3>
          <p>Which protected system you want to back up?</p>

          <div>
          [[ $.each(_.systems, function (i, target) { ]]
          <div class="job card [[ if (!target.ok) { ]]fail[[ } else { ]]ok[[ } ]]">
            <a href="do-backup:pick:target:[[= target.uuid ]]">
            <img src="i/shield-[[= target.ok ? 'ok' : 'fail' ]].svg">
            <h3>[[= target.name ]]</h3>
            <div class="notes">[[= target.notes ]]</div>
            </a>
          </div>
          [[ }); ]]
          </div>
        </div>
        [[ } ]]

        [[ if (_.system && !_.store) { ]]
        <div class="step pick-a-store">
          <h3>2. Select Cloud Storage</h3>
          <p>Where would you like to store this backup archive?</p>

          <div>
            [[ $.each(stores, function (uuid, store) { ]]
                <div class="store card [[ if (!store.ok) { ]]fail[[ } else { ]]ok[[ } ]]">
                  <a href="do-backup:pick:store:[[= store.uuid ]]">
                  <img src="i/shield-[[= store.ok ? 'ok' : 'fail' ]].svg">
                  <h3>[[= store.name ]]</h3>
                  <div class="notes">[[ if (store.summary) { ]]
                    [[= store.summary ]]
                  [[ } else { ]]
                    <div class="no-data">No summary provided.  Too bad.</div>
                  [[ } ]]</div>
                  <div class="graph[[ if (!store.ok) { ]] fail[[ } ]]">
                    <div class="to">[[= store.plugin ]]</div>
                  </div>
                  </a>
                </div>
            [[ }); ]]
          </div>
        </div>
        [[ } ]]

        [[ if (_.system && _.store && !_.policy) { ]]
        <div class="step pick-a-retention-policy" style="display: block">
          <h3>3. Choose a Retention Policy</h3>
          <p>How long should we keep this backup?</p>

          <div>
            [[ $.each(policies, function (uuid, retention) { ]]
              <div class="policy card">
                <a href="do-backup:pick:policy:[[= retention.uuid ]]">
                <h3>[[= retention.name ]]</h3>
                <ul class="details">
                  <li>keep for [[= retention.days ]] days</li>
                </ul>
                <div class="notes">[[= retention.summary ]]</div>
                </a>
              </div>
            [[ }); ]]
          </div>
          </div>
        </div>
        [[ } ]]

        [[ if (_.system && _.store && _.policy) { ]]
        [[
          var uuid;
          for (var i = 0; i < _.system.jobs.length; i++) {
            var job = _.system.jobs[i];
            if (job.store.uuid == _.store.uuid
              && job.retention.uuid == _.policy.uuid) {

              uuid = job.uuid;
              break;
            }
          }
        ]]
        <div class="step run-the-backup" style="display: block">
          <h3>4. Review Your Choices</h3>
          <p>If everything looks correct, click the big button to
          initiate a manual backup of <strong>[[= _.system.name ]]</strong>
          to <strong>[[= _.store.name ]]</strong> &mdash; backup archive will be kept
          for <strong>[[= _.policy.days ]] days</strong>.</p>

          <button rel="run:[[= uuid ]]">Run Backup &raquo;</button>
        </div>
        [[ } ]]
      </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--systems"><!-- {{{ -->
      [[#
        {systems} template

        Renders all targets visible to / manageable by the current user.
      ]]
          <div class="gutter blk">
            <h2>Protected Data Systems</h2>
            [[ if (_.systems.length == 0) { ]]
            <div class="no-data">You have not yet configured any data systems to protect.</div>
            [[ } else { ]]
            [[ $.each(_.systems, function (i, target) { ]]
            <div class="job card [[ if (!target.ok) { ]]fail[[ } else { ]]ok[[ } ]]">
              <a href="#!/systems/system:uuid:[[= target.uuid ]]">
              <img src="i/shield-[[= target.ok ? 'ok' : 'fail' ]].svg">
              <h3>[[= target.name ]]</h3>
              [[ $.each(target.jobs, function (j, job) { ]]
              <ul class="details">
                <li>runs [[= job.schedule ]]</li>
                <li>keep [[= job.keep.n ]] backups ([[= job.keep.days ]] days)</li>
              </ul>
              <div class="graph[[ if (!job.ok) { ]] fail[[ } ]]">
                <div class="from">[[= job.from ]]</div>
                <div class="bar"></div>
                <div class="to">[[= job.to ]]</div>
              </div>
              [[ }); ]]
              </a>
            </div>
            [[ }); ]]
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--system"><!-- {{{ -->
      [[#
        {system} template

        Renders all of the jobs and backup archives for a single target.
        Enables operators to easily see when a given system is backed up,
        and facilitates quick and easy access to restore valid archives.
      ]]
          <div class="gutter" data-system-uuid="[[= _.target.uuid ]]" data-system-name="[[= _.target.name ]]">
            <div class="job card [[= _.target.ok ? 'ok' : 'fail' ]]">
              <img src="i/shield-[[= _.target.ok ? 'ok' : 'fail' ]].svg">
              <h3>[[= _.target.name ]]</h3>
              [[ $.each(_.target.jobs, function (i, job) { ]]
              <ul class="details">
                <li>runs [[= job.schedule ]] &mdash; <a href="run:[[= job.uuid ]]">run now</a></li>
                <li>keep [[= job.keep.n ]] backups ([[= job.keep.days ]] days)</li>
              </ul>
              <div class="graph[[ if (!job.ok) { ]] fail[[ } ]]">
                <div class="from">[[= job.from ]]</div>
                <div class="bar"></div>
                <div class="to">[[= job.to ]]</div>
              </div>
              [[ }); ]]
            </div>

            <div class="job summary">
              <h2>Notes</h2>
              <p>[[= html(_.target.notes) ]]</p>
            </div>

            <h2>Timeline</h2>
            <div class="timeline">
                [[ $.each(_.target.tasks, function (i, task) { ]]
                <div class="event [[= task.type ]] [[= (task.status == 'done' ? 'ok' : task.status) ]][[ if (task.notes != "") { ]] noted[[ } ]][[ if (task.status != 'done' && task.ok) { ]] handled[[ } ]]" data-task-uuid="[[= task.uuid ]]"[[ if (task.archive) { ]] data-archive-uuid="[[= task.archive.uuid ]]" data-archive-taken="[[= task.started_at ]]"[[ } ]]>
                  <ul>
                    <li class="date">[[ if (task.status == 'scheduled') { ]]
                      <em>scheduled / pending</em>
                    [[ } else { ]]
                      [[= strftime("%b %d %Y", task.started_at) ]]</li>
                    [[ } ]]
                    [[ if (task.archive) { ]]<li class="tag">[[= task.type ]]</li>[[ } ]]
                    [[ if (task.type == "backup") { ]]
                      [[ if (task.owner == "") { ]]
                      <li class="desc">[[= maybe(task.archive.schedule, 'Scheduled Backup') ]]</li>
                      <li class="meta">run automatically per job schedule</li>
                      [[ } else { ]]
                      <li class="desc">Ad Hoc Backup</li>
                      <li class="meta">run by [[= task.owner ]] at [[= strftime("%l:%M%P", task.started_at) ]]</li>
                      [[ } ]]
                    [[ } else if (task.type == "restore") { ]]
                      <li class="desc">Manual Restore</li>
                      <li class="meta">run by [[= task.owner ]]</li>
                    [[ } else if (task.type == "purge") { ]]
                      <li class="desc">Purge Expired Archive</li>
                      <li class="meta">...</li>
                    [[ } else { ]]
                      <li class="desc">[[= task.type ]] Task</li>
                    [[ } ]]
                    [[ if (task.notes != "") { ]]
                    <li class="note"><strong>Note:</strong> [[= html(task.notes) ]]</li>
                    [[ } ]]
                    <li class="expand"><a href="task:[[= task.uuid ]]">full task log</a></li>
                  </ul>
                  <div class="task"></div>
                </div>
                [[ }); ]]
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--task"><!-- {{{ -->
      [[#
        {task} template

        Displays the details of a single task, including the task log.
        Optionally, if this is being displayed in the {system} view,
        also display a big RESTORE button in the task output.
      ]]
<pre class="task-[[= _.task.status ]][[ if (_.task.ok) { ]] override[[ } ]]"><code><div>
<button class="annotate" rel="annotate:[[= _.task.uuid ]]">Annotate</button>[[ if (_.restorable) { ]]<button class="restore" rel="restore:[[= _.task.uuid ]]">Restore</button>[[ } ]]

<form class="annotate">
  <input type="hidden" name="uuid" value="[[= _.task.uuid ]]" />
  [[ if (_.task.status == "failed") { ]]
  <p><input type="checkbox" name="disposition"
            id="annotask-ok"[[ if (_.task.ok) { ]] checked[[ } ]]><label for="annotask-ok">Nothing to worry about</label></p>
  [[ } ]]
  <p><textarea name="notes" id="notes"
              placeholder="no notes recorded yet...">[[= maybe(_.task.notes, '') ]]</textarea></p>
  <button>Save</button>
</form>

</div><em>task <em>[[= _.task.uuid ]]</em></em>
<em>[[= _.task.type ]] task[[ if (_.task.started_at != "") { ]] started <em>[[= strftime("%c", _.task.started_at) ]][[ } ]]</em>[[
if (_.task.type == "purge") { ]]
purging archive <em>[[= _.task.archive_uuid ]]</em>[[
} else if (_.task.type == "restore") { ]]
restoring from archive <em>[[= _.task.archive_uuid ]]</em>[[
} ]]
initiated by <em>[[= _.task.owner ]]</em></em>

[[= _.task.log ]]

<em>[[ if (_.task.stopped_at > _.task.started_at && _.task.status != "pending") {
]]task ran for <em>[[= duration(tdiff(_.task.started_at, _.task.stopped_at)) ]]</em>
[[ }

if (_.task.type == 'backup') {
  if (_.task.archive_uuid != "") {
    ]]generated archive <em>[[= _.task.archive_uuid ]]</em>
for job <em>[[= _.task.job_uuid ]]</em>
[[
  } else {
  ]]no archive was generated.
[[
  }
} ]][[= _.task.type ]] task finished at <em>[[= strftime("%c", _.task.stopped_at) ]]</em> with status <em>[[= _.task.status ]]</em>
</em></code></pre>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--stores"><!-- {{{ -->
      [[#
        {stores} template

        Renders the currently defined (visible) storage endpoints,
        and in some cases allows for user-management of their configurations.
      ]]
          <div class="gutter blk">
            [[ if ((_.admin  && $global.auth.is.system.engineer)
                || (!_.admin && $global.auth.is.tenant[$global.auth.tenant.uuid].engineer)) { ]]
            <a class="new" href="#!/[[= _.admin ? 'admin/' : '' ]]stores/new">Configure a New Cloud Storage System&raquo;</a>
            [[ } ]]
            [[ if (_.admin) { ]]
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <h2><strong>Global</strong> Cloud Storage Systems</h2>
            <p class="notice">These are <strong>global</strong> definitions; these storage
            configurations can be used by any tenant, although they will be unable to see
            any of the sensitive details.</p>
            [[ } else { ]]
            <h2>Cloud Storage Systems</h2>
            [[ } ]]
            [[ if (_.stores.length == 0) { ]]
            <div class="no-data">No Cloud Storage Systems have been configured yet.</div>
            [[ } else { ]]
            [[ $.each(_.stores, function (i, store) { ]]
            <div class="store card [[ if (!store.ok) { ]]fail[[ } else { ]]ok[[ } ]]">
              <a href="#!/[[= _.admin ? 'admin/' : '' ]]stores/store:uuid:[[= store.uuid ]]">
              <img src="i/shield-[[= store.ok ? 'ok' : 'fail' ]].svg">
              <h3>[[= store.name ]]</h3>
              <div class="notes">[[ if (store.summary) { ]]
                [[= store.summary ]]
              [[ } else { ]]
                <div class="no-data">No summary provided.  Too bad.</div>
              [[ } ]]</div>
              <div class="graph[[ if (!store.ok) { ]] fail[[ } ]]">
                <div class="to">[[= store.plugin ]]</div>
              </div>
              </a>
            </div>
            [[ }); ]]
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--store"><!-- {{{ -->
      [[#
        {store} template

        Renders a single storage endpoint configuration, including its
        usage information and provide management capabilities.
      ]]
          <div class="gutter blk store">
            <a class="breadcrumb" href="#!/[[= _.admin ? 'admin/' : '' ]]stores">&laquo; Back to Cloud Storage Systems</a>
            <h2><div class="plugin">[[= _.store.plugin ]]</div>[[= _.store.name ]]</h2>

            [[ if ((_.admin && $global.auth.is.engineer)
                || (!_.admin && $global.auth.is.tenant[$global.auth.tenant.uuid].engineer)) { ]]
            <a class="edit"   href="#!/[[= _.admin ? 'admin/' : '' ]]stores/edit:uuid:[[= _.store.uuid ]]">Edit</a>
            <a class="delete" href="#!/[[= _.admin ? 'admin/' : '' ]]stores/delete:uuid:[[= _.store.uuid ]]">Delete</a>
            [[ } ]]

            <div class="summary">[[= _.store.summary ]]</div>

            <div class="side-by-side">
              <h3>Storage Details</h3>
              <dl>
                <dt>Backup Archives</dt>
                <dd>[[= _.store.archives ]]</dd>

                <dt>Storage Used</dt>
                <dd>[[= bytes(_.store.used) ]]</dd>

                <dt>Daily Delta</dt>
                <dd>[[= bytes(_.store.daily_delta) ]]</dd>
              </dl>
            </div>

            <div class="side-by-side">
              <h3>Configuration</h3>
              <dl>
                <dt>SHIELD Agent</dt>
                <dd>[[= _.store.agent ]]</dd>

                [[ $.each(_.store.display_config, function (i, kv) {
                     if (kv.value == "" || kv.value == false) { return; } ]]
                <dt>[[= kv.label ]]</dt>
                <dd>[[= kv.value ]]</dd>
                [[ }); ]]
              </dl>
            </div>

            <div class="meter">
              <svg width="500" height="400" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <style>
                    rect.outer    { fill: #ccc; }
                    rect.fill     { fill: #0071bc; }
                    circle.marker { fill: #333; }
                    line.marker { stroke: #333; stroke-width: 1px; }

                    text.label      { font-size: 20px; font-family: sans-serif; }
                    text.size       { font-size: 40px; font-family: sans-serif; }
                    text.size tspan { font-size: 20px; font-weight: bold; }

                    g.current      .size { fill: #7ac943; }
                    g.current.warn .size { fill: orange; }
                    g.threshold    .size { fill: #0071bc; }
                    g.projected    .size { fill: #ff1d25; }
                  </style>
                </defs>

                [[# Base value of 1M, add 20% padding for spacing ]]
                [[ var total = Math.max(_.store.used, _.store.threshold, readableToBytes("1M")) * 1.2; ]]
                <rect class="outer" x="0" y="200" width="100%" height="36"></rect>
                <rect class="fill" x="2" y="202" width="[[= 100.0 * _.store.used / total ]]%" height="32"></rect>

                [[ if (_.store.threshold > _.store.used) { ]]
                [[# "current" marker ]]
                <g class="current" transform="translate(2)">
                  <line class="marker" x1="[[= 100.0 * _.store.used / total ]]%" x2="[[= 100.0 * _.store.used / total ]]%" y1="198" y2="53"></line>
                  <circle class="marker" cx="[[= 100.0 * _.store.used / total ]]%" cy="53" r="3"></circle>
                  <g transform="translate(6)">
                    <text x="[[= 100.0 * _.store.used / total ]]%" y="60" class="label">Current</text>
                    <text x="[[= 100.0 * _.store.used / total ]]%" y="100" class="size">[[= bytes(_.store.used) ]]</text>
                  </g>
                </g>

                [[# "threshold" marker ]]
                <g class="threshold" transform="translate(2)">
                  <line class="marker" x1="[[= 100.0 * _.store.threshold / total ]]%" x2="[[= 100.0 * _.store.threshold / total ]]%" y1="198" y2="133"></line>
                  <circle class="marker" cx="[[= 100.0 * _.store.threshold / total ]]%" cy="133" r="3"></circle>
                  <g transform="translate(6)">
                    <text x="[[= 100.0 * _.store.threshold / total ]]%" y="140" class="label">Threshold</text>
                    <text x="[[= 100.0 * _.store.threshold / total ]]%" y="180" class="size">[[= bytes(_.store.threshold) ]]</text>
                  </g>
                </g>
                [[ } else { ]]

                [[# "threshold" marker ]]
                <g class="threshold" transform="translate(2)">
                  <line class="marker" x1="[[= 100.0 * _.store.threshold / total ]]%" x2="[[= 100.0 * _.store.threshold / total ]]%" y1="198" y2="53"></line>
                  <circle class="marker" cx="[[= 100.0 * _.store.threshold / total ]]%" cy="53" r="3"></circle>
                  <g transform="translate(6)">
                    <text x="[[= 100.0 * _.store.threshold / total ]]%" y="60" class="label">Threshold</text>
                    <text x="[[= 100.0 * _.store.threshold / total ]]%" y="100" class="size">[[= bytes(_.store.threshold) ]]</text>
                  </g>
                </g>

                [[# "current" marker ]]
                <g class="current warn" transform="translate(2)">
                  <line class="marker" x1="[[= 100.0 * _.store.used / total ]]%" x2="[[= 100.0 * _.store.used / total ]]%" y1="198" y2="133"></line>
                  <circle class="marker" cx="[[= 100.0 * _.store.used / total ]]%" cy="133" r="3"></circle>
                  <g transform="translate(6)">
                    <text x="[[= 100.0 * _.store.used / total ]]%" y="140" class="label">Current</text>
                    <text x="[[= 100.0 * _.store.used / total ]]%" y="180" class="size">[[= bytes(_.store.used) ]]</text>
                  </g>
                </g>
                [[ } ]]
                
                [[ if (false) { ]]
                [[# "projected" marker ]]
                <g class="projected" transform="translate(-3)">
                  <line class="marker" x1="[[= 100.0 * _.store.projected / total ]]%" x2="[[= 100.0 * _.store.projected / total ]]%" y1="238" y2="293"></line>
                  <circle class="marker" cx="[[= 100.0 * _.store.projected / total ]]%" cy="293" r="3"></circle>
                  <g transform="translate(-6)"><text x="[[= 100.0 * _.store.projected / total ]]%" y="260" class="label" text-anchor="end">Projected</text>
                    <text x="[[= 100.0 * _.store.projected / total ]]%" y="300" class="size" text-anchor="end">[[= bytes(_.store.projected) ]]</text>
                  </g>
                </g>
                [[}]]
              </svg>
            </div>
            [[# #################################### ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--stores-form"><!-- {{{ -->
      [[#
        {stores-form} template

        Renders a form for creating new storage endpoints, and
        editing existing stores.
      ]]
          <div class="gutter blk">
            [[ if (_.store) { ]]
            <a class="breadcrumb" href="#!/[[= _.admin ? 'admin/' : '' ]]stores/store:uuid:[[= _.store.uuid ]]">&laquo; Back to "[[= _.store.name ]]" Cloud Storage System</a>
            [[ } else { ]]
            <a class="breadcrumb" href="#!/[[= _.admin ? 'admin/' : '' ]]stores">&laquo; Back to Cloud Storage Systems</a>
            [[ } ]]
            <h2>[[ if (_.store) { ]]Edit[[ } else { ]]New[[ } ]] Storage System</h2>

            [[ if (!_.agents || _.agents.length == 0) { ]]
            <p class="notice failure">There are currently no Agents registered with
            this SHIELD Core; you will not be able to configure Storage Systems until
            that changes.</p>
            [[ } else { ]]
            <form>
              <div class="error"></div>

              <div class="ctl" data-field="name">
                <label for="store-name">Name</label>
                <span class="errors">
                  <span data-error="missing">You must provide a name for this new storage system.</span>
                </span>
                <div class="widget">
                  <input type="text" id="store-name" name="name" class="autofocus"
                    [[ if (_.store) { ]]value="[[= _.store.name ]]"[[ } ]]/>
                  <p class="help">Pick a memorable or descriptive name for this storage system,
                  so that other operators can determine when to use it.</p>
                </div>
              </div>

              <div class="ctl" data-field="summary">
                <label for="store-summary">Description</label>
                <div class="widget">
                  <textarea id="store-summary" name="summary">[[= _.store ? _.store.summary : '' ]]</textarea>
                  <p class="help">If you want, you can add a longer description.</p>
                </div>
              </div>

              <div class="ctl" data-field="threshold">
                <label for="store-threshold">Threshold</label>
                <span class="errors">
                  <span data-error="missing">You must provide a threshold for this new storage system.</span>
                </span>
                <div class="widget">
                  <input type="text" id="store-threshold" name="threshold"
                    [[ if (_.store) { ]]value="[[= bytes(_.store.threshold) ]]"[[ } ]]/>
                    <p class="help">Select a reasonable threshold for storage size warnings</p>
                </div>
              </div>

              <div class="ctl" data-field="agent">
                <label for="store-agent">Agent</label>
                <span class="errors">
                  <span data-error="missing">You must select which SHIELD Agent to use to access this storage system.</span>
                </span>
                <div class="widget">
                  <select id="store-agent" name="agent" value="[[= _.store ? _.store.agent : '' ]]">
                    <option></option>
                    [[ var found = false; ]]
                    [[ $.each(_.agents, function (i, agent) { ]]
                    [[   if (_.store && _.store.agent == agent.address) { ]]
                    <option selected value="[[= agent.uuid ]]|[[= agent.address ]]">[[= agent.name ]] (at [[= agent.address ]])</option>
                    [[   } else { ]]
                    <option value="[[= agent.uuid ]]|[[= agent.address ]]">[[= agent.name ]] (at [[= agent.address ]])</option>
                    [[   } ]]
                    [[ }); ]]
                  </select>
                </div>
              </div>

              <div id="choose-plugin"></div>
              <div id="configure-plugin"></div>

              <button class="go">[[ if (_.store) { ]]Save[[ } else { ]]Create[[ } ]]</button>
            </form>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--stores-form-choose-plugin"><!-- {{{ -->
      [[#
        {stores-form-choose-plugin} template

        Renders the plugin choice dropdown
      ]]
          <div class="ctl" data-field="plugin">
            <label for="store-plugin">Storage Plugin</label>
            <span class="errors">
              <span data-error="missing">You must select a storage plugin to use.</span>
            </span>
            <div class="widget">
              <select id="store-plugin" name="plugin">
                <option></option>
                [[
                    var plugins = [];
                    $.each(_.metadata.plugins, function (plugin, metadata) {
                      if (metadata.features.store == 'yes') {
                        plugins.push([plugin, metadata.name + " ("+plugin+")"])
                      }
                    });
                    plugins = plugins.sort(function (a, b) {
                      return a[1] > b[1] ?  1
                           : a[1] < b[1] ? -1 : 0;
                    });
                ]]
                [[ $.each(plugins, function (i, plugin) { ]]
                <option value="[[= plugin[0] ]]">[[= plugin[1] ]]</option>
                [[ }); ]]
              </select>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--stores-form-configure-plugin"><!-- {{{ -->
      [[#
        {stores-form-configure-plugin} template

        Renders the plugin / endpoint configuration sub-form
      ]][[

            var esc = function (s) { return s.replace(/`([^`]*)`/g, '<tt>$1</tt>'); }

          ]]
          <div class="subform">
            <h2>Storage Plugin Options</h2>
          [[ var n = 0; ]]
          [[ $.each(_.plugin.fields, function (i, field) { ]]
            [[ if (field.mode == 'target') { return; } ]]
              [[ n++; ]]
              <div class="ctl[[ if (field.required) { ]] required[[ } ]]" data-field="config.[[= field.name ]]" data-type="[[= field.type ]]">
                <label for="store-plugin-[[= field.name ]]">[[= esc(field.title) ]][[ if (field.required) { ]] <span>(required)</span>[[ } ]]</label>
                <span class="errors">
                  <span data-error="missing">You must provide a value for this plugin configuration.</span>
                  [[ if (field.type == "port") { ]]
                  <span data-error="invalid">Please supply a valid port number, between 1 and 65535 (inclusive).</span>
                  [[ } else if (field.type == "abspath") { ]]
                  <span data-error="invalid">Please supply an absolute filesystem path, starting with a forward slash.</span>
                  [[ } ]]
                </span>
                <div class="widget">
                  [[ if (field.type == 'bool') { ]]
                  <input type="checkbox" id="store-plugin-[[= field.name ]]" name="config.[[= field.name ]]" />
                  [[ } else if (field.type == 'enum') { ]]
                  <select id="store-plugin-[[= field.name ]]" name="config.[[= field.name ]]">
                    [[ if (!field.required || field.default) { ]]<option></option>[[ } ]]
                    [[ $.each(field.enum, function (i, value) { ]]
                    [[   if (_.config && _.config[field.name] == value) { ]]
                    <option selected value="[[= value ]]">[[= value ]]</option>
                    [[   } else { ]]
                    <option value="[[= value ]]">[[= value ]]</option>
                    [[   } ]]
                    [[ }); ]]
                  </select>
                  [[ } else if (field.type == 'password') { ]]
                  <!-- FIXME: this needs to be a smudge field -->
                  <input type="password" id="store-plugin-[[= field.name ]]" name="config.[[= field.name ]]"
                    [[ if (_.config && (field.name in _.config)) { ]]value="[[= _.config[field.name] ]]"[[ } ]]
                    [[ if (field.placeholder && field.placeholder != "") { ]]placeholder="[[= field.placeholder ]]"[[ } ]]/>
                  [[ } else { ]]
                  <input type="text" id="store-plugin-[[= field.name ]]" name="config.[[= field.name ]]"
                    [[ if (_.config && (field.name in _.config)) { ]]value="[[= _.config[field.name] ]]"[[ } ]]
                    [[ if (field.placeholder && field.placeholder != "") { ]]placeholder="[[= field.placeholder ]]"[[ } ]]/>
                  [[ } ]]
                  [[ if (field.help && field.help != '') { ]]
                  <p class="help">[[= esc(field.help) ]]</p>
                  [[ } ]]
                  [[ if (field.example && field.example != '') { ]]
                  <p class="example">For example: [[= esc(field.example) ]]</p>
                  [[ } ]]
                </div>
              </div>
          [[ }); ]]
          [[ if (n == 0) { ]]
          <div class="no-data">
            <p>This storage plugin is zero-conf, and should just work.</p>
          </div>
          [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--stores-delete"><!-- {{{ -->
      [[#
        {stores-delete}

        A modal interaction screen that requires the operator to acknowledge
        that what they are about to do will result in the destruction of
        configuration data.
      ]]
          <div class="confirm">
            <h2>Delete The <em>[[= _.store.name ]]</em> Cloud Storage System?</h2>

            <p>You have requested that S.H.I.E.L.D. remove the configuration for
            the cloud storage system "[[= _.store.name ]]".  <em>This is a
            irreversible action; it cannot be undone.</em></p>

            <p class="q">Are you sure you want to delete <em>[[= _.store.name ]]</em>?</p>
            <div class="a">
              <button class="danger" rel="yes">Yes, Delete It</button>
              <button class="safe" rel="close">No, Cancel This Operation</button>
            </div>
          </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--policies"><!-- {{{ -->
      [[#
        {policies} template

        Renders the list of all retention policies
      ]]
          <div class="gutter blk">
            [[ if ((_.admin  && $global.auth.is.system.engineer)
                || (!_.admin && $global.auth.is.tenant[$global.auth.tenant.uuid].engineer)) { ]]
            <a class="new" href="#!/[[= _.admin ? 'admin/' : '' ]]policies/new">Create a New Retention Policy [[= _.admin ? 'Template ' : '' ]]&raquo;</a>
            [[ } ]]
            [[ if (_.admin) { ]]
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <h2>Retention Policy <strong>Templates</strong></h2>
            <p class="notice">These are <strong>template</strong> definitions; they will be
            copied into new tenants as they are created.  Changes here will <strong>not</strong>
            take effect on pre-existing tenants.</p>
            [[ } else { ]]
            <h2>Retention Policies</h2>
            [[ } ]]
            [[ if (_.policies.length == 0) { ]]
            <div class="no-data">No Retention [[= _.admin ? 'Policy Templates' : 'Policies' ]] have been created yet.</div>
            [[ } else { ]]
            <table>
              <thead><tr>
                <th>Name</th>
                <th>Retention Period</th>
                <th></th>
                <th></th>
              </tr></thead>
              <tbody>
                [[ $.each(_.policies, function (i, policy) { ]]
                <tr>
                  <td>[[= policy.name ]]</td>
                  <td>[[= policy.days ]] day[[ if (policy.days != 1) { ]]s[[ } ]]</td>
                  <td><a href="#!/[[= _.admin ? 'admin/' : '']]policies/edit:uuid:[[= policy.uuid ]]">edit</a></td>
                  <td><a href="#!/[[= _.admin ? 'admin/' : '']]policies/delete:uuid:[[= policy.uuid ]]">delete</a></td>
                </tr>
                [[ }); ]]
              </tbody>
            </table>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--policies-form"><!-- {{{ -->
      [[#
        {policies-form} template

        Renders a form for creating new retention policies, and
        editing existing retention policies.
      ]]
          <div class="gutter blk">
            <a class="breadcrumb" href="#!/[[= _.admin ? 'admin/' : '' ]]policies">&laquo; Back to Retention [[= _.admin ? 'Policy Templates' : 'Policies' ]]</a>
            <h2>[[ if (_.policy) { ]]Edit[[ } else { ]]New[[ } ]] Retention Policy[[= _.admin ? ' Template' : '' ]]</h2>

            <form>
              <div class="error"></div>

              <div class="ctl" data-field="name">
                <label for="policy-name">Name</label>
                <span class="errors">
                  <span data-error="missing">You must provide a name for this new retention policy.</span>
                </span>
                <div class="widget">
                  <input type="text" id="policy-name" name="name" class="autofocus" tabindex="0"
                    [[ if (_.policy) { ]]value="[[= _.policy.name ]]"[[ } ]]/>
                  <p class="help">Pick a memorable or descriptive name for this retention policy,
                  so that other operators can determine what to use it for.</p>
                </div>
              </div>

              <div class="ctl" data-field="expires">
                <label for="policy-days">Expiry (in days)</label>
                <span class="errors">
                  <span data-error="missing">You must specify an expiry of at least 1 day.</span>
                  <span data-error="invalid">This must be a positive, non-zero, whole number.</span>
                </span>
                <div class="widget">
                  <input type="text" id="policy-days" name="days"
                    [[ if (_.policy) { ]]value="[[= _.policy.days ]]"[[ } ]]/>
                  <p class="help">How long should archives be kept, under this retention policy.
                  At a minimum, archives must be kept for one day.</p>
                </div>
              </div>

              <button class="go">[[ if (_.policy) { ]]Save[[ } else { ]]Create[[ } ]]</button>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--policies-delete"><!-- {{{ -->
      [[#
        {policies-delete}

        A modal interaction screen that requires the operator to acknowledge
        that what they are about to do will result in the destruction of
        configuration data.
      ]]
          <div class="confirm">
            <h2>Delete The <em>[[= _.policy.name ]]</em> Retention Policy[[= _.admin ? ' Template' : '' ]]?</h2>

            <p>You have requested that S.H.I.E.L.D. remove the configuration for
            the retention policy[[= _.admin ? ' template' : '' ]] "[[= _.policy.name ]]".</p>

            <p class="q">Are you sure you want to delete <em>[[= _.policy.name ]]</em>?</p>
            <div class="a">
              <button class="danger" rel="yes">Yes, Delete It</button>
              <button class="safe" rel="close">No, Cancel This Operation</button>
            </div>
          </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--tenants"><!-- {{{ -->
      [[#
        {tenants} template

        Renders the list of all tenants (for site managers)
      ]]
          <div class="gutter blk">
            <a class="new" href="#!/admin/tenants/new">Create a New Tenant &raquo;</a>
            <h2>Tenants</h2>
            [[ if (_.tenants.length == 0) { ]]
            <div class="no-data">No Tenants have been created yet.</div>
            [[ } else { ]]
            <table>
              <thead><tr>
                <th>Name</th>
                <th></th>
              </tr></thead>
              <tbody>
                [[ $.each(_.tenants, function (i, tenant) { ]]
                <tr>
                  <td>[[= tenant.name ]]</td>
                  <td><a href="#!/admin/tenants/edit:uuid:[[= tenant.uuid ]]">edit</a></td>
                </tr>
                [[ }); ]]
              </tbody>
            </table>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--tenants-form"><!-- {{{ -->
      [[#
        {tenants-form} template

        Renders a form for creating new tenants, and editing
        existing tenants.
      ]]
          <div class="gutter blk">
            <a class="breadcrumb" href="#!/admin/tenants">&laquo; Back to Tenants</a>
            <h2>[[ if (_.tenant) { ]]Edit[[ } else { ]]New[[ } ]] Tenant</h2>

            <form>
              <div class="error"></div>

              <div class="ctl" data-field="name">
                <label for="tenant-name">Name</label>
                <span class="errors">
                  <span data-error="missing">You must provide a name for this new tenant.</span>
                </span>
                <div class="widget">
                  <input type="text" id="tenant-name" name="name" class="autofocus"
                    [[ if (_.tenant) { ]]value="[[= _.tenant.name ]]"[[ } ]]/>
                  <p class="help">Pick a memorable or descriptive name for this tenant.</p>
                </div>
              </div>

              <div class="ctl">
                <label for="tenant-invite">People In This Tenant</label>
                <div class="widget">
                  <input type="text" name="invite" id="tenant-invite" autocomplete="off"
                         class="invite" placeholder="Invite people to join..." />

                  <table class="tenant-members">
                    <thead><tr>
                      <th></th>
                      <th>Display Name</th>
                      <th>Username</th>
                      <th>Role</th>
                    </tr></thead>
                    <tbody data-type="tenant">
                      [[ if (_.tenant) { ]]
                        [[ $.each(_.tenant.members, function (i, user) { ]]
                        <tr data-uuid="[[= user.uuid ]]" data-account="[[= user.account ]]">
                          <td><a href="banish:user"><img src="/i/delete.png"></a></td>
                          <td>[[= user.name ]]</td>
                          <td>[[= user.account ]]</td>
                          <td><span class="role" data-role="[[= user.role ]]">
                          [[= { admin      : "Administrator",
                                engineer   : "Engineer",
                                operator   : "Operator" }[user.role] ]]
                          </span></td>
                        </tr>
                        [[ }); ]]
                      [[ } ]]
                    </tbody>
                  </table>
                </div>
              </div>

              <button class="go">[[ if (_.tenant) { ]]Save[[ } else { ]]Create[[ } ]]</button>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--tenants-form-invitee"><!-- {{{ -->
      [[#
        {tenants-form-invitee} template

        Renders a table row in the invitee management UI control.
      ]]
                      <tr data-uuid="[[= _.user.uuid ]]" data-account="[[= _.user.account ]]">
                        <td><a href="banish:user"><img src="/i/delete.png"></a></td>
                        <td>[[= _.user.name ]]</td>
                        <td>[[= _.user.account ]]</td>
                        <td><span class="role" data-role="[[= _.user.role ]]">
                        [[= { admin      : "Administrator",
                              engineer   : "Engineer",
                              operator   : "Operator" }[_.user.role] ]]
                        </span></td>
                      </tr>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--userlookup-results"><!-- {{{ -->
      [[#
        {userlookup-results} template

        Displays the "dropdown" list of user information,
        after the /v2/ui/users endpoint has fired in a
        userlookup control.
      ]]
      <div class="userlookup-results">
        <ul>
          [[ $.each(_, function (i, user) { ]]
          <li data-idx="[[= i ]]" data-uuid="[[= user.uuid ]]"><strong>[[= user.name ]]</strong><p>[[= user.account ]]</p></li>
          [[ }); ]]
        </ul>
      </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--admin"><!-- {{{ -->
      [[#
        {admin} template

        Renders the administrator control panel.
      ]]
          <div class="gutter blk" id="admin-home">
            <h2>SHIELD Administration</h2>
            <ul>
              <li><a href="#!/admin/tenants">Tenants</a>
                <p>Tenants separate and isolate subsets of your users from one another, so that
                they can neither see nor affect the systems, storage, and retention policies
                of one another.</p>
              </li>

              <li><a href="#!/admin/stores">Global Storage Systems</a>
                <p>You may elect to configure some global storage systems, which can be used,
                but not modified, by all tenants; only SHIELD technicians, engineers, and
                admins are able to view and edit their configuration.</p>
              </li>

              <li><a href="#!/admin/policies">Retention Policy Templates</a>
                <p>You can define retention policy templates that will be copied into each
                new tenant as they are created.  This can be handy for getting people started
                quickly, and using your best practices for data retention.</p>
              </li>

              <li><a href="#!/admin/agents">Agents of SHIELD</a>
                <p>SHIELD performs backup and restore operations through <em>agents</em> that run
                on other machines.  These agents register with the SHIELD Core, and provide
                metadata that is essential to the configuration of your data protection jobs.</p>
              </li>
              <li><a href="#!/admin/auth">Authentication Providers</a>
                <p>SHIELD can authenticate (and authorize) users against 3rd party OAuth2
                implementations like Github and UAA.  These authentication <em>providers</em>
                are configured in the SHIELD Core configuration file, but you can review their
                configuration here.</p>
              </li>
              <li><a href="#!/admin/users">Local User Management</a>
                <p>Local SHIELD user accounts can be set up to provide access to your SHIELD if
                you do not want to use a 3rd party authentication provider.  Local users can be
                granted system roles and be given roles on tenants.</p>
              </li>
              <li><a href="#!/admin/rekey">Rekey SHIELD Core</a>
                <p>The SHIELD Core stores all of the archive encryption keys in a secure storage
                vault, which is protected by the SHIELD <em>master password</em>.  If you need or
                want to, you can rekey this SHIELD Core and pick a new master password.</p>
              </li>
            </ul>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--agents"><!-- {{{ -->
      [[#
        {agents} template

        Renders the list of registered agents, with information about each
        registered agent, its version, health, etc.
      ]]
          <div class="gutter blk">
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <h2>Agents of SHIELD</h2>
            [[ if (_.agents.length == 0) { ]]
            <div class="no-data">No Agents have registered with this S.H.I.E.L.D. instance yet.</div>
            [[ } else { ]]
            <table>
              <thead><tr>
                <th>Name</th>
                <th>Address</th>
                <th>Version</th>
                <th>Status</th>
                <th>Last Seen</th>
                <th>Visible?</th>
                <th></th>
              </tr></thead>
              <tbody>
                [[ $.each(_.agents, function (i, agent) { ]]
                    [[ var problems = _.problems[agent.uuid]; ]]
                <tr data-agent-uuid="[[= agent.uuid ]]"[[ if (problems.length != 0) { ]] class="noted fail"[[ } ]]>
                  <td class="k">[[= agent.name ]]</td>
                  <td>[[= agent.address ]]</td>
                  <td>[[= agent.version ]]</td>
                  <td>[[ if (agent.status == "ok") { ]]
                    <span class="ok">[[= agent.status ]]</span>
                  [[ } else { ]]
                    <span class="fail">[[= agent.status ]]</span>
                  [[ } ]]
                  </td>
                  <td>[[= trelative(agent.last_seen_at, 90*86400) ]]</td>
                  <td>[[ if (agent.hidden) { ]]no[[ } else { ]]yes[[ } ]]</td>
                  <td>[[ if (agent.hidden) { ]]<a href="#" rel="show">show</a>
                      [[ } else            { ]]<a href="#" rel="hide">hide</a>[[ } ]]</td>
                </tr>
                [[ if (problems.length != 0) { ]]
                <tr class="note fail">
                  <td colspan="7">
                    [[ $.each(problems, function (j, problem) { ]]
                    <strong>Note:</strong><div>[[= problem ]]</div>
                    [[ }); ]]
                  </td>
                </tr>
                [[ } ]]
                [[ }); ]]
              </tbody>
            </table>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--auth-providers"><!-- {{{ -->
      [[#
        {auth-providers} template

        Renders the list of configured authentication providers, including
        details about how to integrate with their respective 3rd party auth
        systems, i.e. Github OAuth2 App registration, CF/UAA client creation,
        etc.
      ]]
          <div class="gutter blk" id="auth-providers">
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <h2>Authentication Providers</h2>
            <table>
              <thead><tr>
                <th>Name</th>
                <th>Identifier</th>
                <th>Type</th>
                <th>Usage</th>
              </tr></thead>
              <tbody>
              [[ $.each(_.providers, function (i, provider) { ]]
                <tr>
                  <td>[[= provider.name ]]</td>
                  <td><span class="tag">[[= provider.identifier ]]</span></td>
                  <td>[[= provider.type ]] (<a href="#!/admin/auth/config:name:[[= provider.identifier ]]">configuration</a>)</td>
                  <td>[[= provider.usage ]]</td>
                </tr>
              [[ }); ]]
              </tbody>
            </table>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--auth-provider-config"><!-- {{{ -->
      [[#
        {auth-provider-config} template

        Renders the configuration of a single authentication provider,
        to help administrators set up the external endpoints, i.e. by
        showing the uaac commands to run to configure UAA, or the fields
        to fill out in the Github OAuth UI.
      ]]
          <div class="gutter blk" id="auth-provider">
            <a class="breadcrumb" href="#!/admin/auth">&laquo; Back to Authentication Providers</a>
            <h2>[[= _.provider.name ]] Authentication Provider ([[= _.provider.identifier ]])</h2>
            [[ var p = _.provider.properties; ]]
            [[ if (_.provider.type == 'github') { ]]
            <p>This is a <strong>Github</strong>-backed authentication provider, targeting
            [[ if (!p.github_endpoint || p.github_endpoint == "" || p.github_endpoint.match(/github\.com/)) { ]]
            public Github.
            [[ } else { ]]
            a private, on-premise Github Enterprise (<a href="[[= p.github_endpoint ]]">[[= p.github_endpoint ]]</a>).
            [[ } ]]</p>
            <h3>Configuring Github</h3>
            <p>First, you will need
            to <a href="https://github.com/settings/applications/new">register a new
            OAuth2 application</a> for this SHIELD:</p>

            <div class="github-auth-overlay-register">
              <span class="appname">SHIELD</span>
              <span class="homepage">[[= website() ]]</span>
              <span class="callback">[[= website() ]]auth/[[= _.provider.identifier ]]/redir</span>
            </div>

            <p>Once your application is registered, Github will provide you
            with a new Client ID and Client Secret:</p>

            <div class="github-auth-overlay-app">
              <span class="client-id"></span>
              <span class="client-secret"></span>
            </div>

            <p>These <strong>must</strong> match the values you configure
            in the SHIELD Core configuration YAML file.</p>

            [[ } else { ]]
            <p>This is a <strong>UAA</strong>-backed authentication provider.</p>

            <h3>Configuring Your UAA Client</h2>
            <p>In order for this authentication provider to function, you may need
            to add a new UAA client for this SHIELD.  The following commands should
            suffice:</p>

            <pre><code>$ uaac target <span class="hi">[[= p.uaa_endpoint ]]</span>
$ uaac token client get admin

$ uaac client add '<span class="hi">[[= p.client_id ]]</span>' \
                  --name S.H.I.E.L.D. \
                  --scope openid \
                  --authorities uaa.none \
                  --authorized_grant_types authorization_code \
                  --redirect_uri <span class="hi">[[= website() ]][[= _.provider.redirect ]]</span> \
                  --access_token_validity  180 \
                  --refresh_token_validity 180 \
                  --secret '<span class="hi">[[= p.client_secret ]]</span>'</code></pre>

            [[ } ]]
            <h3>Raw Configuration</h3>
            <pre><code>[[= JSON.stringify(_.provider, null, 2) ]]</code></pre>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--rekey"><!-- {{{ -->
      [[#
        {rekey} template

        Renders the list of configured authentication providers, including
        details about how to integrate with their respective 3rd party auth
        systems, i.e. Github OAuth2 App registration, CF/UAA client creation,
        etc.
      ]]
          <div class="gutter blk" id="rekey">
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <h2>Rekey Shield Master Password</h2>

            <form class="rekey">
              <div class="error"></div>

              <div class="ctl" data-field="current">
                <label for="rekey-current">Current Master Password</label>
                <span class="errors">
                  <span data-error="missing">You must supply the current SHIELD master password</span>
                </span>
                <div class="widget">
                  <input type="password" id="rekey-current" name="current"
                         class="autofocus">
                  <p class="help">In order to rekey this SHIELD core, you must specify your
                  current master password so that SHIELD can temporarily decrypt the secure
                  storage credentials.</p>
                </div>
              </div>

              <div class="ctl" data-field="new">
                <label for="rekey-new">New Master Password</label>
                <span class="errors">
                  <span data-error="missing">You must supply a new master password</span>
                </span>
                <div class="widget">
                  <input type="password" id="rekey-new" name="new">
                </div>
              </div>

              <div class="ctl" data-field="confirm">
                <label for="rekey-confirm">Confirm</label>
                <span class="errors">
                  <span data-error="missing">You must confirm your new master password</span>
                  <span data-error="mismatch">Your passwords do not match</span>
                </span>
                <div class="widget">
                  <input type="password" id="rekey-confirm" name="confirm">
                  <p class="help">Once your SHIELD is rekeyed, you will have to use the
                  <strong>new master password</strong> to unlock it.</p>
                </div>
              </div>

              <button class="go">Rekey</button>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--admin-users"><!-- {{{ -->
      [[#
        {admin-users} template

        Renders the list of local users, in the SHIELD database, allowing
        administrators to manage them, assigne them to tenants, etc.
      ]]
          <div class="gutter blk" id="admin-users">
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <a class="new" href="#!/admin/users/new">Create a New Local User &raquo;</a>
            <h2>Local User Management</h2>
            [[ if (_.users.length == 0) { ]]
            <div class="no-data">No local SHIELD users have been created yet.</div>
            [[ } else { ]]
            <table>
              <thead><tr>
                <th>Name</th>
                <th>Username</th>
                <th>System Role</th>
                <th>Tenants</th>
              </tr></thead>
              <tbody>
                [[ $.each(_.users, function (i, user) { ]]
                <tr>
                  <td><a href="#">[[= user.name ]]</a></td>
                  <td>[[= user.account ]]</td>
                  <td>[[ if (user.sysrole == "") { ]]<span class="none">none</span>[[ } else { ]][[= user.sysrole ]][[ } ]]</td>
                  <td>
                    [[ if ((user.tenants || []).length == 0) { ]]
                    <span class="none">none</span>
                    [[ } else { ]]
                    <ul>
                      [[ $.each(user.tenants || [], function (j, tenant) { ]]
                      <li><strong>[[= tenant.name ]]</strong> ([[= tenant.role ]])</li>
                      [[ }); ]]
                    </ul>
                    [[ } ]]
                  </td>
                </tr>
                [[ }); ]]
              </tbody>
            </table>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--admin-users-new"><!-- {{{ -->
      [[#
        {admin-users-new} template

        Renders a form that administrators can use to create new local
        SHIELD user accounts, specifying their passwords and system roles.
      ]]
          <div class="gutter blk" id="admin-users">
            <a class="breadcrumb" href="#!/admin/users">&laquo; Back to Local User Management</a>
            <h2>New SHIELD User</h2>
            <form>
              <div class="ctl" data-field="name">
                <label for="new-user-name">Display Name</label>
                <span class="errors">
                  <span data-error="missing">Please provide a display name.</span>
                </span>
                <div class="widget">
                  <input type="text" name="name" id="new-user-name">
                  <p class="help"></p>
                </div>
              </div>

              <div class="ctl" data-field="account">
                <label for="new-user-account">Username</label>
                <span class="errors">
                  <span data-error="missing">Please provide a username.</span>
                </span>
                <div class="widget">
                  <input type="text" name="account" id="new-user-account">
                </div>
              </div>

              <div class="ctl" data-field="password">
                <label for="new-user-password">Password</label>
                <span class="errors">
                  <span data-error="missing">Please provide a password for this new user.</span>
                </span>
                <div class="widget">
                  <input type="password" name="password" id="new-user-password">
                </div>
              </div>

              <div class="ctl" data-field="confirm">
                <label for="new-user-confirm">Confirm</label>
                <span class="errors">
                  <span data-error="missing">Please confirm this new user's password.</span>
                  <span data-error="mismatch">These passwords don't match.</span>
                </span>
                <div class="widget">
                  <input type="password" name="confirm" id="new-user-confirm">
                </div>
              </div>

              <div class="ctl" data-field="sysrole">
                <label for="new-user-sysrole">System Role</label>
                <div class="widget">
                  <select name="sysrole" id="new-user-sysrole">
                    <option value="">None</option>
                    <option value="engineer">Engineer</option>
                    <option value="manager">Manager</option>
                    <option value="admin">Administrator</option>
                  </select>
                </div>
              </div>

              <button class="go">Create</button>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--"><!-- {{{ -->
    <!-- }}} --></script>

    <!-- FIXME: colo jquery / lensjs with our assets -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="/init.js"></script>
    <script src="/js/lib.js"></script>
    <script src="/js/sticky-nav.js"></script>
    <script type="text/javascript">

    var referer = undefined;
    function divert(page) { // {{{
      if ($global.auth.unauthenticated) {
        if (page.match(/^#!\/(login|logout|cliauth)$/)) {
          return page;
        }
        console.log('session not authenticated; diverting to #!/login page...');
        return "#!/login";

      } else if ($global.auth.is.system.engineer && $global.hud) {
        /* process 'system' team diverts */
        if ($global.hud.health.core == "uninitialized") {
          console.log('system user detected, and this SHIELD core is uninitialized; diverting to #!/init page...');
          return "#!/init";

        } else if ($global.hud.health.core == "sealed" || $global.hud.health.core == "locked") {
          console.log('system user detected, and this SHIELD core is locked; diverting to #!/unlock page...');
          return "#!/unlock";
        }
      }
      if (!page || page == "") {
        return $global.auth.is.system.engineer ? '#!/admin' : '#!/systems';
      }

      return page;
    }
    // }}}

    function dispatch(page) {
      var argv = page.split(/[:+]/);
      dest = argv.shift();
      page = divert(dest);
      args = {};
      for (var i = 0; i < argv.length; i += 2) {
        args[argv[0+i]] = argv[1+i]
      }

      console.log('dispatching to %s (from %s)...', page, dest);

      var top = page.replace(/^(#!\/[^\/]+)(\/.*)?$/, '$1');
      $('nav li.current').removeClass('current');
      $('nav a[href="'+top+'"]').closest('li').addClass('current');

      switch (page) {

      case "#!/login": /* {{{ */
        (function () {
          var progress = function (how) {
            $('#viewport').find('#logging-in').remove();
            $('#viewport').append(template('logging-in', {auth: how}));
          }

          api({
            type: 'GET',
            url:  '/v2/auth/providers?for=web',
            success: function (data) {
              $('#viewport').html($(template('login', { providers: data })))
                .on("click", ".login", function (event) {
                  progress($(event.target).text());
                })
                .on("submit", "form", function (event) {
                  event.preventDefault()
                  progress('local SHIELD authentication');

                  var $form = $(event.target);
                  var data = $form.serializeObject();
                  $form.reset();

                  api({
                    type: "POST",
                    url:  "/v2/auth/login",
                    data: data,
                    success: function () {
                      /* this makes the chrome re-render unnecessary */
                      document.location.href = "/"
                    },
                    error: function (xhr) {
                      $(event.target).error(xhr.responseJSON);
                    },
                    complete: function () {
                      $('#viewport').find('#logging-in').remove();
                    }
                  });
                });
             },
            error: function (xhr) {
              $('#viewport').html(template('BOOM'));
            }
          })
        })();
        break; /* #!/login */
        // }}}
      case "#!/cliauth": /* {{{ */
        $('#viewport').html(template('cliauth', args));
        break; /* #!/cliauth */
        // }}}
      case "#!/logout": /* {{{ */
        (function () {
          api({
            type: "GET",
            url: "/v2/auth/logout",
            success: function () {
              document.location.href = '/';
            },
            error: function (xhr) {
              if (xhr.status >= 500) {
                $('#viewport').html(template('BOOM'));
              } else {
                document.location.href = '/';
              }
            }
          });
        })()
        break;
        // }}}

      case "#!/do/backup": /* {{{ */
        (function () {
          if (!$global.auth.tenant) {
            $('#main').html(template('you-have-no-tenants'));
            return;
          }
          $('#main').html(template('loading'));
          var data = {};

          api({
            type: 'GET',
            url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/systems',
            error: "Failed retrieving the list of protected systems from the SHIELD API.",
            success: function (systems) {
              data = { systems: systems };
              $('#main').html($(template('do-backup', data)))
                .on('click', "a[href^=\"do-backup:\"]", function (event) {
                  event.preventDefault();
                  l = $(event.target).closest('a[href^="do-backup:"]').attr('href').split(':');
                  if (l[1] == "unpick") {
                    var $card = $(event.target).closest('.card');
                    if ($card.is('.job'))    { data.system = data.store = data.policy = undefined; }
                    if ($card.is('.store'))  {               data.store = data.policy = undefined; }
                    if ($card.is('.policy')) {                            data.policy = undefined; }

                    data.noauto = true;
                    $('#main').html(template('do-backup', data));
                    data.noauto = false;
                    return;
                  }

                  if (l[1] == "pick" && l[2] == "target") {
                    for (var i = 0; i < data.systems.length; i++) {
                      if (data.systems[i].uuid == l[3]) {
                        data.system = data.systems[i];
                        break;
                      }
                    }
                    $('#main').html(template('do-backup', data));
                    return;
                  }

                  if (l[1] == "pick" && l[2] == "store") {
                    for (var i = 0; i < data.system.jobs.length; i++) {
                      if (data.system.jobs[i].store.uuid == l[3]) {
                        data.store = data.system.jobs[i].store;
                        break;
                      }
                    }
                    $('#main').html(template('do-backup', data));
                    return;
                  }

                  if (l[1] == "pick" && l[2] == "policy") {
                    for (var i = 0; i < data.system.jobs.length; i++) {
                      if (data.system.jobs[i].store.uuid == data.store.uuid
                      && data.system.jobs[i].retention.uuid == l[3]) {
                        data.policy = data.system.jobs[i].retention;
                        break;
                      }
                    }
                    $('#main').html(template('do-backup', data));
                    return;
                  }
                });
            }
          });
        })();
        break; /* #!/do/backup */
        // }}}

      case "#!/systems": /* {{{ */
        if (!$global.auth.tenant) {
          $('#main').html(template('you-have-no-tenants'));
          break;
        }
        $('#main').html(template('loading'));
        api({
          type: 'GET',
          url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/systems',
          error: "Failed retrieving the list of protected systems from the SHIELD API.",
          success: function (data) {
            $('#main').html(template('systems', { systems: data }));
          }
        });
        break; /* #!/systems */
        // }}}
      case '#!/systems/system': /* {{{ */
        if (!$global.auth.tenant) {
          $('#main').html(template('you-have-no-tenants'));
          break;
        }
        $('#main').html(template('loading'));
        api({
          type: 'GET',
          url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/systems/'+args.uuid,
          error: "Failed retrieving metadata for protected system from the SHIELD API.",
          success: function (data) {
            $('#main').html(template('system', { target: data }));
          }
        });
        break; /* #!/systems/system */
        // }}}

      case '#!/stores': /* {{{ */
        if (!$global.auth.tenant) {
          $('#main').html(template('you-have-no-tenants'));
          break;
        }
        $('#main').html(template('loading'));
        apis({
          multiplex: {
            local:  { type: 'GET', url: '/v2/tenants/'+$global.auth.tenant.uuid+'/stores' },
            global: { type: 'GET', url: '/v2/global/stores' }
          },
          error: "Failed retrieving the list of storage endpoints from the SHIELD API.",
          success: function (data) {
            /* FIXME fixups that need to migrate into the SHIELD code */
            for (key in data.local)  { if (!('ok' in data.local[key]))  { data.local[key].ok  = true; } }
            for (key in data.global) { if (!('ok' in data.global[key])) { data.global[key].ok = true; } }
            $('#main').html(template('stores', { stores: $.extend({}, data.local, data.global) }));
          }
        });
        break; /* #!/stores */
        // }}}
      case '#!/stores/store': /* {{{ */
        if (!$global.auth.tenant) {
          $('#main').html(template('you-have-no-tenants'));
          break;
        }
        $('#main').html(template('loading'));

        var go = function (data) {
          /* FIXME fixups that need to migrate into the SHIELD code */
          data.ok = true;
          data.archives = data.archive_count;
          data.used = data.storage_used;
          data.projected = 2.1;
          data.daily_delta = data.daily_increase;
          $('#main').html(template('store', { store: data }));
        };
        api({
          type: 'GET',
          url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/stores/'+args.uuid,
          success: go,
          error: function (xhr) {
            api({
              type: 'GET',
              url:  '/v2/global/stores/'+args.uuid,
              error: "Unable to retrieve storage systems from SHIELD API.",
              success: go
            });
          }
        });
        break; /* #!/stores/store */
        // }}}
      case '#!/stores/new': /* {{{ */
        if (!$global.auth.tenant) {
          $('#main').html(template('you-have-no-tenants'));
          break;
        }
        if (!$global.auth.is.tenant[$global.auth.tenant.uuid].engineer) {
          $('#main').html(template('access-denied', { level: 'tenant', need: 'engineer' }));
          break;
        }
        $('#main').html(template('loading'));
        api({
          type: 'GET',
          url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/agents',
          error: "Unable to retrieve list of SHIELD Agents from the SHIELD API",
          success: function (data) {
            var cache = {};

            $('#main').html($(template('stores-form', {
                store:  null,
                agents: data,
              }))
              .autofocus()
              .on('change', 'select#store-agent', function (event) {
                var uuid = $(event.target).val().replace(/\|.*/, '');
                if (uuid == "") { return; }

                $('#main #choose-plugin').html(template('loading'));
                api({
                  type: 'GET',
                  url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/agents/'+uuid,
                  success: function (data) {
                    cache = data;
                    $('#main #choose-plugin').html(template('stores-form-choose-plugin', data));
                  }
                });
              })
              .on('change', 'select#store-plugin', function (event) {
                var plugin = $(event.target).val();
                if (plugin == '') { return; }

                $('#main #configure-plugin').html(
                  template('stores-form-configure-plugin', {
                    plugin: cache.metadata.plugins[plugin]
                  }));
              })
              .on('submit', 'form', function (event) {
                event.preventDefault();

                var $form = $(event.target);
                var data = $form.serializeObject();
                data.agent = data.agent.replace(/.*\|/, '');
                data.threshold = readableToBytes(data.threshold);

                if (!$form.reset().validate(data).isOK()) { return; }
                api({
                  type: 'POST',
                  url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/stores',
                  data: data,
                  success: function () {
                    goto("#!/stores");
                  },
                  error: function (xhr) {
                    $form.error(xhr.responseJSON);
                  }
                });
              }));
          }
        });
        break; /* #!/stores */
        // }}}
      case '#!/stores/edit': /* {{{ */
        if (!$global.auth.tenant) {
          $('#main').html(template('you-have-no-tenants'));
          break;
        }
        if (!$global.auth.is.tenant[$global.auth.tenant.uuid].engineer) {
          $('#main').html(template('access-denied', { level: 'tenant', need: 'engineer' }));
          break;
        }
        api({
          type: 'GET',
          url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/stores/'+args.uuid,
          error: "Failed to retrieve storage system information from the SHIELD API.",
          success: function (store) {
            api({
              type: 'GET',
              url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/agents',
              error: "Unable to retrieve list of SHIELD Agents from the SHIELD API",
              success: function (agents) {

                $('#main').html($(template('stores-form', { store: store, agents: agents.agents }))
                  .autofocus()
                  .on('change', 'select#store-agent', function (event) {
                    var uuid = $(event.target).val().replace(/\|.*/, '');
                    if (uuid == "") { return; }

                    $('#main #choose-plugin').html(template('loading'));
                    api({
                      type: 'GET',
                      url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/agents/'+uuid,
                      success: function (data) {
                        cache = data;
                        $('#main #choose-plugin').html(template('stores-form-choose-plugin', data));
                        $('#main select[name="plugin"]').val(store.plugin).trigger('change');
                      }
                    });
                  })
                  .on('change', 'select#store-plugin', function (event) {
                    var plugin = $(event.target).val();
                    if (plugin == '') { return; }

                    $('#main #configure-plugin').html(
                      template('stores-form-configure-plugin', {
                        config: store.config,
                        plugin: cache.metadata.plugins[plugin]
                      }));
                  })
                  .on('submit', 'form', function (event) {
                    event.preventDefault();

                    var $form = $(event.target);
                    var data = $form.serializeObject();
                    data.agent = data.agent.replace(/.*\|/, '');
                    data.threshold = readableToBytes(data.threshold);

                    if (!$form.reset().validate(data).isOK()) { return; }
                    api({
                      type: 'PUT',
                      url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/stores/'+args.uuid,
                      data: data,
                      success: function () {
                        goto("#!/stores/store:uuid:"+args.uuid);
                      },
                      error: function (xhr) {
                        $form.error(xhr.responseJSON);
                      }
                    });
                  }));
                $('#main select[name="agent"]').trigger('change');
              }
            });
          }
        });

        break; /* #!/stores/edit */
        // }}}
      case '#!/stores/delete': /* {{{ */
        if (!$global.auth.tenant) {
          $('#main').html(template('you-have-no-tenants'));
          break;
        }
        if (!$global.auth.is.tenant[$global.auth.tenant.uuid].engineer) {
          $('#main').html(template('access-denied', { level: 'tenant', need: 'engineer' }));
          break;
        }
        api({
          type: 'GET',
          url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/stores/'+args.uuid,
          error: "Failed to retrieve storage system information from the SHIELD API.",
          success: function (store) {
            modal($(template('stores-delete', { store: store }))
              .on('click', '[rel="yes"]', function (event) {
                event.preventDefault();
                api({
                  type: 'DELETE',
                  url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/stores/'+args.uuid,
                  error: "Unable to delete storage system",
                  complete: function () {
                    modal(true);
                  },
                  success: function (event) {
                    goto('#!/stores');
                  }
                });
              })
              .on('click', '[rel="close"]', function (event) {
                modal(true);
                goto('#!/stores/store:uuid:'+args.uuid);
              })
            );
          }
        });

        break; /* #!/stores/delete */
        // }}}

      case '#!/policies': /* {{{ */
        if (!$global.auth.tenant) {
          $('#main').html(template('you-have-no-tenants'));
          break;
        }
        $('#main').html(template('loading'));
        api({
          type: 'GET',
          url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/policies',
          error: 'Failed to retrieve retention policy information from the SHIELD API.',
          success: function (data) {
            /* FIXME: data fixups that should probably migrate back to API */
            for (var i = 0; i < data.length; i++) {
              /* convert seconds -> days */
              data[i].days = data[i].expires / 86400;
            }

            $('#main').html(template('policies', { policies: data }));
          }
        });
        break; /* #!/policies */
        // }}}
      case '#!/policies/new': /* {{{ */
        if (!$global.auth.tenant) {
          $('#main').html(template('you-have-no-tenants'));
          break;
        }
        if (!$global.auth.is.tenant[$global.auth.tenant.uuid].engineer) {
          $('#main').html(template('access-denied', { level: 'tenant', need: 'engineer' }));
          break;
        }
        $('#main').html($(template('policies-form', { policy: null }))
          .autofocus()
          .on('submit', 'form', function (event) {
            event.preventDefault();

            var $form = $(event.target);
            var data = $form.serializeObject();

            $form.reset();
            if (!parseInt(data.days) || parseInt(data.days) < 1) {
              $form.error('expires', 'invalid');
            }
            if (!$form.isOK()) {
              return;
            }

            data.expires = data.days * 86400; /* FIXME fixup for API */
            delete data.days;

            api({
              type: 'POST',
              url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/policies',
              data: data,
              success: function () {
                goto("#!/policies");
              },
              error: function (xhr) {
                $form.error(xhr.responseJSON);
              }
            });
          }));

        break; /* #!/policies/new */
        // }}}
      case '#!/policies/edit': /* {{{ */
        if (!$global.auth.tenant) {
          $('#main').html(template('you-have-no-tenants'));
          break;
        }
        if (!$global.auth.is.tenant[$global.auth.tenant.uuid].engineer) {
          $('#main').html(template('access-denied', { level: 'tenant', need: 'engineer' }));
          break;
        }
        api({
          type: 'GET',
          url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/policies/'+args.uuid,
          error: "Failed to retrieve retention policy information from the SHIELD API.",
          success: function (data) {
            data.days = parseInt(data.expires / 86400); /* FIXME fix this in API */
            $('#main').html($(template('policies-form', { policy: data }))
              .autofocus()
              .on('submit', 'form', function (event) {
                event.preventDefault();

                var $form = $(event.target);
                var data = $form.serializeObject();

                $form.reset();
                if (!parseInt(data.days) || parseInt(data.days) < 0) {
                  $form.error('expires', 'invalid');
                }
                if (!$form.isOK()) {
                  return;
                }

                data.expires = data.days * 86400; /* FIXME fixup for API */
                delete data.days;

                api({
                  type: 'PUT',
                  url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/policies/'+args.uuid,
                  data: data,
                  success: function () {
                    goto("#!/policies");
                  },
                  error: function (xhr) {
                    $form.error(xhr.responseJSON);
                  }
                });
              }));
          }
        });

        break; /* #!/policies/edit */
        // }}}
      case '#!/policies/delete': /* {{{ */
        if (!$global.auth.tenant) {
          $('#main').html(template('you-have-no-tenants'));
          break;
        }
        if (!$global.auth.is.tenant[$global.auth.tenant.uuid].engineer) {
          $('#main').html(template('access-denied', { level: 'tenant', need: 'engineer' }));
          break;
        }
        api({
          type: 'GET',
          url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/policies/'+args.uuid,
          error: "Failed to retrieve retention policy information from the SHIELD API.",
          success: function (data) {
            modal($(template('policies-delete', { policy: data }))
              .on('click', '[rel="yes"]', function (event) {
                event.preventDefault();
                api({
                  type: 'DELETE',
                  url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/policies/'+args.uuid,
                  error: "Unable to delete retention policy",
                  complete: function () {
                    modal(true);
                  },
                  success: function (event) {
                    goto('#!/policies');
                  }
                });
              })
              .on('click', '[rel="close"]', function (event) {
                modal(true);
                goto('#!/policies');
              })
            );
          }
        });

        break; /* #!/admin/policies/delete */
        // }}}

      case '#!/admin': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html(template('admin'));
        break; /* #!/admin */
        // }}}
      case '#!/admin/agents': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html(template('loading'));
        api({
          type: 'GET',
          url:  '/v2/agents',
          error: "Failed retrieving the list of agents from the SHIELD API.",
          success: function (data) {
            $('#main').html($(template('agents', data))
              .on('click', 'a[rel]', function (event) {
                var action = $(event.target).closest('a[rel]').attr('rel');
                if (action == 'hide' || action == 'show') {
                  event.preventDefault();
                  api({
                    type: 'POST',
                    url:  '/v2/agents/'+$(event.target).extract('agent-uuid')+'/'+action,
                    error: "Unable to "+action+" agent via the SHIELD API.",
                    success: function () { reload(); }
                  });
                }
              }));
          }
        });
        break; /* #!/admin/agents */
        // }}}
      case '#!/admin/auth': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html(template('loading'));
        api({
          type: 'GET',
          url:  '/v2/auth/providers',
          error: "Failed retrieving the list of configured authentication providers from the SHIELD API.",
          success: function (data) {
            $('#main').html(template('auth-providers', { providers: data }));
          }
        });
        break; /* #!/admin/auth */
        // }}}
      case '#!/admin/auth/config': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html(template('loading'));
        api({
          type: 'GET',
          url:  '/v2/auth/providers/'+args.name,
          error: "Failed retrieving the authentication provider configuration from the SHIELD API.",
          success: function (data) {
            $('#main').html(template('auth-provider-config', { provider: data }));
          }
        });
        break; /* #!/admin/auth */
        // }}}
      case '#!/admin/rekey': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html($(template('rekey')))
          .autofocus()
          .on('submit', 'form', function (event) {
            event.preventDefault();

            var $form = $(event.target);
            var data = $form.serializeObject();

            $form.reset();
            if (data.current == "") {
              $form.error('current', 'missing');
            }

            if (data.new == "") {
              $form.error('new', 'missing');

            } else if (data.confirm == "") {
              $form.error('confirm', 'missing');

            } else if (data.new != data.confirm) {
              $form.error('confirm', 'mismatch');
            }

            if (!$form.isOK()) {
              return;
            }

            delete data.confirm;
            api({
              type: 'POST',
              url:  '/v2/rekey',
              data: data,
              success: function () {
                banner('Succcessfully rekeyed the SHIELD Core.');
                goto("#!/admin");
              },
              error: function (xhr) {
                $form.error(xhr.responseJSON);
              }
            });
          });

        break; /* #!/admin/rekey */
        // }}}

      case '#!/admin/tenants': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html(template('loading'));
        api({
          type: 'GET',
          url:  '/v2/tenants',
          error: 'Failed to retrieve tenant information from the SHIELD API.',
          success: function (data) {
            $('#main').html(template('tenants', { tenants: data }));
          }
        });
        break; /* #!/admin/tenants */
        // }}}
      case '#!/admin/tenants/new': /* {{{ */
        if (!$global.auth.is.system.manager) {
          $('#main').html(template('access-denied', { level: 'system', need: 'manager' }));
          break;
        }
        var members = {};

        $('#main').html($(template('tenants-form', { policy: null }))
          .userlookup('input[name=invite]', {
            // {{{
            filter: function (users) {
              var lst = [];
              $.each(users, function (i, user) {
                if (!(user.uuid in members)) {
                  lst.push(user);
                }
              });
              return lst;
            },
            onclick: function (user) {
              user.role = 'operator';
              $('#main table tbody').append(template('tenants-form-invitee', { user: user }));
              members[user.uuid] = user.role;
            }
            // }}}
          })
          .roles('.role', function (e, role) {
            members[e.extract('uuid')] = role;
          })
          .autofocus()
          .on('click', 'a[href="banish:user"]', function (event) {
            // {{{
            event.preventDefault();
            delete members[$(event.target).extract('uuid')];
            $(event.target).closest('tr').remove();
            // }}}
          })
          .on('submit', 'form', function (event) {
            // {{{
            event.preventDefault();

            var $form = $(event.target);
            var data = $form.serializeObject();
            data.users = [];
            for (uuid in members) {
              data.users.push({
                uuid: uuid,
                role: members[uuid]
              });
            }

            $form.reset();

            api({
              type: 'POST',
              url:  '/v2/tenants',
              data: data,
              success: function () {
                goto("#!/admin/tenants");
              },
              error: function (xhr) {
                $form.error(xhr.responseJSON);
              }
            });
            // }}}
          }));

        break; /* #!/admin/tenants/new */
        // }}}
      case '#!/admin/tenants/edit': /* {{{ */
        if (!$global.auth.is.system.manager) {
          $('#main').html(template('access-denied', { level: 'system', need: 'manager' }));
          break;
        }
        api({
          type: 'GET',
          url:  '/v2/tenants/'+args.uuid,
          error: "Failed to retrieve tenant information from the SHIELD API.",
          success: function (data) {
            var members = {};
            $.each(data.members, function (i, user) {
              members[user.uuid] = user;
            });
            $('#main').html($(template('tenants-form', { tenant: data }))
              .userlookup('input[name=invite]', {
                filter: function (users) {
                  var lst = [];
                  $.each(users, function (i, user) {
                    if (!(user.uuid in members)) {
                      lst.push(user);
                    }
                  });
                  return lst;
                },
                onclick: function (user) {
                  user.role = 'operator';
                  $('#main table tbody').append(template('tenants-form-invitee', { user: user }));
                  members[user.uuid] = user;

                  api({
                    type: 'POST',
                    url:  '/v2/tenants/'+args.uuid+'/invite',
                    data: {users:[user]},
                    error: "Unable to save tenant role assignment.",
                    success: function () {
                      banner('User "'+user.account+'" is now '+{
                          admin    : 'an administrator',
                          engineer : 'an engineer',
                          operator : 'an operator'
                        }[user.role]+' on this tenant.');
                    }
                  });
                }
              })
              .roles('.role', function (e, role) {
                var data = {
                  uuid    : e.extract('uuid'),
                  account : e.extract('account'),
                  role    : e.extract('role')
                };
                api({
                  type: 'POST',
                  url:  '/v2/tenants/'+args.uuid+'/invite',
                  data: {users:[data]},
                  error: "Unable to save tenant role assignment.",
                  success: function () {
                    banner('User "'+data.account+'" is now '+{
                        admin    : 'an administrator',
                        engineer : 'an engineer',
                        operator : 'an operator'
                      }[data.role]+' on this tenant.');
                  }
                });
              })
              .autofocus()
              .on('click', 'a[href="banish:user"]', function (event) {
                event.preventDefault();

                var e = $(event.target);
                var data = {
                  uuid    : e.extract('uuid'),
                  account : e.extract('account')
                };
                delete members[data.uuid];
                api({
                  type: 'POST',
                  url:  '/v2/tenants/'+args.uuid+'/banish',
                  data: {users:[data]},
                  error: "Unable to save tenant role assignment.",
                  success: function () {
                    banner('User "'+data.account+'" is no longer associated with this tenant.');
                  }
                })
                $(event.target).closest('tr').remove();
              })
              .on('submit', 'form', function (event) {
                event.preventDefault();

                var $form = $(event.target);
                var data = $form.serializeObject();

                $form.reset();

                api({
                  type: 'PATCH',
                  url:  '/v2/tenants/'+args.uuid,
                  data: data,
                  success: function () {
                    goto("#!/admin/tenants");
                  },
                  error: function (xhr) {
                    $form.error(xhr.responseJSON);
                  }
                });
              }));
          }
        });

        break; /* #!/admin/tenants/edit */
        // }}}

      case '#!/admin/users': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        api({
          type: 'GET',
          url:  '/v2/auth/local/users',
          error: "Failed retrieving the list of local SHIELD users from the SHIELD API.",
          success: function (data) {
            $('#main').html(template('admin-users', { users: data }));
          }
        });
        break; /* #!/admin/users */
        // }}}
      case "#!/admin/users/new": /* {{{ */
        if (!$global.auth.is.system.manager) {
          $('#main').html(template('access-denied', { level: 'system', need: 'manager' }));
          break;
        }
        $('#main').html($(template('admin-users-new', {})))
          .autofocus()
          .on('submit', 'form', function (event) {
            event.preventDefault();
            var $form = $(event.target);

            var payload = {
              name:     $form.find('[name=name]').val(),
              account:  $form.find('[name=account]').val(),
              password: $form.find('[name=password]').val()
            };

            if ($form.find('[name=confirm]').val() != payload.password) {
              banner("Passwords don't match", "error");
              return;
            }

            banner("Creating new user...", "info");
            api({
              type: 'POST',
              url:  '/v2/auth/local/users',
              data: payload,
              success: function (data) {
                banner('New user created successfully.');
                goto("#!/admin/users");
              },
              error: function (xhr) {
                banner("Failed to create new user", "error");
              }
            });
          });
        break; // #!/admin/users/new
        // }}}

      case '#!/admin/stores': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html(template('loading'));
        api({
          type: 'GET',
          url:  '/v2/global/stores',
          error: "Failed retrieving the list of storage endpoints from the SHIELD API.",
          success: function (data) {
            /* FIXME fixups that need to migrate into the SHIELD code */
            for (key in data) {
              if (!('ok' in data[key])) {
                data[key].ok = true;
              }
            }
            $('#main').html(template('stores', { stores: data, admin: true }));
          }
        });
        break; /* #!/admin/stores */
        // }}}
      case '#!/admin/stores/store': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html(template('loading'));
        api({
          type: 'GET',
          url:  '/v2/global/stores/'+args.uuid,
          error: "Unable to retrieve storage systems from SHIELD API.",
          success: function (data) {
            /* FIXME fixups that need to migrate into the SHIELD code */
            data.ok = true;
            data.archives = data.archive_count;
            data.used = data.storage_used;
            data.threshold = data.threshold;
            data.projected = 2.1;
            data.daily_delta = data.daily_increase;
            $('#main').html(template('store', { store: data, admin: true }));
          }
        });
        break; /* #!/admin/stores/store */
        // }}}
      case '#!/admin/stores/new': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html(template('loading'));
        api({
          type: 'GET',
          url:  '/v2/agents',
          error: "Unable to retrieve list of SHIELD Agents from the SHIELD API",
          success: function (data) {
            var cache = {};

            $('#main').html($(template('stores-form', {
                store:  null,
                agents: data.agents,
                admin:  true,
              }))
              .autofocus()
              .on('change', 'select#store-agent', function (event) {
                var uuid = $(event.target).val().replace(/\|.*/, '');
                if (uuid == "") { return; }

                $('#main #choose-plugin').html(template('loading'));
                api({
                  type: 'GET',
                  url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/agents/'+uuid,
                  success: function (data) {
                    cache = data;
                    $('#main #choose-plugin').html(template('stores-form-choose-plugin', data));
                  }
                });
              })
              .on('change', 'select#store-plugin', function (event) {
                var plugin = $(event.target).val();
                if (plugin == '') { return; }

                $('#main #configure-plugin').html(
                  template('stores-form-configure-plugin', {
                    plugin: cache.metadata.plugins[plugin]
                  }));
              })
              .on('submit', 'form', function (event) {
                event.preventDefault();

                var $form = $(event.target);
                var data = $form.serializeObject();
                data.agent = data.agent.replace(/.*\|/, '');
                data.threshold = readableToBytes(data.threshold);

                if (!$form.reset().validate(data).isOK()) { return; }
                api({
                  type: 'POST',
                  url:  '/v2/global/stores',
                  data: data,
                  success: function () {
                    goto("#!/admin/stores");
                  },
                  error: function (xhr) {
                    $form.error(xhr.responseJSON);
                  }
                });
              }));
          }
        });
        break; /* #!/admin/stores */
        // }}}
      case '#!/admin/stores/edit': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        api({
          type: 'GET',
          url:  '/v2/global/stores/'+args.uuid,
          error: "Failed to retrieve storage system information from the SHIELD API.",
          success: function (store) {
            api({
              type: 'GET',
              url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/agents',
              error: "Unable to retrieve list of SHIELD Agents from the SHIELD API",
              success: function (agents) {

                $('#main').html($(template('stores-form', {
                  store:  store,
                  agents: agents.agents,
                  admin:  true
                }))
                  .autofocus()
                  .on('change', 'select#store-agent', function (event) {
                    var uuid = $(event.target).val().replace(/\|.*/, '');
                    if (uuid == "") { return; }

                    $('#main #choose-plugin').html(template('loading'));
                    api({
                      type: 'GET',
                      url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/agents/'+uuid,
                      success: function (data) {
                        cache = data;
                        $('#main #choose-plugin').html(template('stores-form-choose-plugin', data));
                        $('#main select[name="plugin"]').val(store.plugin).trigger('change');
                      }
                    });
                  })
                  .on('change', 'select#store-plugin', function (event) {
                    var plugin = $(event.target).val();
                    if (plugin == '') { return; }

                    $('#main #configure-plugin').html(
                      template('stores-form-configure-plugin', {
                        config: store.config,
                        plugin: cache.metadata.plugins[plugin]
                      }));
                  })
                  .on('submit', 'form', function (event) {
                    event.preventDefault();

                    var $form = $(event.target);
                    var data = $form.serializeObject();
                    data.agent = data.agent.replace(/.*\|/, '');
                    data.threshold = readableToBytes(data.threshold);

                    if (!$form.reset().validate(data).isOK()) { return; }
                    api({
                      type: 'PUT',
                      url:  '/v2/global/stores/'+args.uuid,
                      data: data,
                      success: function () {
                        goto("#!/admin/stores/store:uuid:"+args.uuid);
                      },
                      error: function (xhr) {
                        $form.error(xhr.responseJSON);
                      }
                    });
                  }));
                $('#main select[name="agent"]').trigger('change');
              }
            });
          }
        });

        break; /* #!/admin/stores/edit */
        // }}}
      case '#!/admin/stores/delete': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        api({
          type: 'GET',
          url:  '/v2/global/stores/'+args.uuid,
          error: "Failed to retrieve storage system information from the SHIELD API.",
          success: function (store) {
            modal($(template('stores-delete', { store: store }))
              .on('click', '[rel="yes"]', function (event) {
                event.preventDefault();
                api({
                  type: 'DELETE',
                  url:  '/v2/global/stores/'+args.uuid,
                  error: "Unable to delete storage system",
                  complete: function () {
                    modal(true);
                  },
                  success: function (event) {
                    goto('#!/admin/stores');
                  }
                });
              })
              .on('click', '[rel="close"]', function (event) {
                modal(true);
                goto('#!/admin/stores/store:uuid:'+args.uuid);
              })
            );
          }
        });

        break; /* #!/admin/stores/delete */
        // }}}

      case '#!/admin/policies': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html(template('loading'));
        api({
          type: 'GET',
          url:  '/v2/global/policies',
          error: "Failed retrieving the list of retention policy templates from the SHIELD API.",
          success: function (data) {
            /* FIXME: data fixups that should probably migrate back to API */
            for (var i = 0; i < data.length; i++) {
              /* convert seconds -> days */
              data[i].days = data[i].expires / 86400;
            }

            $('#main').html(template('policies', { policies: data, admin: true }));
          }
        });
        break; /* #!/admin/policies */
        // }}}
      case '#!/admin/policies/new': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html($(template('policies-form', { policy: null, admin: true }))
          .autofocus()
          .on('submit', 'form', function (event) {
            event.preventDefault();

            var $form = $(event.target);
            var data = $form.serializeObject();

            $form.reset();
            if (!parseInt(data.days) || parseInt(data.days) < 1) {
              $form.error('expires', 'invalid');
            }
            if (!$form.isOK()) {
              return;
            }

            data.expires = data.days * 86400; /* FIXME fixup for API */
            delete data.days;

            api({
              type: 'POST',
              url:  '/v2/global/policies',
              data: data,
              success: function () {
                goto("#!/admin/policies");
              },
              error: function (xhr) {
                $form.error(xhr.responseJSON);
              }
            });
          }));
        break; /* #!/admin/policies/new */
        // }}}
      case '#!/admin/policies/edit': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        api({
          type: 'GET',
          url:  '/v2/global/policies/'+args.uuid,
          error: "Failed to retrieve retention policy template information from the SHIELD API.",
          success: function (data) {
            data.days = parseInt(data.expires / 86400); /* FIXME fix this in API */
            $('#main').html($(template('policies-form', { policy: data, admin: true }))
              .autofocus()
              .on('submit', 'form', function (event) {
                event.preventDefault();

                var $form = $(event.target);
                var data = $form.serializeObject();

                $form.reset();
                if (!parseInt(data.days) || parseInt(data.days) < 1) {
                  $form.error('expires', 'invalid');
                }
                if (!$form.isOK()) {
                  return;
                }

                data.expires = data.days * 86400; /* FIXME fixup for API */
                delete data.days;

                api({
                  type: 'PUT',
                  url:  '/v2/global/policies/'+args.uuid,
                  data: data,
                  success: function () {
                    goto("#!/admin/policies");
                  },
                  error: function (xhr) {
                    $form.error(xhr.responseJSON);
                  }
                });
              }));
            }
          });
          break; /* #!/admin/policies/edit */
        // }}}
      case '#!/admin/policies/delete': /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        api({
          type: 'GET',
          url:  '/v2/global/policies/'+args.uuid,
          error: "Failed to retrieve retention policy template information from the SHIELD API.",
          success: function (data) {
            modal($(template('policies-delete', { policy: data, admin: true }))
              .on('click', '[rel="yes"]', function (event) {
                event.preventDefault();
                api({
                  type: 'DELETE',
                  url:  '/v2/global/policies/'+args.uuid,
                  error: "Unable to delete retention policy template",
                  complete: function () {
                    modal(true);
                  },
                  success: function (event) {
                    goto('#!/admin/policies');
                  }
                });
              })
              .on('click', '[rel="close"]', function (event) {
                modal(true);
                goto('#!/admin/policies');
              })
            );
          }
        });

        break; /* #!/admin/policies/delete */
        // }}}

      case "#!/unlock": /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html($(template('unlock', {})))
          .autofocus()
          .on('submit', 'form', function (event) {
            event.preventDefault();

            var data = $(event.target).serializeObject();

            api({
              type: 'POST',
              url:  '/v2/unlock',
              data: data,
              error: "Unable to unlock the SHIELD Core.",
              success: function (data) {
                $global.hud.health.core = "unlocked";
                $('#hud').html(template('hud', $global.hud));
                goto("");
              }
            });
          });
        break;
        // }}}
      case "#!/init": /* {{{ */
        if (!$global.auth.is.system.engineer) {
          $('#main').html(template('access-denied', { level: 'system', need: 'engineer' }));
          break;
        }
        $('#main').html($(template('init', {})))
          .autofocus()
          .on('submit', 'form', function (event) {
            event.preventDefault();

            var $form = $(event.target);
            var data = $form.serializeObject();

            $form.reset();
            if (data.master == "") {
              $form.error('master', 'missing');

            } else if (data.confirm == "") {
              $form.error('confirm', 'missing');

            } else if (data.master != data.confirm) {
              $form.error('confirm', 'mismatch');
            }

            if (!$form.isOK()) {
              return;
            }

            api({
              type: 'POST',
              url:  '/v2/init',
              data: { "master_password": data.master },
              success: function (data) {
                $global.hud.health.core = "unlocked";
                $('#hud').html(template('hud', $global.hud));
                goto("");
              },
              error: function (xhr) {
                $form.error(xhr.responseJSON);
              }
            });
          });
        break;
        // }}}

      default: /* 404 {{{ */
        $('#main').html(template('404', {
          wanted:  page,
          args:    argv,
          referer: referer,
        }));
        return; /* 404 */
        // }}}
      }
      referer = page;
    }

    function redraw() {
      $('#hud').html(template('hud', $global.hud));
      $('.top-bar').html(template('top-bar', {
        shield:  $global.hud.shield,
        user:    $global.auth.user,
        tenants: $global.auth.tenants,
        tenant:  $global.auth.tenant
      }));
    }
    function goto(page) {
      if (document.location.hash == page) {
        dispatch(page); // re-dispatch
      } else {
        document.location.hash = page;
      }
    }
    function reload() {
      goto(document.location.hash)
    }

    $(function () {
      if (!$global.auth.unauthenticated) {
        $('#viewport').html(template('layout'));
      }

      /* ... watch the document hash for changes {{{ */
      $(window).on('hashchange', function (event) {
        dispatch(document.location.hash);
      }).trigger('hashchange');
      /* }}} */
      /* ... ping /v2/health every X seconds, and update the HUD {{{ */
      (function (s) {
        var last = "",
            every = 5,
            backoff = {
              0:   5,    /* on success */
              5:   6,    /* +1  */
              6:   7,    /* +1  */
              7:   9,    /* +2  */
              9:  11,    /* +3  */
              11: 16,    /* +5  */
              16: 24,    /* +8  */
              24: 37,    /* +13 */
              37: 60,    /* +21 (round to 60) */
              60: 60     /* max out at 1min */
            };

        var rehud = function (data) {
          $global.hud = data;
          var json = JSON.stringify(data);
          if (json != last) { redraw(); }
          last = json;
        };
        var ping = function () {
          var uri = ""
          if ($global.auth.tenant) {
            uri = '/v2/tenants/'+$global.auth.tenant.uuid+'/health'
          }else{
            uri = '/v2/health'
          }
          $.ajax({
            type: 'GET',
            url:  uri,
            success: function (data) {
              every = backoff[0]; /* reset backoff */
              rehud(data);
            },
            error: function (xhr) {
              var old = every;
              every = backoff[every];
              if (every != backoff[every]) {
                console.log('/v2/health check failed; backing off to check every %d seconds', every);
              }

              $global.hud.health.core = 'unreachable';
              rehud($global.hud);
            },
            complete: function () {
              window.setTimeout(ping, every * 1000);
            }
          });
        }
        ping();
      })(5);
      /* }}} */
      /* ... handle the account menu {{{ */
      $(document.body).on('click', '.top-bar a[rel=account]', function (event) {
        event.preventDefault();
        event.stopPropagation();
        $('.top-bar .flyout').toggle();
      });
      $(document.body).on('click', '.top-bar a[href^="switchto:"]', function (event) {
        event.preventDefault();
        var uuid = $(event.target).attr('href').replace(/^switchto:/, '');
        for (var i = 0; i < $global.auth.tenants.length; i++) {
          if ($global.auth.tenants[i].uuid == uuid) {
            $global.auth.tenant = $global.auth.tenants[i];
            redraw();
            var page = document.location.hash.replace(/^(#!\/[^\/]*).*/, '$1');
            if (page == "#!/do") { page = "#!/systems"; }
            goto(page);
          }
        }
      });
      $(document.body).on('click', '.top-bar .fly-out', function (event) {
        event.preventDefault();
        event.stopPropagation();
      });
      $(document.body).on('click', function (event) {
        $('.ephemeral').hide();
      });
      /* }}} */

      /* global: show a task in the next row down {{{ */
      $('#main').on('click', 'a[href^="task:"]', function (event) {
        event.preventDefault();
        var uuid  = $(event.target).closest('a[href^="task:"]').attr('href').replace(/^task:/, '');
        var $ev   = $(event.target).closest('.event');
        var $task = $ev.find('.task');

        if ($task.is(':visible')) {
          $task.hide();
          return;
        }

        $task = $task.show()
                    .html(template('loading'));

        api({
          type: 'GET',
          url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/tasks/'+uuid,
          error: "Failed to retrieve task information from the SHIELD API.",
          success: function (data) {
            $task.html(template('task', {
              task: data,
              restorable: data.archive_uuid != "" && data.status == "done",
            }));
          }
        });
      });
      /* }}} */
      /* global: show an annotation form, in a task log {{{ */
      $('#main').on('click', '.task button[rel^="annotate:"]', function (event) {
        $(event.target).closest('.task').find('form.annotate').toggle();
      });
      /* }}} */
      /* global: submit the annotation form {{{ */
      $('#main').on('submit', '.task form.annotate', function (event) {
        event.preventDefault();

        var $form = $(event.target);
        var uuid = $form.extract('system-uuid');

        if ($form.is('[data-system-uuid] [data-task-uuid] *')) {
          var ann = {
            type  : "task",
            uuid  : $form.find('[name=uuid]').val(),
            notes : $form.find('[name=notes]').val()
          };
          if ($form.find('input[name=disposition]').length > 0) {
            ann.disposition = $form.find('input[name=disposition]').is(':checked')
                            ? "ok" : "failed";
          }
          ann.clear = $form.find('[optgroup=clear]:checked').val();
          if (ann.clear == '') {
            ann.clear = "normal";
          }

          api({
            type: 'PATCH',
            url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/systems/'+uuid,
            data: { "annotations": [ann] },
            success: function (data) {
              $form.hide();
              banner("task annotation saved.");
              reload();
            },
            error: function (xhr) {
              $form.hide();
              banner("task annotation failed to save.", 'error');
            }
          });

        } else {
          throw 'unexpected annotation form (not a .tasks or .archives descendent)'
        }
      });
      /* }}} */

      /* global: handle "run:job-uuid" links {{{ */
      $('#main').on('click', 'a[href^="run:"], button[rel^="run:"]', function (event) {
        event.preventDefault();
        var uuid;
        if ($(event.target).is('button')) {
          uuid = $(event.target).attr('rel');
        } else {
          uuid  = $(event.target).closest('a[href^="run:"]').attr('href');
        }
        uuid = uuid.replace(/^run:/, '');

        banner('scheduling ad hoc backup...', 'progress');
        api({
          type: 'POST',
          url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/jobs/'+uuid+'/run',
          success: function () {
            banner('ad hoc backup job scheduled');
            reload();
          },
          error: function () {
            banner('unable to schedule ad hoc backup job', 'error');
          }
        });
      });
      /* }}} */
      /* global: handle "restore:archive-uuid" buttons {{{ */
      $('#main').on('click', '.task button[rel^="restore:"]', function (event) {
        var uuid   = $(event.target).extract('archive-uuid');
        var target = $(event.target).extract('system-name');
        var taken  = $(event.target).extract('archive-taken');
        console.log('restoring archive %s!', uuid);

        modal(template('restore-are-you-sure', {
            target: target,
            taken:  taken
          })).on('click', '[rel=yes]', function(event) {
          event.preventDefault();
          api({
            type: 'POST',
            url:  '/v2/tenants/'+$global.auth.tenant.uuid+'/archives/'+uuid+'/restore',
            success: function() {
              banner("restore operation started");
            },
            error: function () {
              banner("unable to schedule restore operation", "error");
            }
          });
        });
      });
      /* }}} */
    });
    </script>

  </body>
</html>
