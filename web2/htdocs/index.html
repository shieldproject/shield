<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/shield.css" />
    <link rel="stylesheet" href="/fa/css/fontawesome.min.css" />
    <link rel="stylesheet" href="/fa/css/brands.min.css" />
    <title>SHIELD</title>
  </head>
  <body>
    <div class="top-bar">
      <a class="cli" href="/cli/mac/shield"   title="Download MacOS SHIELD CLI"><i class="fab fa-1x fa-apple"></i></a>
      <a class="cli" href="/cli/linux/shield" title="Download Linux SHIELD CLI"><i class="fab fa-1x fa-linux"></i></a>
      <h1>SHIELD</h1></div>
    <div id="viewport" class="full"></div>

    <script type="text/html" id="template:layout"><!-- {{{ -->
      [[#
        {layout}

        The main (authenticated) layout for the UI
      ]]
      <div class="story-sidebar">
        <nav>
          [[ if (AEGIS.is('tenant', 'operator')) { ]]
            <li><a href="#!/do/backup">Run an ad hoc backup</a>
                <p>Run a backup job whenever you need to, regardless of the job's
                schedule.</p></li>

            <li><a href="#!/do/restore">Restore data from a backup</a>
                <p>Restore a protected system back to the state it was in when a
                backup archive was taken.</p></li>
            [[ if (AEGIS.is('tenant', 'engineer')) { ]]
              <li><a href="#!/do/configure">Configure a new backup job</a>
                  <p>Set up a new protected system, and configure the how, when,
                  and for how long of managing its backup archives.</p></li>
            [[ } ]]
          [[ } else { ]]
            <li><a>You have no tenants...</a>
                <p>Operator stories will show up on the sidebar here, but only
                if you have been assigned to one or more SHIELD tenants.</p></li>
          [[ } ]]
        </nav>
        <footer>
          <a target="_blank" href="https://github.com/starkandwayne/shield"><img src="/i/social/github.png"></a>
          <a target="_blank" href="https://shieldproject.slack.com"><img src="/i/social/slack.png"></a>
          <a target="_blank" href="https://twitter.com/starkandwayne"><img src="/i/social/twitter.png"></a>
          <p>SHIELD Copyright &copy; 2019 Stark & Wayne</p>
        </footer>
      </div>
      <div class="pane">
        [[ if (AEGIS.is('engineer') || AEGIS.is('tenant', 'operator')) { ]]
        <div class="hud blk" id="hud">
          <div class="x5"><div class="inst">
            <ul>
              <li class="shield">SHIELD &hellip;</li>
            </ul>
          </div></div>

          <div class="x5"><div class="health">
            <div class="fill"></div>
          </div></div>

          <div class="x6"><div class="prot">
            <div class="fill"></div>
          </div></div>
        </div>
        [[ } ]]

        <div class="nav sticky" id="sticky-nav">
          <nav>
            <li><a href="#!/systems">Data Systems</a></li>
            <li class="current"><a href="#!/stores">Cloud Storage</a></li>
            [[ if (AEGIS.is('engineer')) { ]]<li><a href="#!/admin">Admin</a></li>[[ } ]]
          </nav>
        </div>

        <div class="nav">
          <nav>
            <li><a href="#!/systems">Data Systems</a></li>
            <li class="current"><a href="#!/stores">Cloud Storage</a></li>
            [[ if (AEGIS.is('engineer')) { ]]<li><a href="#!/admin">Admin</a></li>[[ } ]]
          </nav>
        </div>

        <div id="lock-state" class="locked">
          <h1>This SHIELD Core is LOCKED</h1>
          <p>SHIELD needs to be unlocked before backup jobs (scheduled or ad hoc),
          or restore jobs can be run.</p>

          [[ if (AEGIS.is('engineer')) { ]]
          <form id="unlock-shield">
            <input type="password" name="master" placeholder="SHIELD Master Password">[[#
            ]]<button type="submit">Unlock</button>
          </form>
          [[ } else { ]]
          <p>Please contact your SHIELD administrator(s) and ask them to kindly unlock SHIELD.</p>
          [[ } ]]
        </div>
        <div class="field" id="main">
          <img id="loading" src="/i/loading.svg"/>
        </div>
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:loading"><!-- {{{ -->
      [[#
        {loading} template

        A simple SVG loading screen that keeps the viewer entertained while we
        go talk to SHIELD over AJAX, asynchronously.
      ]]
      <img id="loading" src="/i/loading.svg"/>
    <!-- }}} --></script>
    <script type="text/html" id="template:overlay"><!-- {{{ -->
      [[#
        {overlay}

        A page overlay washes out the main page, makes the viewport fixed
        and non-scrollable, and then displays a message, warning, notice,
        or update to ensure that the viewer sees it.
      ]]
      <div id="overlay">
        <div class="header"><h2>[[= h(lens.maybe(_.title, "SHIELD")) ]]</h2></div>
        <div class="frame">[[= _.html ]]</div>
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:banner"><!-- {{{ -->
      [[#
        {banner} template

        Displays a message at the top of the viewport
      ]]
      <p class="[[= _.type ]]">[[= _.message ]] <a href="#">dismiss</a></p>
    <!-- }}} --></script>
    <script type="text/html" id="template:error"><!-- {{{ -->
      [[#
        {error} template

        Displays a page-wide error, for failures involving AJAX requests,
        unhandled exceptions, etc.
      ]]
          <div class="gutter blk error">
            <h2>Uh-oh &mdash; Something broke.</h2>
            <p id="message">[[= _.message ]]</p>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:restore-are-you-sure"><!-- {{{ -->
      [[#
        {restore-are-you-sure}

        A modal interaction screen that requires the operator to acknowledge
        that what they are about to do is in fact to restore data, that it
        might be dangerous, and it might not work out.
      ]]
          <div class="confirm">
            <h2>You Are About To Restore Data</h2>
            <p>You have requested that SHIELD restore <em>[[= _.target ]]</em>
            from a backup that was taken <em>[[= strftime("on %A, %B %d, %Y at %H:%M%P", _.taken) ]]</em> ([[= duration(tdiff(_.taken, new Date())) ]] ago).
            Any new data created after that point in time <em>will be lost</em>.</p>

            <p>Addtionally, the target system may be <em>offline or non-operational</em>
            while the restore operation is carried out.</p>

            <p class="q">Are you sure you want to restore <em>[[= _.target ]]</em>?</p>
            <div class="a">
              <button class="closes safe" rel="close">No, Cancel This Operation</button>
              <button class="closes danger" rel="yes">Yes, Initiate Restore</button>
            </div>
          </div>
          
    <!-- }}} --></script>

    <script type="text/html" id="template:delete-are-you-sure"><!-- {{{ -->
      [[#
        {delete-are-you-sure}

        A modal interaction screen that requires the operator to acknowledge
        that what they are about to do is in fact to delete data, that it
        might be dangerous, and it might not work out.
      ]]
          <div class="confirm">
            <h2>You Are About To Delete Your Backup Job</h2>

            <p>You have requested that SHIELD delete backup job <em>[[= _.name]]</em>.</p>
            <p>This jobs runs <em>[[= _.schedule]]</em>.</p>

            <p>Existing archives created with this job will remain until they expire or are deleted.</p>
            
            <p class="q">Are you sure you want to delete backup job <em>[[= _.name ]]</em>?</p>
            <div class="a">
              <button class="closes safe" rel="close">No, Cancel This Operation</button>
              <button class="closes danger" rel="yes">Yes, Delete Job</button>
            </div>
          </div>
              
        <!-- }}} --></script>

    <script type="text/html" id="template:backup-are-you-sure"><!-- {{{ -->
      [[#
        {backup-are-you-sure}

        A modal interaction screen that requires the operator to acknowledge
        that what they are about to do is in fact to backup data, that it
        might be dangerous, and it might not work out.
      ]]
      [[
        var job     = AEGIS.job(_.uuid);
        var target  = AEGIS.system(job.target_uuid);
      ]]
          <div class="confirm">
            <h2>Run Ad Hoc Backup?</h2>
            <p>You have requested that SHIELD perform an ad hoc backup of <em>[[= target.name ]]</em>

            <p>The target system may be <em>offline or non-operational</em>
            while the backup operation is carried out.</p>

            <p class="q">Are you sure you want to backup <em>[[= target.name ]]</em>?</p>
            <div class="a">
              <button class="closes safe" rel="close">No, Cancel This Operation</button>
              <button class="closes danger" rel="yes">Yes, Initiate Backup</button>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:login"><!-- {{{ -->
      [[#
        {login} template

        Displays the login screen, which is a slightly different layout than
        most of the interface.  If OAuth2 backends have been configured, those
        are displayed as links to kick off the necessary OAuth2 flows (although
        they are styled as buttons)
      ]]
          <div id="login" class="frontdoor">
            <div[[ if (_.providers.length == 0) { ]] class="local-only"[[ } ]]>
              <h1>SHIELD<span style="color: [[= h(_.info.color || 'green') ]]">[[= h(_.info.env) ]]<span></h1>
              <div class="dialog">
                <div class="motd">[[= md(_.info.motd) ]]</div>

                [[ if (_.providers.length > 0) { ]]
                <div class="oauth2">
                  <h2>Sign in using...</h2>

                  <ul>
                    [[ $.each(_.providers, function (i, provider) { ]]
                    <li class="provider-[[= provider.type ]]"><a class="login" href="[[= provider.web_entry ]]">[[= provider.name ]]</a></li>
                    [[ }); ]]
                </div>
                [[ } ]]
                <div class="local">
                  <h2>Sign in with your SHIELD account</h2>

                  <form>
                    <div class="error"></div>
                    <div class="ctl" data-field="username">
                      <label for="local-login-username">Username</label>
                      <div class="errors">
                        <span data-error="missing">Please supply your username.</span>
                      </div>
                      <input type="text" id="local-login-username" name="username">
                    </div>
                    <div class="ctl" data-field="password">
                      <label for="local-login-password">Password</label>
                      <div class="errors">
                        <span data-error="missing">Please supply your password.</span>
                      </div>
                      <input type="password" id="local-login-password" name="password">
                    </div>
                    <button>Sign in</button>
                  <form>
                </div>
              </div>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:init"><!-- {{{ -->
          [[#
            {init} template

            Displays the initialization template screen (displayed after login on an uninitialized SHIELD)
          ]]
              <div id="initialize" class="frontdoor">
                  <h1>SHIELD<span style="color: [[= h(AEGIS.shield.color || 'green') ]]">[[= h(AEGIS.shield.env) ]]<span></h1>
                  <div class="dialog">
                    <p class="motd">[[= md(AEGIS.shield.motd) ]]</p>
                    <div class="restore">
                       <h2>Restore SHIELD</h2>
                        <p class="restore_divert">If you'd like to initialize this SHIELD installation with a previous SHIELD self-backup, provide the archive file and the fixed key used to encrypt the backup. </p>
                          <form id="restore">
                        <div class="error"></div>
                        <div class="ctl" data-field="archive">
                          <label for="archive">SHIELD Backup
                            <div class="file-upload">Select Archive</div>
                          </label>
                           <input type="file" id="archive" name="archive">
                          <div class="errors">
                            <span data-error="missing">Please supply your SHIELD backup.</span>
                          </div>
                        </div>
                        <div class="ctl" data-field="fixedkey">
                          <label for="fixedkey">Fixed Key</label>
                          <div class="errors">
                            <span data-error="missing">Please supply your fixed key.</span>
                          </div>
                          <input type="password" id="fixedkey" name="fixedkey">
                        </div>
                        <button>Restore</button>
                      </form>
                    </div>
                    <div class="setpass">
                      <h2>Initialize SHIELD</h2>
                        <p class="divert">SHIELD maintains an internal encrypted vault of secrets, for protecting your data archives with strong encryption. This vault must be initialized, and protected with a new master password, before SHIELD will be able to use it</p>
                      <form id="setpass">
                        <div class="error"></div>
                        <div class="ctl" data-field="masterpass">
                          <label for="masterpass">Master Password</label>
                          <div class="errors">
                            <span data-error="missing">Please supply your password.</span>
                          </div>
                          <input type="password" id="masterpass" name="masterpass">
                        </div>
                        <div class="ctl" data-field="masterpassconf">
                          <label for="masterpassconf">Confirm Password</label>
                          <div class="errors">
                            <span data-error="missing">Please supply your password.</span>
                            <span data-error="mismatch">Your passwords do not match</span>
                          </div>
                          <input type="password" id="masterpassconf" name="masterpassconf">
                        </div>
                        <button>Set up</button>
                      </form>
                    </div>
                  </div>
              </div>
        <!-- }}} --></script>
    <script type="text/html" id="template:cliauth"><!-- {{{ -->
      [[#
        {cliauth} template

        Displays the session ID for an authenticated session, so that the CLI
        can be told what that session ID is.
      ]]
          <div id="cliauth" class="frontdoor">
            <div>
              <h1>SHIELD<span>[[= h(AEGIS.shield.env) ]]<span></h1>
              <div class="dialog">
                <h2>CLI Authentication Credentials</h2>
                <img src="/i/terminal.png" class="highlight">

                <p>Here are your SHIELD CLI authentication
                credentials:</p>

                <pre id="creds">[[= _.s ]]</pre>

                <p>You will need to copy-and-paste those into
                the terminal session where you ran the SHIELD
                command-line interface, to complete the
                authentication process.</p>
              </div>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:fixedkey"><!-- {{{ -->
        [[#
          {fixedkey} template

          Displays the Shield Fixed Key, so that operators can restore
          fixed-key backups in the event of a disaster.
        ]]
            <div id="fixed-wrapper" class="frontdoor">
              <div>
                <h1>SHIELD<span>[[= h(AEGIS.shield.env) ]]<span></h1>
                <div class="dialog">
                  <h2>Shield Fixed Key</h2>
                  <img src="/i/terminal.png" class="highlight">

                  <p>Here is your SHIELD Fixed Key:</p>

                  <pre id="fixedkey">[[= _.fixed_key ]]</pre>

                  <p id="dr-explain">
                    You will need to save this key in a secure location
                    for use in recovery of fixed-key backups in a disaster scenario.
                    Fixed-key backups must be used to backup shield itself. Once you
                    leave this screen, there is no way to access this key or corresponding
                    fixed-key backups unless you have saved it!
                  </p>
                  <a href="/"><button id="accept">I Understand</button></a>
                </div>
              </div>
            </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:logging-in"><!-- {{{ -->
      [[#
        {logging-in} template

        A simple loading screen that keeps the viewer apprised of
        our login efforts, while the browser processes the actual
        login and/or redirection.
      ]]
      <div id="logging-in">
        <p><img src="/i/loading-icon.svg"/>
           Signing into <span>SHIELD</span> via <span>[[= _.auth ]]</span>...</p>
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:BOOM"><!-- {{{ -->
      [[#
        {BOOM} template

        Displays a viewport-bound error message (without the hud/sidebar chrome)
        when SHIELD fails to boot up properly.  Typically, this means that we
        failed in our AJAX request to get the Authentication Providers to render
        the login page.
      ]]
          <div id="BOOM" class="frontdoor">
            <div>
              <h1>SHIELD<span>Production<span></h1>
              <div class="dialog">
                <h2>SOMETHING BROKE</h2>
                <img src="/i/boom.png" class="highlight">
                <p>An error has occurred, and SHIED was unable to recover from it.
                Your SHIELD site administrator may be able to peruse the SHIELD
                logs on this installation to shed some light on this conundrum.</p>

                <p>Most of the time, this is related to an inability to retrieve
                the authentication parameters for this SHIELD instance.  You may
                want to check to make sure you are connected to the internet, and
                if you need to hook up to any VPNs to access SHIELD, ensure that
                they too are connected.</p>
              </div>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:top-bar"><!-- {{{ -->
      [[#
        {top-bar} template

        Renders the top-most bar, with the SHIELD name / environment, and the
        current users name / tenant and "personal settings" menu.
      ]]
        <a class="cli" href="/cli/mac/shield"   title="Download MacOS SHIELD CLI"><i class="fab fa-1x fa-apple"></i></a>
        <a class="cli" href="/cli/linux/shield" title="Download Linux SHIELD CLI"><i class="fab fa-1x fa-linux"></i></a>
        <h1><a href="#!/systems">SHIELD [[ if (AEGIS.shield.color) { ]]<span style="color:[[= AEGIS.shield.color ]]">[[ } ]][[= h(AEGIS.shield.env) ]]</span> <span>[[= h(AEGIS.shield.ip) ]]</span></a></h1>
        [[ if (AEGIS.authenticated()) { ]]
        <a href="#!/account" rel="account">[[= h(AEGIS.user.name) ]][[ if (AEGIS.current) { ]] ([[= h(AEGIS.current.name) ]] :: [[= AEGIS.role(AEGIS.current.uuid) ]])[[ } ]]</a>
        <div class="flyout ephemeral">
          <div class="menu">
            <div class="header">Signed in as [[= h(AEGIS.user.account) ]]
              <span>[[= h(AEGIS.user.backend) ]]</span>
            </div>
            <div class="divider"></div>
            <div class="header">Your Tenants</div>
            [[ var tenants = AEGIS.tenants(); ]]
            [[ if (tenants.length == 0) { ]]
            <span class="dropdown odd">you have no tenants</span>
            [[ } else { ]]
            [[   $.each($.sortBy(tenants, 'name'), function (i, tenant) { ]]
            <a class="dropdown[[ if (AEGIS.current && tenant.uuid == AEGIS.current.uuid) { ]] current.tenant[[ } ]]" href="switchto:[[= tenant.uuid ]]">[[= h(tenant.name) ]] ([[= AEGIS.role(tenant.uuid) ]])</a>
            [[   }); ]]
            [[ } ]]
            <!--
            [[ if (AEGIS.is('tenant', 'admin')) { ]]
                <div class="divider"></div>
                <a class="dropdown" href="#!/tenants/edit:uuid:[[= AEGIS.current.uuid ]]">Tenant Settings</a>
            [[ } ]]
            -->
            <div class="divider"></div>
            <!--a class="dropdown" href="#!/settings">Settings</a-->
            <a class="dropdown" href="#!/logout">Sign Out</a>
          </div>
        </div>
        [[ } ]]
    <!-- }}} --></script>
    <script type="text/html" id="template:hud"><!-- {{{ -->
        [[#
          {hud} template

          Renders the "health and wellness" heads-up display (HUD), with more
          information about this SHIELD instance (name / env / IP / version),
          health and key metrics.
        ]]
            <div class="x5"><div class="inst">
              <ul>
                <li class="shield">SHIELD
                  [[ if (AEGIS.shield.version) { ]]<span class="v">[[= h(AEGIS.shield.version) ]]</span>
                  [[ } else { ]]<span class="v dev">(development)</span>
                  [[ } ]]</li>
                [[ if (AEGIS.shield.ip)   { ]]<li class="ip">[[= h(AEGIS.shield.ip) ]]</li>[[ } ]]
                [[ if (AEGIS.shield.fqdn) { ]]<li class="fqdn">[[= h(AEGIS.shield.fqdn) ]]</li>[[ } ]]
                <li class="env"><span style="color: [[= h(lens.maybe(AEGIS.shield.color, "#8CC63F")) ]]">[[= h(AEGIS.shield.env) ]]</span></li>
              </ul>
            </div></div>


            <div class="x5"><div class="health">
              <div class="preload" style="display: none">
                <object type="image/svg+xml" data="i/api-ok.svg"></object>
                <object type="image/svg+xml" data="i/api-fail.svg"></object>
                <object type="image/svg+xml" data="i/cloud-ok.svg"></object>
                <object type="image/svg+xml" data="i/cloud-fail.svg"></object>
                <object type="image/svg+xml" data="i/jobs-ok.svg"></object>
                <object type="image/svg+xml" data="i/jobs-fail.svg"></object>
              </div>
              <ul>
                [[
                    var health = {
                      core:    AEGIS.vault,
                      storage: "ok",
                      jobs:    "ok"
                    };

                    if (AEGIS.current) {
                      $.each(AEGIS.stores({ tenant: AEGIS.current.uuid }),
                             function (_, store) {
                               if (!store.healthy) {
                                 health.storage = "failing";
                               }
                             });

                      $.each(AEGIS.jobs({ tenant: AEGIS.current.uuid }),
                             function (_, job) {
                               if (!job.healthy) {
                                 health.jobs = "failing";
                               }
                             });
                    } else {
                      $.each(AEGIS.stores({ global: true }),
                             function (_, store) {
                               if (!store.healthy) {
                                 health.storage = "failing";
                               }
                             });
                    }
                ]]
                [[ if (health.core == "unlocked") { ]]
                <li class="ok"><object type="image/svg+xml" data="i/api-ok.svg"></object> SHIELD is <span>up</span></li>
                [[ } else { ]]
                <li class="fail"><object type="image/svg+xml" data="i/api-fail.svg"></object> SHIELD is <span>[[= h(health.core) ]]</span></li>
                [[ } ]]

                [[ if (health.storage == "ok") { ]]
                <li class="ok"><object type="image/svg+xml" data="i/cloud-ok.svg"></object> Cloud Storage is <span>connected</span></li>
                [[ } else { ]]
                <li class="fail"><object type="image/svg+xml" data="i/cloud-fail.svg"></object> Cloud Storage is <span>[[= h(health.storage) ]]</span></li>
                [[ } ]]

                [[ if (AEGIS.current) { ]]
                [[ if (health.jobs == "ok") { ]]
                <li class="ok"><object type="image/svg+xml" data="i/jobs-ok.svg"></object> All Jobs <span>succeeding</span></li>
                [[ } else { ]]
                <li class="fail"><object type="image/svg+xml" data="i/jobs-fail.svg"></object> Jobs are <span>[[= h(health.jobs) ]]</span></li>
                [[ } ]]
                [[ } ]]
              </ul>
            </div></div>

            <div class="x6"><div class="prot">
              <h3>Data Protection Summary</h3>
              <ul>
                [[ if (AEGIS.current) { ]]
                <li>Scheduled Backup Jobs <span>[[= AEGIS.jobs({ tenant: AEGIS.current.uuid }).length ]]</span></li>
                <li>Backup Archives <span>[[= h(AEGIS.current.archive_count) ]]</span></li>
                <li class="warn">Cloud Storage Used <span>[[= h(bytes(AEGIS.current.storage_used)) ]]</span></li>
                <li class="ok">Daily Storage Increase <span>[[= h(bytes(AEGIS.current.daily_increase)) ]]</span></li>
                [[ } else { ]]
                <li>you do not belong to any tenants...</li>
                [[ } ]]
              </ul>
            </div></div>
    <!-- }}} --></script>
    <script type="text/html" id="template:404"><!-- {{{ -->
      [[#
        {404} template

        Help a lost traveller on their way.
      ]]
          <div class="gutter blk e404">
            <h2>Oops.  We Couldn't Find That...</h2>
            <img src="/i/404.png" width="30%">
            <p>Looks like someone or some<em>thing</em> directed you to a part of the SHIELD
            web interface that just doesn't exist.  Bummer.  If you are sure this is SHIELD's
            fault (and it very well could be), please report an issues over at our
            <a href="https://github.com/starkandwayne/shield/issues/new" target="_blank">Github
            Page</a>.</p>

            <pre>You can paste this additional information
      into your Github issue:

      - **Wanted URL**: [[= h(_.wanted) ]]
      - **Arguments**:  ([[= h(_.args.join(', ')) ]])
      - **Referer**:    [[= h(lens.maybe(_.referer, '_none_')) ]]
      </pre>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:account"><!-- {{{ -->
      [[#
        {account}

        Shows the user their current account information,
        including a form for changing their name (and, if
        local, their password), and a list of all tenants
        that they belong to, and their roles therein.
      ]]
          <div class="gutter blk account">
            <h2>My Account</h2>

            <form>
              <p><label for="name">Display</label>
              <input type="text" value="" /></p>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:roles-menu"><!-- {{{ -->
      [[#
        {roles-menu}

        A flyout menu for selecting roles, on either tenants
        (if given {type: "tenant"}) or the system ({type: "system"}).
      ]]
      <div class="roles-menu ephemeral">
        [[ if (_.type == 'tenant') { ]]
        <div[[ if (_.current == "admin") { ]] class="current"[[ } ]] data-role="admin">
          <strong>Administrator</strong>
          <p>Full control over this tenant.</p>
        </div>
        <div[[ if (_.current == "engineer") { ]] class="current"[[ } ]] data-role="engineer">
          <strong>Engineer</strong>
          <p>Can do everything except manage other peoples
             access to this tenant.</p>
        </div>
        <div[[ if (_.current == "operator") { ]] class="current"[[ } ]] data-role="operator">
          <strong>Operator</strong>
          <p>View access to most things, with the ability to
             pause and unpause jobs, run ad hoc backups, and
             perform restore operations.</p>
        </div>
        [[ } else { ]]
        <div[[ if (_.current == "admin") { ]] class="current"[[ } ]] data-role="admin">
          <strong>Administrator</strong>
          <p>Full control over SHIELD.</p>
        </div>
        <div[[ if (_.current == "manager") { ]] class="current"[[ } ]] data-role="manager">
          <strong>Manager</strong>
          <p>Can create and edit tenants, manage tenant/user
             memberships, and manage user accounts and access rights.</p>
        </div>
        <div[[ if (_.current == "engineer") { ]] class="current"[[ } ]] data-role="engineer">
          <strong>Engineer</strong>
          <p>Manages global configuration, namely shared cloud
             storage configurations.</p>
        </div>
        [[ } ]]
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:you-have-no-tenants"><!-- {{{ -->
      [[#
        {you-have-no-tenants} template

        What do you do when someone tries to access the parts of
        SHIELD that require a tenancy context, yet they have no
        tenants to speak of?  Why, you show them this little screen,
        of course!
      ]]
          <div class="gutter blk e404">
            <h2>Hrmm.  You Don't Seem To Belong To Any Tenants</h2>
            <p>This part of SHIELD only makes sense in the context of a tenant.
            However, it seems that your account has not been invited to participate
            in any tenants yet.</p>

            <p>You may want to reach out to your SHIELD administrator and ask them
            to assign you to a tenant, or check their configuration if they believe
            you ought to just be automagically assigned to one by the system.</p>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:access-denied"><!-- {{{ -->
      [[#
        {access-denied} template

        What do you do when someone tries to access the parts of
        SHIELD that require a certain level of access that is above
        their role assignment?  Try this screen!

        The following data can be provided to tailor the message:

          level: "system"    What level is access being denied at.
                             The value 'system' applies to global,
                             administrative contexts; 'tenant'
                             indicates a per-tenant ACL violation.

          need: "role"       What role is needed to gain access to
                             the given resource.

      ]]
          <div class="gutter blk">
            <h2>Access Denied</h2>
            [[ var want = _.level + '/' + _.need; ]]
            [[ if (want == 'system/admin') { ]]
                 <p>This part of SHIELD requires site-level <strong>administator</strong> access.</p>
                 <p>Only SHIELD site administrators can grant this level of access.</p>
            [[ } else if (want == 'system/manager') { ]]
                 <p>This part of SHIELD requires site-level <strong>manager</strong> access.</p>
                 <p>Only SHIELD site administrators can grant this level of access.</p>
            [[ } else if (want == 'system/engineer') { ]]
                 <p>This part of SHIELD requires site-level <strong>engineer</strong> access.</p>
                 <p>Only SHIELD site administrators can grant this level of access.</p>
            [[ } else if (want == 'tenant/admin') { ]]
                 <p>In order to access this part of SHIELD, you need to be
                 an <strong>administrator</strong> on this tenant.</p>
                 <p>Please contact your SHIELD site operators if you believe
                 you should have this level of access.</p>
            [[ } else if (want == 'tenant/engineer') { ]]
                 <p>In order to modify the configuration of resources on this
                 tenant, you need to be granted <strong>engineer</strong>-level
                 access.</p>
                 <p>Please consult your tenant administrators if you believe
                 you should have this level of access.</p>
            [[ } else if (want == 'tenant/operator') { ]]
                 <p>In order to operate on this tenant, you will need to be
                 granted <strong>operator</strong>-level access.</p>
                 <p>Please consult your tenant administrators if you believe
                 you should have this level of access.</p>
            [[ } else if (want == 'generic/elevated') { ]]
                 <p>This part of SHIELD requires <strong>elevated</strong> access.</p>
                 <p>Please consult your administrators if you believe you should
                 have this level of access.</p>
            [[ } else { ]]
                 <p>This part of SHIELD requires <strong>[[= h(_.level) ]]/[[= h(_.need) ]]</strong>
                    access, which seems to be an invalid role.  Please submit a bug report.</p>
            [[ } ]]
          </div>
    <!-- }}} --></script>

    <script type="text/html" id="template:do-backup"><!-- {{{ -->
      [[#
        {do-backup} - Backup Wizard Template

        Renders a multi-step, interactive wizard to assist operators in
        finding the correct backup archive to restore, based on what
        data system they want to restore, and how fresh the backup needs
        to be.
      ]]
      <div class="gutter blk wizard2 steps4 do-backup">
        <form class="new-form1">
          <div class="progress">[[# {{{ ]]
            <div class="back line"></div>
            <div class="front line"></div>
            <ul>
              <li><i>1</i><strong>Start</strong></li>
              <li><i>2</i><strong>Data System</strong>
                The data you want to back up.</li>
              <li><i>3</i><strong>Cloud Storage</strong>
                Where the archives are..</li>
              <li><i>4</i><strong>Review</strong></li>
            </ul>
          </div>[[# }}} ]]

          <div data-step="1">
            <h2>Run an Ad Hoc Backup</h2>
            <div class="c12">[[# intro text {{{ ]]
              <div class="x9 intro">
                <p>This wizard will run a one-off, ad hoc backup job, regardless
                of its schedule.  You pick the data system you want to run a backup
                for, and a cloud storage system / retention policy, and let SHIELD
                do the rest.</p>

                <p><strong>Note:</strong> SHIELD can only run previously configured
                jobs; this wizard will not allow you to arbitrarily choose storage
                and data systems.</p>

                <div class="buttons">
                  <button rel="next">First up: <span>Choose a Data System</span> ▶</button>
                </div>
              </div>
            </div>[[# }}} ]]
          </div>

          <div data-step="2">
            <h2><span>Run an Ad Hoc Backup</span>Choose Your Data System</h2>
            <div class="c12 band">[[# {{{ ]]
              <div class="x9">
                [[ var systems = AEGIS.systems({ tenant: AEGIS.current.uuid }); ]]
                <table class="lean sortable selectable choose target">
                  <thead>
                    <tr>
                      <th class="sortable">Name</th>
                      <th class="sortable">Type</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    [[ $.each(systems, function (i, target) { ]]
                    <tr class="[[ if (!target.healthy) { ]]fail[[ } else { ]]ok[[ } ]]"
                        data-target-uuid="[[= target.uuid ]]">
                      <td class="name">
                        <img src="i/shield-[[= target.healthy ? 'ok' : 'fail' ]].svg">
                        [[= h(target.name) ]]
                      </td>
                      <td>[[= h(target.plugin) ]]</td>
                      <td class="notes">
                        [[= md(target.summary) ]]
                      </td>
                    </tr>
                    [[ }); ]]
                  </tbody>
                </table>
                <div class="buttons">
                  <button rel="prev">◀ Back to <span>Start</span></button>
                  <button rel="next">Next up: <span>Cloud Storage</span> ▶</button>
                </div>
              </div>
              <div class="x3">
                <div class="side-help">Select what you'd like to backup. You can choose from an existing data system that SHIELD already knows, or configure a new one.</div>
              </div>
            </div>[[# }}} ]]
          </div>

          <div data-step="3">
            <h2><span>Run an Ad Hoc Backup</span>Choose Your Cloud Storage</h2>
            <div class="redraw jobs"></div>
          </div>

          <div data-step="4" class="redraw review"></div>
        </form>
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:do-backup-choose-job"><!-- {{{ -->
      [[#
        {do-backup-choose-job} - Job Selection for Ad Hoc Backup Wizard

      ]]
            <div class="c12 band">[[# {{{ ]]
              <div class="x9">
                [[ var system = AEGIS.system(_.target.uuid); ]]
                <table class="lean sortable selectable choose store">
                  <thead>
                    <tr>
                      <th class="sortable">Name</th>
                      <th class="sortable">Type</th>
                      <th class="sortable">Retention</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    [[ $.each(AEGIS.jobs({ system: system.uuid }), function (i, job) {
                         var store = AEGIS.store(job.store_uuid);
                    ]]
                    <tr class="[[ if (!store.healthy) { ]]fail[[ } else { ]]ok[[ } ]]"
                        data-job-uuid="[[= job.uuid ]]">
                      <td class="name">
                        <img src="i/shield-[[= store.healthy ? 'ok' : 'fail' ]].svg">
                        [[= h(store.name) ]]
                        [[ if (store.global) { ]]<span class="tag">global</span>[[ } ]]
                      </td>
                      <td>[[= h(store.plugin) ]]</td>
                      <td class="retain">[[= pluralize(job.keep_n, 'backup') ]] / [[= pluralize(job.keep_days, 'day') ]]</td>
                      <td class="notes">
                        [[= md(store.summary) ]]
                      </td>
                    </tr>
                    [[ }); ]]
                  </tbody>
                </table>
                <div class="buttons">
                  <button rel="prev">◀ Back to <span>Data System</span></button>
                  <button rel="next">Next up: <span>Review</span> ▶</button>
                </div>
              </div>
              <div class="x3 lean">
                <div class="side-help">Select where you'd like to store your backup archives. You can choose from existing storage systems, or configure a new one.</div>
              </div>
            </div>[[# }}} ]]
    <!-- }}} --></script>
    <script type="text/html" id="template:do-backup-review"><!-- {{{ -->
      [[#
        {do-backup-review} - Restore Wizard Review Screen

        This fragment template exists so that we can redraw it when the final
        review is performed.

      ]]
            <h2><span>Run an Ad Hoc Backup</span>Review Your Selections</h2>
            [[ var system  = AEGIS.system(_.target.uuid);
               var job     = AEGIS.job(_.job.uuid);
               var store   = AEGIS.store(job.store_uuid);
            ]]
            <div class="summary-section">[[# {{{ ]]
              <div class="c12 band">
                <div class="x2"><label>Data System</label></div>
                <div class="x7">
                  <p class="selected-elsewhere">[[= h(system.name) ]] ([[= h(system.plugin) ]])
                  <a class="change-me" href="step:2">change</a></p>
                </div>
              </div>

              <div class="c12 band">
                <div class="x2"><label>Cloud Storage</label></div>
                <div class="x7">
                  <p class="selected-elsewhere">[[= h(store.name) ]] ([[= h(store.plugin) ]])
                  <a class="change-me" href="step:3">change</a></p>
                </div>
              </div>

              <div class="c12 band">
                <div class="x2"><label>Retention</label></div>
                <div class="x7">
                  <p class="selected-elsewhere">[[= pluralize(job.keep_days, 'day') ]] <span>(expires [[= strftime("%A, %B %Oe, %Y", tnow() + job.keep_days * 86400) ]])</span>
                  <a class="change-me" href="step:3">change</a></p>
                </div>
              </div>

            </div>[[# }}} ]]
            <div class="c12">
              <div class="x9 r2 buttons">
                [[ if (AEGIS.locked()) { ]]<p class="wizard-cannot-continue">Uh-oh, it looks like this SHIELD Is locked, so you cannot schedule a backup task!</p>[[ } ]]
                <button rel="prev">◀ Back to <span>Cloud Storage</span></button>
                <button class="final"[[ if (AEGIS.locked()) { ]] disabled[[ } ]]>Run Backup</button>
              </div>
            </div>
    <!-- }}} --></script>

    <script type="text/html" id="template:do-restore"><!-- {{{ -->
      [[#
        {do-restore} - Restore Wizard Template

        Renders a multi-step, interactive wizard to assist operators in
        finding the correct archive to restore, based on what data system
        they want to restore, and how fresh the restore needs to be.
      ]]
      <div class="gutter blk wizard2 steps4 do-restore">
        <form class="new-form1">
          <div class="progress">[[# {{{ ]]
            <div class="back line"></div>
            <div class="front line"></div>
            <ul>
              <li><i>1</i><strong>Start</strong></li>
              <li><i>2</i><strong>Data System</strong>
                The data you want to back up.</li>
              <li><i>3</i><strong>Archive</strong>
                Select the backup archive you want to restore.</li>
              <li><i>4</i><strong>Review</strong></li>
            </ul>
          </div>[[# }}} ]]

          <div data-step="1">
            <h2>Restore a Protected Data System</h2>

            <div class="c12">[[# intro text {{{ ]]
              <div class="x9 intro">
                <p>This wizard will guide you through the process of restoring a
                protected data system from a backup archive.  You choose the system
                that needs restored, and SHIELD will narrow the field of archives
                to include only those that were taken from that system, and are in
                a valid, restorable state.</p>

                <div class="buttons">
                  <button rel="next">First up: <span>Choose a Data System</span> ▶</button>
                </div>
              </div>
            </div>[[# }}} ]]
          </div>

          <div data-step="2">
            <h2><span>Restore Data</span>Choose Your Data System</h2>
            <div class="c12 band">[[# {{{ ]]
              <div class="x9">
                [[ var systems = AEGIS.systems({ tenant: AEGIS.current.uuid }); ]]
                <table class="lean sortable selectable choose target">
                  <thead>
                    <tr>
                      <th class="sortable">Name</th>
                      <th class="sortable">Archives</th>
                      <th class="sortable">Type</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    [[ $.each(systems, function (i, target) {
                         var archives = AEGIS.archives({ tenant: target.tenant_uuid,
                                                         system: target.uuid });
                    ]]
                    <tr class="[[ if (!target.healthy) { ]]fail[[ } else { ]]ok[[ } ]][[ if (archives.length == 0) { ]] no-archive not-selectable[[ } ]]"
                        data-target-uuid="[[= target.uuid ]]">
                      <td class="name">
                        <img src="i/shield-[[= target.healthy ? 'ok' : 'fail' ]].svg">
                        [[= h(target.name) ]]
                      </td>
                      <td>[[ if (archives.length == 0) { ]]<em>none</em>[[ } else { ]][[= archives.length ]][[ } ]]</td>
                      <td>[[= h(target.plugin) ]]</td>
                      <td class="notes">
                        [[= md(target.summary) ]]
                      </td>
                    </tr>
                    [[ }); ]]
                  </tbody>
                </table>
                <div class="buttons">
                  <button rel="prev">◀ Back to <span>Start</span></button>
                  <button rel="next">Next up: <span>Choose an Archive</span> ▶</button>
                </div>
              </div>

              <div class="x3 lean">
                <div class="side-help">Select the system you would like to restore data to.</div>
              </div>
            </div>[[# }}} ]]
          </div>

          <div data-step="3">
            <h2><span>Restore Data</span>Choose Your Backup Archive</h2>
            <div class="redraw archives"></div>
          </div>

          <div data-step="4" class="review"></div>
        </form>
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:do-restore-choose-archive"><!-- {{{ -->
      [[#
        {do-restore} - Restore Wizard Template

        Renders a multi-step, interactive wizard to assist operators in
        finding the correct archive to restore, based on what data system
        they want to restore, and how fresh the restore needs to be.
      ]]
      <div class="c12 band">
        <div class="x9">
          [[
              var archives = [];
              var all = AEGIS.archives({ tenant: AEGIS.current.uuid });
              $.each(all, function (i, archive) {
                if (all[i].status == "valid" && all[i].target_uuid == _.target.uuid) {
                  archives.push(all[i]);
                } else {
                  console.log('rejecting archive %s (status: %s, target: %s)', all[i].uuid, all[i].status, all[i].target_uuid);
                }
              });
          ]]
          [[ if (archives.length == 0) { ]]
          <div class="no-data">No valid backup archives were found for this data system.</div>
          <div class="buttons">
            <button rel="prev">◀ Back to <span>Data System</span></button>
          </div>
          [[ } else { ]]
          <table class="lean sortable selectable choose archive">
            <thead>
              <tr>
                <th class="sortable">UUID</th>
                <th class="sortable">Date</th>
                <th class="sortable">Size</th>
                <th class="sortable">Store</th>
              </tr>
            </thead>
            <tbody>
              [[ $.each(archives, function (i, archive) { ]]
              <tr data-archive-uuid="[[= archive.uuid ]]">
                <td class="uuid">[[= archive.uuid.substr(0,8) ]]</td>
                <td class="date">
                  [[= strftime("%Y-%m-%d %H:%M%P", archive.taken_at) ]]<br>
                  ([[= duration(tdiff(archive.taken_at, new Date())) ]] ago)
                </td>
                <td>[[= bytes(archive.size) ]]</td>
                [[ var store = AEGIS.store(archive.store_uuid); ]]
                <td>[[= store.name ]] ([[= store.plugin ]])</td>
              </tr>
              [[ }); ]]
            </tbody>
          </table>
          <div class="buttons">
            <button rel="prev">◀ Back to <span>Data System</span></button>
            <button rel="next">Next up: <span>Review</span> ▶</button>
          </div>
          [[ } ]]
        </div>
        [[ if (archives.length > 0) { ]]
        <div class="x3 lean">
          <div class="side-help">Select the backup archive you'd like to restore from.  You will only have the option to restore backups made from this target; if you need to restore data from a different system to this one, you'll need to use the command-line interface.</div>
        </div>
        [[ } ]]
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:do-restore-review"><!-- {{{ -->
      [[#
        {do-restore-review} - Restore Wizard Review Screen

        This fragment template exists so that we can redraw it when the final
        review is performed.

      ]]
            <h2><span>Restore Data</span>Review Your Selections</h2>
            [[ var system  = AEGIS.system(_.target.uuid); ]]
            [[ var archive = AEGIS.archive(_.archive.uuid); ]]
            <div class="summary-section">[[# {{{ ]]
              <div class="c12 band">
                <div class="x2"><label>Data System</label></div>
                <div class="x7">
                  <p class="selected-elsewhere">[[= h(system.name) ]] ([[= h(system.plugin) ]])
                  <a class="change-me" href="step:2">change</a></p>
                </div>
              </div>

              <div class="c12 band">
                <div class="x2"><label>Archive</label></div>
                <div class="x7">
                  <p class="selected-elsewhere">[[= archive.uuid.substr(0,8) ]] ([[= bytes(archive.size) ]])
                  <a class="change-me" href="step:3">change</a></p>
                </div>
              </div>

              <div class="c12 band">
                <div class="x2"><label>From</label></div>
                <div class="x7">
                  <p class="selected-elsewhere">[[= strftime("%Y-%m-%d %H:%M:%P", archive.taken_at) ]] ([[= duration(tdiff(archive.taken_at, new Date())) ]] ago)
                  <a class="change-me" href="step:3">change</a></p>
                </div>
              </div>

[[ if (false) { ]]
              <div class="c12 band">
                <div class="x2"><label>Cloud Storage</label></div>
                <div class="x7">
                  <p class="selected-elsewhere">[[= h(_.store.name) ]] ([[= h(_.store.plugin) ]])</p>
                </div>
              </div>
[[ } ]]
            </div>[[# }}} ]]

            <div class="c12">
              <div class="x9 r2 buttons">
                [[ if (AEGIS.locked()) { ]]<p class="wizard-cannot-continue">Uh-oh, it looks like this SHIELD Is locked, so you cannot schedule a restore task!</p>[[ } ]]
                <button rel="prev">◀ Back to <span>Choose an Archive</span></button>
                <button class="final"[[ if (AEGIS.locked()) { ]] disabled[[ } ]]>Restore Data</button>
              </div>
            </div>
    <!-- }}} --></script>

    <script type="text/html" id="template:do-configure"><!-- {{{ -->
      [[#
        {do-configure} - Job Configuration Wizard

      ]]
      [[
        var systems = AEGIS.systems({ tenant: AEGIS.current.uuid });
        var stores = AEGIS.stores({ tenant: AEGIS.current.uuid,
                                    global: true });
      ]]
      <div class="gutter blk wizard2 steps5 do-configure">
        <div class="progress">[[# {{{ ]]
          <div class="back line"></div>
          <div class="front line"></div>
          <ul>
            <li><i>1</i><strong>Start</strong></li>
            <li><i>2</i><strong>Data System</strong>
              The data you want to back up.</li>
            <li><i>3</i><strong>Cloud Storage</strong>
              Where you want to store the backup archives.</li>
            <li><i>4</i><strong>Job Details</strong>
              How often to run backups, how long to keep archives, encryption parameters, etc.</li>
            <li><i>5</i><strong>Review</strong></li>
          </ul>
        </div>[[# }}} ]]

        <div data-step="1">
          <h2>Configure a New Backup Job</h2>

          <div class="c12">[[# intro text {{{ ]]
            <div class="x9 intro">
              <p>This wizard will guide you through the process of configuring a new backup
              job, for SHIELD to run according to a schedule.  A backup job consists of a
              target data system to back up, a storage system to store the backup archives in,
              a schedule for running the job, and a retention policy.</p>

              <p>Before you begin, you may want to assemble credentials and endpoint information
              for your target system.  This includes usernames, passwords, hostnames, IP addresses,
              keys, etc.</p>

              <p>If you haven't already configured Cloud Storage, you'll be given the option
              to create a new one.  If that's the route you wish to take, you'll need connectivity
              details for your backend storage system (S3, WebDAV, etc.) as well.</p>

              <div class="buttons">
                <button rel="next">First up: <span>[[= systems.length == 0 ? 'Define' : 'Choose' ]] a Data System</span> ▶</button>
              </div>
            </div>
          </div>[[# }}} ]]
        </div>

        <div data-step="2" data-mode="[[= systems.length == 0 ? 'create' : 'choose' ]]">
          [[ if (systems.length > 0) { ]]
          <div data-mode="choose">[[# {{{ ]]
            <h2><span>Configure a New Backup Job</span>Choose Your Data System</h2>
            <div class="c12 band">
              <div class="x9">
                <table class="lean selectable choose target">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Type</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    [[ $.each(systems, function (i, target) { ]]
                    <tr class="[[ if (!target.healthy) { ]]fail[[ } else { ]]ok[[ } ]]"
                        data-target-uuid="[[= target.uuid ]]">
                      <td class="name">
                        <img src="i/shield-[[= target.healthy ? 'ok' : 'fail' ]].svg">
                        [[= h(target.name) ]]
                      </td>
                      <td>[[= h(target.plugin) ]]</td>
                      <td class="notes">
                        [[= md(target.summary) ]]
                      </td>
                    </tr>
                    [[ }); ]]
                    <tr><td colspan="3" rel="new">Define a new system...</td></tr>
                  </tbody>
                </table>
                <div class="buttons">
                  <button rel="prev">◀ Back to <span>Start</span></button>
                  <button rel="next">Next up: <span>Cloud Storage</span> ▶</button>
                </div>
              </div>

              <div class="x3 lean">
                <div class="side-help">Select what you'd like to backup. You can choose from an existing data system that SHIELD already knows, or configure a new one.</div>
              </div>
            </div>
          </div>[[# }}} ]]
          [[ } ]]
          <div data-mode="create">[[# {{{ ]]
            <form class="new-form1">
              <h2><span>Configure a New Backup Job</span>Define a New Data System</h2>
              <div class="c12 band">
                <div class="x9">
                  <div class="c12">
                    <div class="field required" data-field="target.name" data-type="string">
                      <div class="x3"><label for="target.name">Name</label></div>
                      <div class="x9">
                        <input type="text" name="target.name"
                               placeholder="Name Your Data System">
                        <span class="errors">
                          <span data-error="missing">Please name your new data system.</span>
                        </span>
                        <p class="help">Pick a memorable or descriptive name for this data system, so that other operators can determine when to use it.</p>
                      </div>
                    </div>

                    <div class="field">
                      <div class="x3"><label for="target.summary">Notes</label></div>
                      <div class="x9">
                        <textarea name="target.summary"></textarea>
                          <p class="help">Pick a memorable or descriptive name for this data system, so that other operators can determine when to use it.</p>
                      </div>
                    </div>

                    <div class="field">
                      <div class="x3"><label for="target.compression">Archive Compression</label></div>
                      <div class="x9">
                        <select name="target.compression">
                          <option value="bzip2">bzip2</option>
                          <option value="none">No Compression</option>
                        </select>
                        <p class="help">What type of compression should SHIELD use to reduce the size of backup archives?  <em>bzip2</em> results in smaller archives, but may substantially increase time-to-backup (especially for large data sets).</p>
                      </div>
                    </div>

                    <div class="field required" data-field="target.plugin" data-type="selection">
                      <div class="x3"><label for="target.plugin">Plugin</label></div>
                      <div class="x9">
                        <select name="target.plugin">
                          <option></option>
                          [[ $.each(AEGIS.plugins('target').list, function (i, plugin) { ]]
                          <option value="[[= plugin.id ]]">[[= h(plugin.label) ]]</option>
                          [[ }); ]]
                        </select>
                      </div>
                    </div>

                    <div class="redraw target">
                    [[ include('do-configure-target-plugin', _); ]]
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>[[# }}} ]]
        </div>

        <div data-step="3" class="cloud-storage" data-mode="[[= stores.length == 0 ? 'create' : 'choose' ]]">
          [[ if (stores.length > 0) { ]]
          <div data-mode="choose">[[# {{{ ]]
            <h2><span>Configure a New Backup Job</span>Choose Cloud Storage</h2>
            <div class="c12 band">
              <div class="x9">
                <table class="lean selectable choose store">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Type</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    [[ $.each(stores, function (i, store) { ]]
                    <tr class="[[ if (!store.healthy) { ]]fail[[ } else { ]]ok[[ } ]]"
                        data-store-uuid="[[= store.uuid ]]">
                      <td class="name">
                        <img src="i/shield-[[= store.healthy ? 'ok' : 'fail' ]].svg">
                        [[= h(store.name) ]]
                        [[ if (store.global) { ]]<span class="tag">global</span>[[ } ]]
                      </td>
                      <td>[[= h(store.plugin) ]]</td>
                      <td class="notes">
                        [[= md(store.summary) ]]
                      </td>
                    </tr>
                    [[ }); ]]
                    <tr><td colspan="3" rel="new">Define a new system...</td></tr>
                  </tbody>
                </table>
                <div class="buttons">
                  <button rel="prev">◀ Back to <span>Data System</span></button>
                  <button rel="next">Next up: <span>Job Details</span> ▶</button>
                </div>
              </div>
              <div class="x3 lean">
                <div class="side-help">Select where you'd like to store your backup archives. You can choose from existing storage systems, or configure a new one.</div>
              </div>
            </div>
          </div>[[# }}} ]]
          [[ } ]]
          <div data-mode="create">[[# {{{ ]]
            <form class="new-form1">
              <h2><span>Configure a New Backup Job</span>Define a New Cloud Storage System</h2>
              <div class="c12 band">
                <div class="x9">
                  <div class="c12">
                    <div class="field required" data-field="store.name" data-type="string">
                      <div class="x3"><label for="store.name">Name</label></div>
                      <div class="x9">
                        <input type="text" name="store.name"
                               placeholder="Name Your Storage System">
                        <span class="errors">
                          <span data-error="missing">Please name your new cloud storage system.</span>
                        </span>
                        <p class="help">Pick a memorable or descriptive name for this storage system, so that other operators can determine when to use it.</p>
                      </div>
                    </div>

                    <div class="field">
                      <div class="x3"><label for="store.summary">Notes</label></div>
                      <div class="x9">
                        <textarea name="store.summary"></textarea>
                        <p class="help">Pick a memorable or descriptive name for this storage system, so that other operators can determine when to use it.</p>
                      </div>
                    </div>

                    <div class="field required" data-field="store.threshold" data-type="size">
                      <div class="x3"><label for="store.threshold">Threshold</label></div>
                      <div class="x9">
                        <input type="text" name="store.threshold"
                               placeholder="i.e. 10G, 500M, etc.">
                        <span class="errors">
                          <span data-error="missing">Please provide a threshold of space usage for this cloud storage system.</span>
                        </span>
                        <p class="help">A threshold allows SHIELD to determine when storage is getting "too full" for comfort, and notify accordingly.</p>
                      </div>
                    </div>

                    <div class="field required" data-field="store.plugin" data-type="selection">
                      <div class="x3"><label for="store.plugin">Plugin</label></div>
                      <div class="x9">
                        <select name="store.plugin">
                          <option></option>
                          [[ $.each(AEGIS.plugins('store').list, function (i, plugin) { ]]
                          <option value="[[= plugin.id ]]">[[= h(plugin.label) ]]</option>
                          [[ }); ]]
                        </select>
                      </div>
                    </div>

                    <div class="redraw store">
                    [[ include('do-configure-store-plugin', _); ]]
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>[[# }}} ]]
        </div>

        <div data-step="4">
          <form class="new-form1">
          <h2><span>Configure a New Backup Job</span>Job Details</h2>
          <div class="c12 band">
            <div class="x9">
              <div class="c12">
                <div class="field required" data-field="job.name" data-type="string">[[# name {{{ ]]
                  <div class="x3"><label for="job.name">Name</label></div>
                  <div class="x9">
                    <div class="error"></div>
                    <input type="text" name="job.name" placeholder="Name Your Backup Job">
                    <span class="errors">
                      <span data-error="missing">Please provide a name for ths backup job.</span>
                    </span>
                    <p class="help">A descriptive name for this backup job.</p>
                  </div>
                </div>[[# }}} ]]
            <div class="field">[[# schedule {{{ ]]
              <div class="x3"><label>Schedule</label></div>
              <div class="x9">
                <div class="error"></div>
                <div class="scheduling">
                  <ul class="optgroup">[[#
                    ]]<li data-subform="schedule-hourly"  data-retain="4">Hourly</li>[[#
                    ]]<li data-subform="schedule-daily"   data-retain="14">Daily</li>[[#
                    ]]<li data-subform="schedule-weekly"  data-retain="36">Weekly</li>[[#
                    ]]<li data-subform="schedule-monthly" data-retain="90">Monthly</li>
                  </ul>

                  <div id="schedule-hourly" class="subform">
                    <div>Every <input name="hourlyn" class="num" type="text" value="1"> hour(s)</div>
                    <div>from <input name="hourlyat" class="time" type="text" value="12:15"> <ul class="ampm optgroup">[[= optgroup(['am', 'pm']) ]]</div>
                  </div>

                  <div id="schedule-daily" class="subform">
                    <div>at <input name="dailyat" class="time" type="text" value="3:00"> <ul class="ampm optgroup">[[= optgroup(['am', 'pm']) ]]</div>
                  </div>

                  <div id="schedule-weekly" class="subform">
                    <div>on <ul class="wday optgroup">[[= optgroup(['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']) ]]</ul></div>
                    <div>at <input name="weeklyat" class="time" type="text" value="4:15"> <ul class="ampm optgroup">[[= optgroup(['am', 'pm']) ]]</div>
                  </div>

                  <div id="schedule-monthly" class="subform">
                    <div>on the <input name="monthlynth" class="num" type="text" value="1st">
                         <ul class="mday optgroup">[[= optgroup(['day', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']) ]]</ul></div>
                    <div>at <input name="monthlyat" class="time" type="text" value="5:30"> <ul class="ampm optgroup">[[= optgroup(['am', 'pm']) ]]</div>
                  </div>

                  <p class="help">How often would you like the backup to be performed?</p>
                </div>
              </div>
            </div>[[# }}} ]]
            <div class="field">[[# paused {{{ ]]
              <div class="x3"><label for="job.paused">Paused</label></div>
              <div class="x9">
                <label for="cb-job.paused" class="switch">
                  <input id="cb-job.paused" name="job.paused" type="checkbox"><span class="slider round"></span>
                </label>
                <p class="help">Paused jobs will not be run by the SHIELD job scheduler, but can still be run manually.</p>
              </div>
            </div>
          [[# }}} ]]
            <div class="field">[[# retention {{{ ]]
              <div class="x3"><label for="job.keep_days">Retention</label></div>
              <div class="x9">
                <input type="text" size="3" name="job.keep_days" /> days
                <p class="help">How long should SHIELD keep each backup archive?</p>
              </div>
            </div>[[# }}} ]]
            <div class="field required">[[# encryption {{{ ]]
              <div class="x3"><label for="job.randomize_keys">Randomize Encryption Keys</label></div>
              <div class="x9">
                <label for="cb-job.randomize_keys" class="switch">
                  <input id="cb-job.randomize_keys" name="job.randomize_keys" type="checkbox" checked><span class="slider round"></span>
                </label>
                <p class="help">For increased security, SHIELD randomizes the encryption key used for each archive it creates.  This helps to defeat statistical attacks against encrypted archives for data sets that change very little.</p>
              </div>
            </div>[[# }}} ]]
              </div>
            </div>
          </div>
          <div class="c12 band">
          </div>
          <div class="c12 band">
            <div class="x9 r2 buttons">
              <button rel="prev">◀ Back to <span>Cloud Storage</span></button>
              <button rel="next">Next up: <span>Review</span> ▶</button>
            </div>
          </div>
          </form>
        </div>

        <div data-step="5" class="review"></div>
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:do-configure-target-plugin"><!-- {{{ -->
      [[#
        {do-configure-target-plugin} - Target Plugin Selection (Sub)Form

        This fragment template exists so that we can redraw it when selections
        are made.

      ]]
      <div class="field required" data-field="target.agent">
        <div class="x3"><label for="target.agent">Agent</label></div>
        <div class="x9">
          [[ if (!_.selected_target_plugin) { ]]
          <p class="awaiting-selection">A list of suitable SHIELD Agents will appear here once you select a target plugin.</p>
          [[ } else { ]]
          <select name="target.agent">
            <option></option>
            [[ $.each(AEGIS.plugins('target').agents[_.selected_target_plugin], function (i, agent) { ]]
              <option value="[[= h(agent.address) ]]">[[= h(agent.name) ]] - [[= h(agent.address) ]] (legacy ssh)</option>
            [[ }); ]]
          </select>
          <p class="help">The SHIELD Agent will be responsible for executing the programs and processes that will back up and restore data for this system.</p>
          [[ } ]]
        </div>
      </div>

      [[ if (_.selected_target_plugin && _.selected_target_agent) { ]]
        [[ var plugin = AEGIS.agent(_.selected_target_agent).metadata.plugins[_.selected_target_plugin]; ]]
        <div class="l1 x10"><h3><strong>[[= h(plugin.name) ]]</strong> Properties</h3></div>
        [[ include('plugin-configuration-form', { prefix: 'target.config.', plugin: plugin }); ]]
        <div class="x12 buttons">
          <button rel="prev">◀ Back to <span>Start</span></button>
          <button rel="next">Next up: <span>Cloud Storage</span> ▶</button>
        </div>
        [[ } else { ]]
        <div class="x12 buttons">
          <button rel="prev">◀ Back to <span>Start</span></button>
        </div>
        [[ } ]]
    <!-- }}} --></script>
    <script type="text/html" id="template:do-configure-store-plugin"><!-- {{{ -->
      [[#
        {do-configure-store-plugin} - Target Plugin Selection (Sub)Form

        This fragment template exists so that we can redraw it when selections
        are made.

      ]]
      <div class="field required" data-field="store.agent" data-type="selection">
        <div class="x3"><label for="store.agent">Agent</label></div>
        <div class="x9">
          [[ if (!_.selected_store_plugin) { ]]
          <p class="awaiting-selection">A list of suitable SHIELD Agents will appear here once you select a store plugin.</p>
          [[ } else { ]]
          [[ console.log('selected store plugin %s', _.selected_target_plugin); ]]
          <select name="store.agent">
            <option></option>
            [[ $.each(AEGIS.plugins('store').agents[_.selected_store_plugin], function (i, agent) { ]]
              <option value="[[= h(agent.address) ]]">[[= h(agent.name) ]] - [[= h(agent.address) ]] (legacy ssh)</option>
            [[ }); ]]
          </select>
          <p class="help">The SHIELD Agent will be responsible for executing store-specific operations, like archive purges and storage health checks.</p>
          [[ } ]]
        </div>
      </div>

      [[ if (_.selected_store_plugin && _.selected_store_agent) { ]]
        [[ var plugin = AEGIS.agent(_.selected_store_agent).metadata.plugins[_.selected_store_plugin]; ]]
        <div class="l1 x10"><h3><strong>[[= h(plugin.name) ]]</strong> Properties</h3></div>
        [[ include('plugin-configuration-form', { prefix: 'store.config.', plugin: plugin }); ]]
        <div class="x12 buttons">
          <button rel="prev">◀ Back to <span>Data System</span></button>
          <button rel="next">Next up: <span>Job Details</span> ▶</button>
        </div>
        [[ } else { ]]
        <div class="x12 buttons">
          <button rel="prev">◀ Back to <span>Data System</span></button>
        </div>
        [[ } ]]
    <!-- }}} --></script>
    <script type="text/html" id="template:do-configure-review"><!-- {{{ -->
      [[#
        {do-configure-review} - Target Plugin Selection (Sub)Form

        This fragment template exists so that we can redraw it when the final
        review is performed.

      ]]
            <h2><span>Configure a New Backup Job</span>Review Your Selections</h2>
            <div class="summary-section">
              <div class="c12 band">
                <div class="x2"><label>Data System</label></div>
                <div class="x7">
                  <p class="selected-elsewhere">
                  [[ if (!_.target.uuid) { ]]<span class="tag">NEW</span>[[ } ]]
                  [[= h(_.target.name) ]] ([[= h(_.target.plugin) ]])
                  <a class="change-me" href="step:2">change</a></p>
                </div>
              </div>

              <div class="c12 band">
                <div class="x2"><label>Cloud Storage</label></div>
                <div class="x7">
                  <p class="selected-elsewhere">
                  [[ if (!_.store.uuid) { ]]<span class="tag">NEW</span>[[ } ]]
                  [[= h(_.store.name) ]] ([[= h(_.store.plugin) ]])
                  <a class="change-me" href="step:3">change</a></p>
                </div>
              </div>

              <div class="c12 band">
                <div class="x2"><label>Schedule</label></div>
                <div class="x7">
                  <p class="selected-elsewhere">runs [[= h(_.job.schedule) ]][[ if (_.job.paused) { ]] (paused)[[ } ]]
                  <a class="change-me" href="step:4">change</a></p>
                </div>
              </div>

              <div class="c12 band">
                <div class="x2"><label>Retention</label></div>
                <div class="x7">
                  <p class="selected-elsewhere">keep [[= pluralize(_.job.keep_days, 'day') ]] of backup archives
                  <a class="change-me" href="step:4">change</a></p>
                </div>
              </div>

              <div class="c12 band">
                <div class="x2"><label>Encryption Keys</label></div>
                <div class="x7">
                  <p class="selected-elsewhere">[[ if (_.job.fixed_key) { ]]fixed[[ } else { ]]randomized[[ } ]]
                  <a class="change-me" href="step:4">change</a></p>
                </div>
              </div>
            </div>

            <div class="c12">
              <div class="x9 r2 buttons">
                <button rel="prev">◀ Back to <span>Job Details</span></button>
                <button class="final">Create <span>Backup Job</span></button>
              </div>
            </div>
    <!-- }}} --></script>

    <script type="text/html" id="template:plugin-form-agent-selector"><!-- {{{ -->
      [[#
        {plugin-form-agent-selector}

      ]]
      <div class="field required" data-field="[[= _.type ]].agent" data-type="selection">
        <div class="x3"><label for="[[= _.type ]].agent">Agent</label></div>
        <div class="x9">
          [[ if (!_.plugin) { ]]
          <p class="awaiting-selection">A list of suitable SHIELD Agents will appear here once you select a [[= _.type ]] plugin.</p>
          [[ } else { ]]
          [[ console.log('selected '+_.type+' plugin %s', _.plugin); ]]
          <select name="[[= _.type ]].agent">
            <option></option>
            [[ $.each(AEGIS.plugins(_.type).agents[_.plugin], function (i, agent) { ]]
              <option value="[[= h(agent.address) ]]"[[ if (_.agent == agent.address) { ]] selected[[ } ]]>[[= h(agent.name) ]] - [[= h(agent.address) ]] (legacy ssh)</option>
            [[ }); ]]
          </select>
          [[ if (_.type == 'store') { ]]
          <p class="help">The SHIELD Agent will be responsible for executing store-specific operations, like archive purges and storage health checks.</p>
          [[ } else { ]]
          <p class="help">The SHIELD Agent will be responsible for executing the programs and processes that will back up and restore data for this system.</p>
          [[ } ]]
          [[ } ]]
        </div>

        [[ if (_.agent) { ]]
          [[ var plugin = AEGIS.agent(_.agent).metadata.plugins[_.plugin]; ]]
          <div class="l1 x10"><h3>Plugin Properties ([[= h(plugin.name) ]])</h3></div>
          [[ include('plugin-configuration-form', {
               prefix: _.type+'.config.',
               plugin: plugin,
               config: _.config
             }); ]]
          <div class="x12 buttons">
            <button class="final">Save Changes</button>
          </div>
        [[ } ]]

      </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:plugin-configuration-form"><!-- {{{ -->
      [[#
        {plugin-configuration-form} - Store / Target Plugin Configuration Form

        This template takes two parameters:

          plugin: The plugin metadata from the Agent, as-is.
          config: The current plugin configuration.

      ]]
      [[
        if (!(_.config)) { _.config = {}; }
        if (!(_.prefix)) { _.prefix = ''; }

        var esc = function (s) { return s.replace(/`([^`]*)`/g, '<tt>$1</tt>'); }
      ]]
      [[ if (!_.plugin.fields || _.plugin.fields.length == 0) { ]]
        <div class="l3 x9 no-data">This plugin does not require any specific configuration.  Hooray!</div>
      [[ } else { ]]
      [[ $.each(_.plugin.fields, function (i, field) { ]]
        <div class="field[[ if (field.required) { ]] required[[ } ]]" data-field="[[= _.prefix ]][[= field.name ]]" data-type="[[= field.type ]]">
          <div class="x3">
            <label for="[[= _.prefix ]][[= field.name ]]">[[= esc(h(field.title)) ]][[ if (!field.required) { ]] <span>(optional)</span>[[ } ]]</label>
          </div>
          <div class="x9 plugin[[= i ]]th">
            [[ switch (field.type) {
               default: /* "string" */ ]]
              <input type="text" name="[[= _.prefix ]][[= field.name ]]"[[ if (field.default) { ]] placeholder="[[= field.default ]]"[[ } ]] value="[[= _.config[field.name] || '' ]]">
              [[ break;

               case "password": ]]
              <div class="smudge"><span>show</span><input type="password" name="[[= _.prefix ]][[= field.name ]]" [[ if (field.default) { ]] placeholder="[[= field.default ]]"[[ } ]] value="[[= _.config[field.name] || '' ]]"></div>
              [[ break;

               case "bool": ]]
              <label for="cb-[[= field.name ]]" class="switch">
                <input id="cb-[[= field.name ]]" name="[[= _.prefix ]][[= field.name ]]" type="checkbox"[[ if (_.config[field.name]) { ]] checked[[ } ]]><span class="slider round"></span>
              </label>
              [[ break;

               case "enum": ]]
               [[ value = (field.name in _.config ? _.config[field.name] : null); ]]
              <select>
                <option value="">[[ if (field.default) { ]][[= field.default ]][[ } ]]</option>
                [[ for (var n = 0; n < field.enum.length; n++) { ]]
                <option value="[[= field.enum[n] ]]"[[ if (value == field.enum[n]) { ]] selected[[ } ]]>[[= h(field.enum[n]) ]]</option>
                [[ } ]]
              </select>
              [[ break;

               } ]]

            <span class="errors">
              <span data-error="missing">Please provide a value for this plugin configuration option.</span>
            [[ if (field.type == "port") { ]]
              <span data-error="invalid">Please supply a valid port number, between 1 and 65535 (inclusive).</span>
            [[ } else if (field.type == "abspath") { ]]
              <span data-error="invalid">Please supply an absolute filesystem path, starting with a forward slash.</span>
            [[ } ]]
            </span>
            [[ if (field.help || field.example) { ]]
            <p class="help">
            [[ if (field.help) { ]][[= esc(h(field.help)) ]][[ } ]]
            [[ if (field.help && field.example) { ]]<br>[[ } ]]
            [[ if (field.example) { ]]For example: <span class="example">[[= esc(h(field.example)) ]]</span>[[ } ]]
            </p>
            [[ } ]]
          </div>
        </div>
      [[ }); ]]
      [[ } ]]
    <!-- }}} --></script>

    <script type="text/html" id="template:systems"><!-- {{{ -->
      [[#
        {systems} template

        Renders all targets visible to / manageable by the current user.
      ]]
      [[ var view = localStorage.getItem('view-preference') || 'card-view'; ]]
      [[ var systems = AEGIS.systems({ tenant: AEGIS.current.uuid }); ]]
      <div class="gutter blk switch-me [[= view ]]">
        [[ if (AEGIS.is('tenant', 'engineer')) { ]]
          <a class="new" href="#!/do/configure">Configure a New Backup Job&raquo;</a>
        [[ } ]]
        [[ if (systems.length == 0) { ]]
          <h2>Protected Data Systems</h2>
          <div class="no-data">You have not yet configured any data systems to protect.</div>
        [[ } else { ]]
          <h2>Protected Data Systems
            <ul class="switcher">
              <li><a href="switch:card-view" title="Card-based View"><img src="/i/cards.png" /></a></li>
              <li><a href="switch:lean-view" title="Lean Table View"><img src="/i/table.png" /></a></li>
            </ul>
          </h2>
          <table class="lean sortable">
            <thead>
              <tr>
                <th class="sortable">Name</th>
                <th>Schedule</th>
                <th>Retention</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              [[ $.each(systems, function (i, target) { ]]
              <tr class="[[ if (!target.healthy) { ]]fail[[ } else { ]]ok[[ } ]]">
                <td class="name">
                  <a href="#!/systems/system:uuid:[[= target.uuid ]]">
                    <img src="i/shield-[[= target.healthy ? 'ok' : 'fail' ]].svg">
                    [[= h(target.name) ]]
                  </a>
                </td>
                <td class="schedule">
                  [[ $.each(AEGIS.jobs({ system: target.uuid }), function (j, job) { ]]
                  runs [[= h(job.schedule) ]]<br>
                  [[ }); ]]
                </td>
                <td class="retain">
                  [[ $.each(AEGIS.jobs({ system: target.uuid }), function (j, job) { ]]
                  [[= pluralize(job.keep_n, 'backup') ]] / [[= pluralize(job.keep_days, 'day') ]]<br>
                  [[ }); ]]
                </td>
                <td><a href="#!/systems/system:uuid:[[= target.uuid ]]">view details</a></td>
              </tr>
              [[ }); ]]
            </tbody>
          </table>

          <div class="cards">
            [[ $.each(systems, function (i, target) { ]]
            <div class="job card [[ if (!target.healthy) { ]]fail[[ } else { ]]ok[[ } ]]">
              <a href="#!/systems/system:uuid:[[= target.uuid ]]">
              <img src="i/shield-[[= target.healthy ? 'ok' : 'fail' ]].svg">
              <h3>[[= h(target.name) ]]</h3>
              <ul class="details">
                <li>[[ if (target.compression == "none") { ]]backups will <strong>not</strong> be compressed.
                    [[ } else { ]]backups will be compressed via <tt>[[= h(target.compression) ]]</tt>[[ } ]]</li>
              </ul>
              [[ $.each(AEGIS.jobs({ system: target.uuid }), function (j, job) {
                   var store = AEGIS.store(job.store_uuid);
              ]]
              <ul class="details">
                <li><strong>[[= h(job.name) ]]</strong></li>
                <li>runs [[= h(job.schedule) ]]</li>
                <li>keep [[= pluralize(job.keep_n, 'backup') ]] ([[= pluralize(job.keep_days, 'day') ]])</li>
              </ul>
              <div class="graph[[ if (!job.healthy) { ]] fail[[ } ]]">
                <div class="from">[[= h(target ? target.plugin : false) || 'unknown' ]]</div>
                <div class="bar"></div>
                <div class="to">[[= h(store ? store.name : false) || 'unknown' ]]</div>
              </div>
              [[ }); ]]
              </a>
            </div>
            [[ }); ]]
          </div>
        </div>
        [[ } ]]
    <!-- }}} --></script>
    <script type="text/html" id="template:system"><!-- {{{ -->
      [[#
        {system} template

        Renders all of the jobs and backup archives for a single target.
        Enables operators to easily see when a given system is backed up,
        and facilitates quick and easy access to restore valid archives.
      ]]
      [[
          var target = AEGIS.system(args.uuid);
      ]]
          <div class="system view gutter" data-system-uuid="[[= target.uuid ]]" data-system-name="[[= h(target.name) ]]">
            <h2 class="[[= target.healthy ? 'ok' : 'fail' ]]">
              <span>Data System</span>[[= h(target.name) ]]
              <img src="i/shield-[[= target.healthy ? 'ok' : 'fail' ]].svg">
            </h2>
            <div>[[= md(target.summary) ]]</div>

            <div class="side-by-side">
              <h3>Storage Footprint</h3>
              [[ var n = 0, used = 0;
                 $.each(AEGIS.archives({ tenant: target.tenant_uuid,
                                         system: target.uuid }),
                        function (i, archive) {
                          n++;
                          used += archive.size;
                        }); ]]
              <dl>
                <dt>Backup Archives</dt>
                <dd>[[= h(n) ]]</dd>

                <dt>Compression</dt>
                <dd>[[= h(target.compression) ]]</dd>

                <dt>Storage Used</dt>
                <dd>[[= bytes(used) ]]</dd>
              </dl>
            </div>

            <div class="side-by-side redraw">
              <h3>Configuration</h3>
              [[ if (_.config) { ]]
              <dl>
                <dt>SHIELD Agent</dt>
                <dd>[[= h(target.agent) ]]</dd>

                <dt>Target Plugin</dt>
                <dd>[[= h(target.plugin) ]]</dd>

                [[   $.each(_.config, function (i, kv) { ]]
                <dt>[[= h(kv.label) ]]</dt>
                <dd>[[ if (kv.redacted) { ]]<span class="redacted">REDACTED</span>[[
                } else if (kv.value)    { ]][[= h(kv.value) ]][[
                } else if (kv.default)  { ]]<span class="not-configured">[[= h(kv.default) ]]</span>[[
                } else                  { ]]<span class="not-configured">not configured.</span>[[
                } ]]</dd>
                [[   }); ]]
              </dl>
              [[ } else { ]]
              <span class="deferred">fetching configuration...</span>
              [[ } ]]
            </div>

            [[ var archives = AEGIS.archives({ tenant: target.tenant_uuid, system: target.uuid }); ]]
            [[ if (archives.length > 0) { ]]
              [[ archives = $.sortBy(archives, 'created_at').reverse(); ]]
              [[ var show = Scratch('archives:all') ? archives : archives.slice(0, 4); ]]
            <h2>Backup Archives</h2>
            <table class="lean sortable">
              <thead><tr>
                <th class="sortable">UUID</th>
                <th class="sortable">Date</th>
                <th class="sortable">Size</th>
                <th class="sortable">Store</th>
                <th>Status</th>
                <th></th>
              </tr></thead>
              <tbody>
                [[ $.each(show, function (i, archive) { ]]
                <tr data-archive-uuid="[[= archive.uuid ]]">
                  <td class="uuid">[[= archive.uuid.substr(0,8) ]]</td>
                  <td class="date" data-sort-as="number" data-sort="[[= archive.taken_at ]]">
                    [[= strftime("%Y-%m-%d %H:%M%P", archive.taken_at) ]]<br>
                    ([[= duration(tdiff(archive.taken_at, new Date())) ]] ago)
                  </td>
                  <td data-sort-as="number" data-sort="[[= archive.size ]]">[[= bytes(archive.size) ]]</td>
                  [[ var store = AEGIS.store(archive.store_uuid); ]]
                  <td>[[= store.name ]] ([[= store.plugin ]])</td>
                  <td>[[= archive.status ]]</td>
                  <td><a href="restore:[[= archive.uuid ]]">restore</a></td>
                </tr>
                [[ }); ]]
              </tbody>
            </table>
            [[ if (show.length != archives.length) { ]]
            <a class="load-more archives" href="">More Archives</a>
            [[ } ]]
          [[ } ]]

            <h2>Scheduled Backups</h2>
            <table class="lean sortable">
              <thead>
                <tr>
                  <th class="sortable">Name</th>
                  <th class="sortable">Schedule</th>
                  <th class="sortable">Cloud Storage</th>
                  <th class="sortable">Retention</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                [[ $.each(AEGIS.jobs({ system: target.uuid }), function (i, job) {
                     var store = AEGIS.store(job.store_uuid);
                ]]
                <tr>
                  <td class="name [[= job.healthy ? 'ok' : 'fail' ]]">
                    <img src="i/shield-[[= job.healthy ? 'ok' : 'fail' ]].svg">
                    [[= h(job.name) ]]
                  </td>
                  <td class="schedule" data-sort="[[= job.keep_n / job.keep_days * 1000 ]]" data-sort-as="number">
                    [[= h(job.schedule) ]]
                  </td>
                  <td class="name [[= store.healthy ? 'ok' : 'fail' ]]">
                    <img src="i/shield-[[= store.healthy ? 'ok' : 'fail' ]].svg">
                    [[= h(store.name) ]]
                  </td>
                  <td class="retain" data-sort="[[= job.keep_n ]]" data-sort-as="number">
                    [[= pluralize(job.keep_n, 'backup') ]] / [[= pluralize(job.keep_days, 'day') ]]<br>
                  </td>
                    <td> <a href="delete:[[= job.uuid ]]">delete</a> | <a href="run:[[= job.uuid ]]">run</a> | 
                          [[ if (job.paused == 0) { ]]
                            <a href="pause:[[= job.uuid ]]">pause</a>
                          [[ } else { ]]
                            <a href="unpause:[[= job.uuid ]]">unpause</a>
                          [[ } ]]
                    </td>
                </tr>
                [[ }); ]]
              </tbody>
            </table>

            <h2>Timeline</h2>
            <div class="paginate" data-url="/v2/tenants/[[= AEGIS.current.uuid ]]/systems/[[= target.uuid ]]?before={oldest}" data-oldest="[[= new Date().getTime() ]]">
              <div class="timeline results">
                [[ $.each($.sortBy(AEGIS.tasks({ system: target.uuid }), 'requested_at').reverse(), function (i, task) { ]]
                [[ include('timeline-entry', task); ]]
                [[ }); ]]
              </div>
              <div class="loading">Fetching more tasks...</div>
              <a class="load-more tasks" href="">More Tasks...</a>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:timeline-entry"><!-- {{{ -->
      [[#
        {timeline-entry} template

        Renders a single entry in the System View Timeline, for use
        in pagination logic and partial rendering (infini-scroll)
      ]]
      [[ _.is = {};
         _.is.handled  = (_.stopped_at
                       && _.status != 'done'
                       && _.ok);
         if (_.op && !_.type) {
           _.type = _.op;
         }
      ]]
      <div class="event [[= _.type ]] [[= (_.status == 'done' ? 'ok' : _.status) ]][[ if (_.notes != "") { ]] noted[[ } ]][[ if (_.is.handled) { ]] handled[[ } ]]" data-task-uuid="[[= _.uuid ]]"[[ if (_.archive) { ]] data-archive-uuid="[[= _.archive.uuid ]]" data-archive-taken="[[= _.started_at ]]"[[ } ]]>
        <ul>
          <li class="date">[[ if (_.started_at == "") { ]]
            <em>scheduled / pending</em>
          [[ } else { ]]
            [[= strftime("%b %d %Y", _.started_at) ]]
          [[ } ]]</li>
          [[ if (_.type != "backup") { ]]
            <li class="tag">[[= _.type ]]</li>
          [[ } ]]
          [[ if (_.type == "backup") { ]]
            [[ if (_.owner == "system") { ]]
            <li class="desc">[[= h(lens.maybe(_.archive && _.archive.schedule, 'Scheduled Backup')) ]]</li>
            <li class="meta">run automatically per job schedule at [[= strftime("%l:%M%P", _.requested_at) ]]</li>
            [[ } else { ]]
            <li class="desc">Ad Hoc Backup</li>
            <li class="meta">initiated by [[= h(_.owner) ]] at [[= strftime("%l:%M%P", _.requested_at) ]]</li>
            [[ } ]]
          [[ } else if (_.type == "restore") { ]]
            <li class="desc">Manual Restore</li>
            <li class="meta">initiated by [[= h(_.owner) ]] at [[= strftime("%l:%M%P", _.requested_at) ]]</li>
          [[ } else if (_.type == "purge") { ]]
            <li class="desc">Purge Expired Archive</li>
            <li class="meta">...</li>
          [[ } else { ]]
            <li class="desc">[[= h(_.type) ]] Task</li>
          [[ } ]]
          [[ if (_.notes != "") { ]]
          <li class="note"><strong>Note:</strong> [[= h(_.notes) ]]</li>
          [[ } ]]
          <li class="expand"[[ if (Scratch('task:'+_.uuid) == 'open') { ]] style="display: none"[[ } ]]><a href="task:[[= _.uuid ]]">full task log</a></li>
        </ul>
        [[ if (Scratch('task:'+_.uuid) == 'open') { ]]
          <div class="task" style="display: block;">
          [[ include('task', { task: _ }); ]]
          </div>
        [[ } else { ]]
          <div class="task"></div>
        [[ } ]]
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:task"><!-- {{{ -->
      [[#
        {task} template

        Displays the details of a single task, including the task log.
        Optionally, if this is being displayed in the {system} view,
        also display a big RESTORE button in the task output.
      ]]
<pre class="task-[[= _.task.status ]][[ if (_.task.ok) { ]] override[[ } ]]"><code><div>
<button class="close" rel="close">X</button>[[ if (_.task.stopped_at) { ]]
<button class="annotate" rel="annotate:[[= _.task.uuid ]]">Annotate</button>[[ if (_.restorable) { ]]<button class="restore" rel="restore:[[= _.task.uuid ]]">Restore</button>[[ } ]]
<form class="annotate"[[ if (Scratch('anno:'+_.task.uuid)) { ]] style="display: block;"[[ } ]]>
<input type="hidden" name="uuid" value="[[= _.task.uuid ]]" />
[[ if (_.task.status == "failed") { ]]
<p><input type="checkbox" name="disposition"
            id="annotask-ok"[[ if (_.task.ok) { ]] checked[[ } ]]><label for="annotask-ok">Nothing to worry about</label></p>
[[ } ]]
<p><textarea name="notes" id="notes"
            placeholder="no notes recorded yet...">[[= h(lens.maybe(_.task.notes, '')) ]]</textarea></p>
<button>Save</button>
</form>[[ } ]]

</div><em>task <em>[[= _.task.uuid ]]</em></em>
<em>[[= _.task.type ]] task[[ if (_.task.started_at != "") { ]] started <em>[[= strftime("%c", _.task.started_at) ]][[ } ]]</em>[[
if (_.task.type == "purge") { ]]
purging archive <em>[[= _.task.archive_uuid ]]</em>[[
} else if (_.task.type == "restore") { ]]
restoring from archive <em>[[= _.task.archive_uuid ]]</em>[[
} ]]
initiated by <em>[[= h(_.task.owner) ]]</em> at <em>[[= strftime("%c", _.task.requested_at) ]]</em></em>

[[= h(_.task.log) ]]

<em>[[ if (_.task.stopped_at > _.task.started_at && _.task.status != "pending") {
]]task ran for <em>[[= duration(tdiff(_.task.started_at, _.task.stopped_at)) ]]</em>
[[

if (_.task.type == 'backup') {
if (_.task.archive_uuid != "") {
    ]]generated archive <em>[[= _.task.archive_uuid ]]</em>
for job <em>[[= _.task.job_uuid ]]</em>
[[
} else {
]]no archive was generated.
[[
}
} ]][[= _.task.type ]] task finished at <em>[[= strftime("%c", _.task.stopped_at) ]]</em> with status <em>[[= _.task.status ]]</em>
[[
}
]]</em></code></pre>
    <!-- }}} --></script>

    <script type="text/html" id="template:stores"><!-- {{{ -->
      [[#
        {stores} template

        Renders the currently defined (visible) storage endpoints,
        and in some cases allows for user-management of their configurations.
      ]]
      [[ var view = localStorage.getItem('view-preference') || 'card-view'; ]]
      [[ var stores = _.stores ? _.stores : AEGIS.stores({ tenant: AEGIS.current.uuid,
                                                           global: true }); ]]
          <div class="gutter blk switch-me [[= view ]]">
            [[ if ((_.admin  && AEGIS.is('engineer'))
                || (!_.admin && AEGIS.is('tenant', 'engineer'))) { ]]
            <a class="new" href="#!/[[= _.admin ? 'admin/' : '' ]]stores/new">Configure a New Cloud Storage System&raquo;</a>
            [[ } ]]
            [[ if (_.admin) { ]]
              <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
              <h2><strong>Global</strong> Cloud Storage Systems[[ if (stores.length > 0) { ]]
                <ul class="switcher">
                  <li><a href="switch:card-view" title="Card-based View"><img src="/i/cards.png" /></a></li>
                  <li><a href="switch:lean-view" title="Lean Table View"><img src="/i/table.png" /></a></li>
                </ul>
              [[ } ]]</h2>
              <p class="notice">These are <strong>global</strong> definitions; these storage
              configurations can be used by any tenant, although they will be unable to see
              any of the sensitive details.</p>
            [[ } else { ]]
            <h2>Cloud Storage Systems[[ if (stores.length > 0) { ]]
                <ul class="switcher">
                  <li><a href="switch:card-view" title="Card-based View"><img src="/i/cards.png" /></a></li>
                  <li><a href="switch:lean-view" title="Lean Table View"><img src="/i/table.png" /></a></li>
                </ul>
              [[ } ]]</h2>
            [[ } ]]

            [[ if (stores.length == 0) { ]]
            <div class="no-data">No Cloud Storage Systems have been configured yet.</div>
            [[ } else { ]]
            <table class="lean sortable">
              <thead>
                <tr>
                  <th class="sortable">Name</th>
                  <th class="sortable">Type</th>
                  <th>Notes</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                [[ $.each(stores, function (i, store) { ]]
                <tr class="[[ if (!store.healthy) { ]]fail[[ } else { ]]ok[[ } ]]">
                  <td class="name">
                    <a href="#!/[[= _.admin ? 'admin/' : '' ]]stores/store:uuid:[[= store.uuid ]]">
                      <img src="i/shield-[[= store.healthy ? 'ok' : 'fail' ]].svg">
                      [[= h(store.name) ]]
                    </a>
                    [[ if (store.global) { ]]<span class="tag">global</span>[[ } ]]
                  </td>
                  <td class="type">[[= h(store.plugin) ]]</td>
                  <td class="notes">
                    [[ if (store.summary) { ]]
                      [[= md(store.summary) ]]
                    [[ } else { ]]
                      <div class="no-data">No notes provided.  Too bad.</div>
                    [[ } ]]
                  </td>
                  <td><a href="#!/[[= _.admin ? 'admin/' : '' ]]stores/store:uuid:[[= store.uuid ]]">view details</a></td>
                </tr>
                [[ }); ]]
              </tbody>
            </table>

            <div class="cards">
            [[ $.each(stores, function (i, store) { ]]
            <div class="store card [[ if (!store.healthy) { ]]fail[[ } else { ]]ok[[ } ]]">
              [[ if (store.global) { ]]<span class="type">Shared</span>[[ } ]]
              <a href="#!/[[= _.admin ? 'admin/' : '' ]]stores/store:uuid:[[= store.uuid ]]">
              <img src="i/shield-[[= store.healthy ? 'ok' : 'fail' ]].svg">
              <h3>[[= h(store.name) ]]</h3>
              <div class="notes">[[ if (store.summary) { ]]
                [[= md(store.summary) ]]
              [[ } else { ]]
                <div class="no-data">No notes provided.  Too bad.</div>
              [[ } ]]</div>
              <div class="graph[[ if (!store.healthy) { ]] fail[[ } ]]">
                <div class="to">[[= h(store.plugin) ]]</div>
              </div>
              </a>
            </div>
            [[ }); ]]
            </div>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:store"><!-- {{{ -->
      [[#
        {store} template

        Renders a single storage endpoint configuration, including its
        usage information and provide management capabilities.
      ]]
      [[
         var store = AEGIS.store(_.uuid);
      ]]
          <div class="gutter blk store view">
            <a class="breadcrumb" href="#!/[[= _.admin ? 'admin/' : '' ]]stores">&laquo; Back to Cloud Storage Systems</a>
            <h2>[[= store.name ]][[ if (store.global) { ]]<span class="tag">global</span>[[ } ]]</h2>

            [[ if (_.admin || !store.global) { ]]
              [[ if ((_.admin && AEGIS.is('engineer'))
                  || (!_.admin && AEGIS.is(store.tenant_uuid, 'engineer'))) { ]]
              <a class="edit"   href="#!/[[= _.admin ? 'admin/' : '' ]]stores/edit:uuid:[[= store.uuid ]]">Edit</a>
              <a class="delete" href="#!/[[= _.admin ? 'admin/' : '' ]]stores/delete:uuid:[[= store.uuid ]]">Delete</a>
              [[ } ]]
            [[ } ]]

            <div class="summary">[[= store.summary ]]</div>

            <div class="side-by-side">
              <h3>Storage Details</h3>
              <dl>
                <dt>Backup Archives</dt>
                <dd>[[= store.archive_count ]]</dd>

                <dt>Storage Used</dt>
                <dd>[[= bytes(store.storage_used) ]] / [[= bytes(store.threshold) ]]</dd>

                <dt>Daily Delta</dt>
                <dd>[[= bytes(store.daily_increase) ]]</dd>
              </dl>
            </div>

            <div class="side-by-side redraw">
              <h3>Configuration</h3>
              [[ if (_.config) { ]]
                [[ if (_.config == 'denied') { ]]
                <span class="denied">You are not authorized to view this cloud storage configuration.</span>
                [[ } else { ]]
                <dl>
                  <dt>SHIELD Agent</dt>
                  <dd>[[= store.agent ]]</dd>

                  <dt>Store Plugin</dt>
                  <dd>[[= store.plugin ]]</dd>

                  [[   $.each(_.config, function (i, kv) { ]]
                  <dt>[[= kv.label ]]</dt>
                  <dd>[[ if (kv.redacted) { ]]<span class="redacted">REDACTED</span>[[
                  } else if (kv.value)    { ]][[= kv.value ]][[
                  } else if (kv.default)  { ]]<span class="not-configured">[[= kv.default ]]</span>[[
                  } else                  { ]]<span class="not-configured">not configured.</span>[[
                  } ]]</dd>
                [[   }); ]]
                </dl>
                [[ } ]]
              [[ } else { ]]
              <span class="deferred">fetching configuration...</span>
              [[ } ]]
            </div>

            [[ if (store.archives > 0) { ]]
            <div class="meter">
              <svg width="500" height="400" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <style>
                    rect.outer    { fill: #ccc; }
                    rect.fill     { fill: #0071bc; }
                    circle.marker { fill: #333; }
                    line.marker { stroke: #333; stroke-width: 1px; }

                    text.label      { font-size: 20px; font-family: sans-serif; }
                    text.size       { font-size: 40px; font-family: sans-serif; }
                    text.size tspan { font-size: 20px; font-weight: bold; }

                    g.current      .size { fill: #7ac943; }
                    g.current.warn .size { fill: orange; }
                    g.threshold    .size { fill: #0071bc; }
                    g.projected    .size { fill: #ff1d25; }
                  </style>
                </defs>

                [[# Base value of 1M, add 20% padding for spacing ]]
                [[ var total = Math.max(store.used, store.threshold, readableToBytes("1M")) * 1.2; ]]
                <rect class="outer" x="0" y="200" width="100%" height="36"></rect>
                <rect class="fill" x="2" y="202" width="[[= 100.0 * store.used / total ]]%" height="32"></rect>

                [[ if (store.threshold > store.used) { ]]
                [[# "current" marker ]]
                <g class="current" transform="translate(2)">
                  <line class="marker" x1="[[= 100.0 * store.used / total ]]%" x2="[[= 100.0 * store.used / total ]]%" y1="198" y2="53"></line>
                  <circle class="marker" cx="[[= 100.0 * store.used / total ]]%" cy="53" r="3"></circle>
                  <g transform="translate(6)">
                    <text x="[[= 100.0 * store.used / total ]]%" y="60" class="label">Current</text>
                    <text x="[[= 100.0 * store.used / total ]]%" y="100" class="size">[[= bytes(store.used) ]]</text>
                  </g>
                </g>

                [[# "threshold" marker ]]
                <g class="threshold" transform="translate(2)">
                  <line class="marker" x1="[[= 100.0 * store.threshold / total ]]%" x2="[[= 100.0 * store.threshold / total ]]%" y1="198" y2="133"></line>
                  <circle class="marker" cx="[[= 100.0 * store.threshold / total ]]%" cy="133" r="3"></circle>
                  <g transform="translate(6)">
                    <text x="[[= 100.0 * store.threshold / total ]]%" y="140" class="label">Threshold</text>
                    <text x="[[= 100.0 * store.threshold / total ]]%" y="180" class="size">[[= bytes(store.threshold) ]]</text>
                  </g>
                </g>
                [[ } else { ]]

                [[# "threshold" marker ]]
                <g class="threshold" transform="translate(2)">
                  <line class="marker" x1="[[= 100.0 * store.threshold / total ]]%" x2="[[= 100.0 * store.threshold / total ]]%" y1="198" y2="53"></line>
                  <circle class="marker" cx="[[= 100.0 * store.threshold / total ]]%" cy="53" r="3"></circle>
                  <g transform="translate(6)">
                    <text x="[[= 100.0 * store.threshold / total ]]%" y="60" class="label">Threshold</text>
                    <text x="[[= 100.0 * store.threshold / total ]]%" y="100" class="size">[[= bytes(store.threshold) ]]</text>
                  </g>
                </g>

                [[# "current" marker ]]
                <g class="current warn" transform="translate(2)">
                  <line class="marker" x1="[[= 100.0 * store.used / total ]]%" x2="[[= 100.0 * store.used / total ]]%" y1="198" y2="133"></line>
                  <circle class="marker" cx="[[= 100.0 * store.used / total ]]%" cy="133" r="3"></circle>
                  <g transform="translate(6)">
                    <text x="[[= 100.0 * store.used / total ]]%" y="140" class="label">Current</text>
                    <text x="[[= 100.0 * store.used / total ]]%" y="180" class="size">[[= bytes(store.used) ]]</text>
                  </g>
                </g>
                [[ } ]]

                [[ if (false) { ]]
                [[# "projected" marker ]]
                <g class="projected" transform="translate(-3)">
                  <line class="marker" x1="[[= 100.0 * store.projected / total ]]%" x2="[[= 100.0 * store.projected / total ]]%" y1="238" y2="293"></line>
                  <circle class="marker" cx="[[= 100.0 * store.projected / total ]]%" cy="293" r="3"></circle>
                  <g transform="translate(-6)"><text x="[[= 100.0 * store.projected / total ]]%" y="260" class="label" text-anchor="end">Projected</text>
                    <text x="[[= 100.0 * store.projected / total ]]%" y="300" class="size" text-anchor="end">[[= bytes(store.projected) ]]</text>
                  </g>
                </g>
                [[}]]
              </svg>
            </div>
          </div>
          [[ } ]]
    <!-- }}} --></script>
    <script type="text/html" id="template:stores-form"><!-- {{{ -->
      [[#
        {stores-form} template

        Renders a form for creating new storage endpoints, and
        editing existing stores.
      ]]
          <div class="gutter blk wizard2">
            [[ if (_.store) { ]]
            <a class="breadcrumb" href="#!/[[= _.admin ? 'admin/' : '' ]]stores/store:uuid:[[= _.store.uuid ]]">&laquo; Back to "[[= _.store.name ]]" Cloud Storage System</a>
            [[ } else { ]]
            <a class="breadcrumb" href="#!/[[= _.admin ? 'admin/' : '' ]]stores">&laquo; Back to Cloud Storage Systems</a>
            [[ } ]]
            <h2>[[ if (_.store) { ]]Edit[[ } else { ]]New[[ } ]] Storage System</h2>

            [[ if (false && (!_.agents || _.agents.length == 0)) { ]]
            <p class="notice failure">There are currently no Agents registered with
            this SHIELD Core; you will not be able to configure Storage Systems until
            that changes.</p>
            [[ } else { ]]
            <form class="new-form1">
              <div class="error"></div>

              <div class="c12 band">
                <div class="x9">
                  <div class="c12">
                    <div class="field required" data-field="store.name" data-type="string">
                      <div class="x3"><label for="store.name">Name</label></div>
                      <div class="x9">
                        <input type="text"
                               name="store.name"
                               [[ if (_.store && _.store.name) { ]]value="[[= _.store.name ]]"[[ } ]]
                               placeholder="Name Your Storage System">
                        <span class="errors">
                          <span data-error="missing">Please provide a name for this cloud storage system.</span>
                        </span>
                        <p class="help">Pick a memorable or descriptive name for this storage system, so that other operators can determine when to use it.</p>
                      </div>
                    </div>

                    <div class="field">
                      <div class="x3"><label for="store.summary">Notes</label></div>
                      <div class="x9">
                        <textarea name="store.summary">[[ if (_.store && _.store.summary) { ]][[= h(_.store.summary) ]][[ } ]]</textarea>
                        <p class="help">Notes can help other operators (including future you!) understand the configuration / role / purpose of this storage system.</p>
                      </div>
                    </div>

                    <div class="field required" data-field="store.threshold" data-type="size">
                      <div class="x3"><label for="store.threshold">Threshold</label></div>
                      <div class="x9">
                        <input type="text" name="store.threshold"
                               [[ if (_.store && _.store.threshold) { ]]value="[[= bytes(_.store.threshold) ]]"[[ } ]]
                               placeholder="i.e. 10G, 500M, etc.">
                        <span class="errors">
                          <span data-error="missing">Please provide a threshold of space usage for this cloud storage system.</span>
                        </span>
                        <p class="help">A threshold allows SHIELD to determine when storage is getting "too full" for comfort, and notify accordingly.</p>
                      </div>
                    </div>

                    <div class="field required" data-field="store.plugin" data-type="selection">
                      <div class="x3"><label for="store.plugin">Plugin</label></div>
                      <div class="x9">
                        <select name="store.plugin">
                          <option></option>
                          [[ $.each(AEGIS.plugins('store').list, function (i, plugin) { ]]
                          <option value="[[= plugin.id ]]"[[ if (_.store && _.store.plugin == plugin.id) { ]] selected[[ } ]]>[[= h(plugin.label) ]]</option>
                          [[ }); ]]
                        </select>
                      </div>
                    </div>

                    <div class="redraw store">
                    [[ include('plugin-form-agent-selector', $.extend({
                          type:   'store',
                          agent:  (_.store && _.store.agent  ? _.store.agent  : undefined),
                          plugin: (_.store && _.store.plugin ? _.store.plugin : undefined),
                          config: (_.store && _.store.config ? _.store.config : undefined)
                       }, _)); ]]
                    </div>
                  </div>
                </div>
              </div>
            </form>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:stores-delete"><!-- {{{ -->
      [[#
        {stores-delete}

        A modal interaction screen that requires the operator to acknowledge
        that what they are about to do will result in the destruction of
        configuration data.
      ]]
          <div class="confirm">
            <h2>Delete The <em>[[= h(_.store.name) ]]</em> Cloud Storage System?</h2>

            <p>You have requested that SHIELD remove the configuration for
            the cloud storage system "[[= h(_.store.name) ]]".  <em>This is a
            irreversible action; it cannot be undone.</em></p>

            <p class="q">Are you sure you want to delete <em>[[= h(_.store.name) ]]</em>?</p>
            <div class="a">
              <button class="safe" rel="close">No, Keep It</button>
              <button class="danger" rel="yes">Yes, Delete It</button>
            </div>
          </div>
    <!-- }}} --></script>

    <script type="text/html" id="template:tenants"><!-- {{{ -->
      [[#
        {tenants} template

        Renders the list of all tenants (for site managers)
      ]]
          <div class="gutter blk">
            [[ if (_.admin) { ]]
              <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
              <a class="new" href="#!/admin/tenants/new">Create a New Tenant &raquo;</a>
            [[ } ]]
            <h2>Tenants</h2>
            [[ if (_.tenants.length == 0) { ]]
            <div class="no-data">No Tenants have been created yet.</div>
            [[ } else { ]]
            <table class="lean sortable">
              <thead><tr>
                <th class="sortable">Name</th>
                <th></th>
              </tr></thead>
              <tbody>
                [[ $.each(_.tenants, function (i, tenant) { ]]
                <tr>
                  <td>[[= h(tenant.name) ]]</td>
                  <td><a href="#!/[[= _.admin ? 'admin/' : '' ]]tenants/edit:uuid:[[= tenant.uuid ]]">edit</a></td>
                </tr>
                [[ }); ]]
              </tbody>
            </table>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:tenants-form"><!-- {{{ -->
      [[#
        {tenants-form} template

        Renders a form for creating new tenants, and editing
        existing tenants.
      ]]
          <div class="gutter blk wizard2">
            [[ if (_.admin) { ]]
                <a class="breadcrumb" href="#!/admin/tenants">&laquo; Back to Tenants</a>
                <h2>[[ if (_.tenant) { ]]Edit[[ } else { ]]New[[ } ]] Tenant</h2>
            [[ } else { ]]
                <a class="breadcrumb" href="#!/systems">&laquo; Back to Systems</a>
                <h2> [[= h(_.tenant.name) ]] - Tenant Settings</h2>
            [[ } ]]

            <form>
              <div class="error"></div>
              <div class="c12 band">
                <div class="x9">
                  <div class="c12">
                    [[ if (_.admin) { ]]
                    <div class="field required" data-field="name" data-type="string">
                      <div class="x3"><label for="name">Name</label></div>
                      <div class="x9">
                        <input type="text"
                               name="name"
                               [[ if (_.tenant) { ]]value="[[= h(_.tenant.name) ]]"[[ } ]]
                               class="autofocus"
                               placeholder="Name Your Tenant" />
                        <span class="errors">
                          <span data-error="missing">Please provide a name for this new tenant.</span>
                        </span>
                        <p class="help">Pick a memorable or descriptive name for this tenant.</p>
                        </div>
                      </div>
                    </div>
                    [[ } ]]

                    <div class="field">
                      <div class="x3"><label for="invite">People</label></div>
                      <div class="x9">
                        <div class="widget">
                          <input type="text" name="invite" autocomplete="off"
                                 class="invite" placeholder="Invite people to join..." />

                          <table class="tenant-members lean sortable">
                            <thead><tr>
                              <th></th>
                              <th class="sortable">Display Name</th>
                              <th class="sortable">Username</th>
                              <th class="sortable">Role</th>
                            </tr></thead>
                            <tbody data-type="tenant">
                              [[ if (_.tenant) { ]]
                                [[ $.each(_.tenant.members, function (i, user) { ]]
                                <tr data-uuid="[[= user.uuid ]]" data-account="[[= h(user.account) ]]">
                                  <td><a href="banish:user"><img src="/i/delete.png"></a></td>
                                  <td>[[= h(user.name) ]]</td>
                                  <td>[[= h(user.account) ]]</td>
                                  <td><span class="role" data-role="[[= user.role ]]">
                                  [[= { admin      : "Administrator",
                                        engineer   : "Engineer",
                                        operator   : "Operator" }[user.role] ]]
                                  </span></td>
                                </tr>
                                [[ }); ]]
                              [[ } ]]
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                    <div class="x12 buttons">
                      <button class="final">[[ if (_.tenant) { ]]Save[[ } else { ]]Create[[ } ]]</button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:tenants-form-invitee"><!-- {{{ -->
      [[#
        {tenants-form-invitee} template

        Renders a table row in the invitee management UI control.
      ]]
                      <tr data-uuid="[[= _.user.uuid ]]" data-account="[[= h(_.user.account) ]]">
                        <td><a href="banish:user"><img src="/i/delete.png"></a></td>
                        <td>[[= h(_.user.name) ]]</td>
                        <td>[[= h(_.user.account) ]]</td>
                        <td><span class="role" data-role="[[= h(_.user.role) ]]">
                        [[= { admin      : "Administrator",
                              engineer   : "Engineer",
                              operator   : "Operator" }[_.user.role] ]]
                        </span></td>
                      </tr>
    <!-- }}} --></script>
    <script type="text/html" id="template:userlookup-results"><!-- {{{ -->
      [[#
        {userlookup-results} template

        Displays the "dropdown" list of user information,
        after the /v2/ui/users endpoint has fired in a
        userlookup control.
      ]]
      <div class="userlookup-results">
        <ul>
          [[ $.each(_, function (i, user) { ]]
          <li data-idx="[[= i ]]" data-uuid="[[= user.uuid ]]"><strong>[[= h(user.name) ]]</strong><p>[[= h(user.account) ]]</p></li>
          [[ }); ]]
        </ul>
      </div>
    <!-- }}} --></script>

    <script type="text/html" id="template:admin"><!-- {{{ -->
      [[#
        {admin} template

        Renders the administrator control panel.
      ]]
          <div class="gutter blk" id="admin-home">
            <h2>SHIELD Administration</h2>
            <ul>
              [[ if (AEGIS.is('manager')) { ]]
              <li><a href="#!/admin/tenants">Tenants</a>
                <p>Tenants separate and isolate subsets of your users from one another, so that
                they can neither see nor affect the data systems, or cloud storage configurations
                of one another.</p>
              </li>
              [[ } ]]

              <li><a href="#!/admin/stores">Global Storage Systems</a>
                <p>You may elect to configure some global storage systems, which can be used,
                but not modified, by all tenants; only SHIELD technicians, engineers, and
                admins are able to view and edit their configuration.</p>
              </li>

              [[ if (AEGIS.is('admin')) { ]]
              <li><a href="#!/admin/agents">Agents of SHIELD</a>
                <p>SHIELD performs backup and restore operations through <em>agents</em> that run
                on other machines.  These agents register with the SHIELD Core, and provide
                metadata that is essential to the configuration of your data protection jobs.</p>
              </li>
              <li><a href="#!/admin/auth">Authentication Providers</a>
                <p>SHIELD can authenticate (and authorize) users against 3rd party OAuth2
                implementations like Github and UAA.  These authentication <em>providers</em>
                are configured in the SHIELD Core configuration file, but you can review their
                configuration here.</p>
              </li>
              [[ } ]]

              [[ if (AEGIS.is('manager')) { ]]
              <li><a href="#!/admin/users">Local User Management</a>
                <p>Local SHIELD user accounts can be set up to provide access to your SHIELD if
                you do not want to use a 3rd party authentication provider.  Local users can be
                granted system roles and be given roles on tenants.</p>
              </li>
              [[ } ]]

              <li><a href="#!/admin/rekey">Rekey SHIELD Core</a>
                <p>The SHIELD Core stores all of the archive encryption keys in a secure storage
                vault, which is protected by the SHIELD <em>master password</em>.  If you need or
                want to, you can rekey this SHIELD Core and pick a new master password.</p>
              </li>

              [[ if (AEGIS.is('admin')) { ]]
              <li><a href="#!/admin/sessions">Manage User Sessions</a>
                <p>Upon login, users are granted a session token to be used for the duration of
                their access. These sessions can be revoked via this interface, or expire
                naturally over time requiring the user to reauthenticate.</p>
              </li>
              [[ } ]]
            </ul>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:agents"><!-- {{{ -->
      [[#
        {agents} template

        Renders the list of registered agents, with information about each
        registered agent, its version, health, etc.
      ]]
          <div class="gutter blk">
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <h2>Agents of SHIELD</h2>
            [[ if (_.agents.length == 0) { ]]
            <div class="no-data">No Agents have registered with this SHIELD instance yet.</div>
            [[ } else { ]]
            <table class="lean">
              <thead><tr>
                <th>Name</th>
                <th>Address</th>
                <th>Version</th>
                <th>Status</th>
                <th>Last Seen</th>
                <th>Visible?</th>
                <th></th>
              </tr></thead>
              <tbody>
                [[ $.each(_.agents, function (i, agent) { ]]
                    [[ var problems = _.problems[agent.uuid]; ]]
                <tr data-agent-uuid="[[= agent.uuid ]]"[[ if (problems.length != 0) { ]] class="noted fail"[[ } ]]>
                  <td class="k">[[= h(agent.name) ]]</td>
                  <td>[[= h(agent.address) ]]</td>
                  <td>[[= h(agent.version) ]]</td>
                  <td>[[ if (agent.status == "ok") { ]]
                    <span class="ok">[[= h(agent.status) ]]</span>
                  [[ } else { ]]
                    <span class="fail">[[= h(agent.status) ]]</span>
                  [[ } ]]
                  </td>
                  <td>[[= trelative(agent.last_seen_at, 90*86400) ]]</td>
                  <td>[[ if (agent.hidden) { ]]no[[ } else { ]]yes[[ } ]]</td>
                  <td>[[ if (agent.hidden) { ]]<a href="#" rel="show">show</a>
                      [[ } else            { ]]<a href="#" rel="hide">hide</a>[[ } ]]
                      | <a href="#" rel="resync">resync</a></td>
                </tr>
                [[ if (problems.length != 0) { ]]
                <tr class="note fail">
                  <td colspan="7">
                    [[ $.each(problems, function (j, problem) { ]]
                    <strong>Note:</strong><div>[[= md(problem) ]]</div>
                    [[ }); ]]
                  </td>
                </tr>
                [[ } ]]
                [[ }); ]]
              </tbody>
            </table>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:auth-providers"><!-- {{{ -->
      [[#
        {auth-providers} template

        Renders the list of configured authentication providers, including
        details about how to integrate with their respective 3rd party auth
        systems, i.e. Github OAuth2 App registration, CF/UAA client creation,
        etc.
      ]]
          <div class="gutter blk" id="auth-providers">
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <h2>Authentication Providers</h2>
            <table class="lean sortable">
              <thead><tr>
                <th class="sortable">Name</th>
                <th class="sortable">Identifier</th>
                <th class="sortable">Type</th>
              </tr></thead>
              <tbody>
              [[ $.each(_.providers, function (i, provider) { ]]
                <tr>
                  <td>[[= h(provider.name) ]]</td>
                  <td><span class="tag">[[= h(provider.identifier) ]]</span></td>
                  <td>[[= h(provider.type) ]] (<a href="#!/admin/auth/config:name:[[= h(provider.identifier) ]]">configuration</a>)</td>
                </tr>
              [[ }); ]]
              </tbody>
            </table>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:auth-provider-config"><!-- {{{ -->
      [[#
        {auth-provider-config} template

        Renders the configuration of a single authentication provider,
        to help administrators set up the external endpoints, i.e. by
        showing the uaac commands to run to configure UAA, or the fields
        to fill out in the Github OAuth UI.
      ]]
          <div class="gutter blk" id="auth-provider">
            <a class="breadcrumb" href="#!/admin/auth">&laquo; Back to Authentication Providers</a>
            <h2>[[= h(_.provider.name) ]] Authentication Provider ([[= h(_.provider.identifier) ]])</h2>
            [[ var p = _.provider.properties; ]]
            [[ if (_.provider.type == 'github') { ]]
            <p>This is a <strong>Github</strong>-backed authentication provider, targeting
            [[ if (!p.github_endpoint || p.github_endpoint == "" || p.github_endpoint.match(/github\.com/)) { ]]
            public Github.
            [[ } else { ]]
            a private, on-premise Github Enterprise (<a href="[[= p.github_endpoint ]]">[[= p.github_endpoint ]]</a>).
            [[ } ]]</p>
            <h3>Configuring Github</h3>
            <p>First, you will need
            to <a href="https://github.com/settings/applications/new">register a new
            OAuth2 application</a> for this SHIELD:</p>

            <div class="github-auth-overlay-register">
              <span class="appname">SHIELD</span>
              <span class="homepage">[[= website() ]]</span>
              <span class="callback">[[= website() ]][[= _.provider.redirect ]]</span>
            </div>

            <p>Once your application is registered, Github will provide you
            with a new Client ID and Client Secret:</p>

            <div class="github-auth-overlay-app">
              <span class="client-id"></span>
              <span class="client-secret"></span>
            </div>

            <p>These <strong>must</strong> match the values you configure
            in the SHIELD Core configuration YAML file.</p>

            [[ } else { ]]
            <p>This is a <strong>UAA</strong>-backed authentication provider.</p>

            <h3>Configuring Your UAA Client</h2>
            <p>In order for this authentication provider to function, you may need
            to add a new UAA client for this SHIELD.  The following commands should
            suffice:</p>

<pre><code>$ uaac target <span class="hi">[[= p.uaa_endpoint ]]</span>
$ uaac token client get admin

$ uaac client add '<span class="hi">[[= p.client_id ]]</span>' \
    --name SHIELD \
    --scope openid \
    --authorities uaa.none \
    --authorized_grant_types authorization_code \
    --redirect_uri <span class="hi">[[= website() ]][[= _.provider.redirect ]]</span> \
    --access_token_validity  180 \
    --refresh_token_validity 180 \
    --secret '<span class="hi">[[= p.client_secret ]]</span>'</code>
</pre>

            [[ } ]]
            <h3>Raw Configuration</h3>
            <pre><code>[[= h(JSON.stringify(_.provider, null, 2)) ]]</code></pre>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:rekey"><!-- {{{ -->
      [[#
        {rekey} template

        Renders the list of configured authentication providers, including
        details about how to integrate with their respective 3rd party auth
        systems, i.e. Github OAuth2 App registration, CF/UAA client creation,
        etc.
      ]]
          <div class="gutter blk wizard2" id="rekey">
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <h2>Rekey Shield Master Password</h2>

            <form class="rekey">
              <div class="error"></div>

              <div class="c12 band">
                <div class="x9">
                  <div class="c12">
                    <div class="field required" data-field="current">
                      <div class="x3"><label for="current">Current Master Password</label></div>
                      <div class="x9">
                        <input type="password"
                               name="current"
                               class="autofocus">
                        <span class="errors">
                          <span data-error="missing">You must supply the current SHIELD master password</span>
                        </span>
                        <p class="help">In order to rekey this SHIELD core, you must specify your
                        current master password so that SHIELD can temporarily decrypt the secure
                        storage credentials.</p>
                      </div>
                    </div>

                    <div class="field required" data-field="new">
                      <div class="x3"><label for="new">New Master Password</label></div>
                      <div class="x9">
                      <div class="x9">
                        <input type="password" name="new">
                        <span class="errors">
                          <span data-error="missing">You must supply a new master password</span>
                        </span>
                      </div>
                    </div>

                    <div class="field required" data-field="confirm">
                      <div class="x3"><label for="confirm">Confirm</label></div>
                      <div class="x9">
                        <input type="password" name="confirm">
                        <span class="errors">
                          <span data-error="missing">You must confirm your new master password</span>
                          <span data-error="mismatch">Your passwords do not match</span>
                        </span>
                        <p class="help">Once your SHIELD is rekeyed, you will have to use the
                        <strong>new master password</strong> to unlock it.</p>
                      </div>
                    </div>

                    <div class="field" data-field="confirm">
                      <div class="x3"><label for="fixed">Rekey Shield Fixed Key?</label></div>
                      <div class="x9">
                        <label for="cb-rotate" class="switch">
                          <input id="cb-rotate" name="rotate_fixed_key" type="checkbox" checked /><span class="slider round"></span>
                        </label>
                        <p class="help">Rotates the key used for fixed-key backups.</p>
                      </div>
                    </div>

                    <div class="x12">
                      <button class="final">Rekey</button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:admin-users"><!-- {{{ -->
      [[#
        {admin-users} template

        Renders the list of local users, in the SHIELD database, allowing
        administrators to manage them, assigne them to tenants, etc.
      ]]
          <div class="gutter blk" id="admin-users">
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            [[ if (AEGIS.is('manager')) { ]]
            <a class="new" href="#!/admin/users/new">Create a New Local User &raquo;</a>
            [[ } ]]
            <h2>Local User Management</h2>
            [[ if (_.users.length == 0) { ]]
            <div class="no-data">No local SHIELD users have been created yet.</div>
            [[ } else { ]]
            <table class="lean sortable">
              <thead><tr>
                <th class="sortable">Name</th>
                <th class="sortable">Username</th>
                <th class="sortable">System Role</th>
                <th>Tenants</th>
                <th></th>
              </tr></thead>
              <tbody>
                [[ $.each(_.users, function (i, user) { ]]
                <tr>
                  <td><strong>[[= h(user.name) ]]</strong></td>
                  <td>[[= h(user.account) ]]</td>
                  <td>[[ if (user.sysrole == "") { ]]<span class="none">none</span>[[ } else { ]][[= h(user.sysrole) ]][[ } ]]</td>
                  <td>
                    [[ if ((user.tenants || []).length == 0) { ]]
                    <span class="none">none</span>
                    [[ } else { ]]
                    <ul>
                      [[ $.each(user.tenants || [], function (j, tenant) { ]]
                      <li><strong>[[= h(tenant.name) ]]</strong> ([[= h(tenant.role) ]])</li>
                      [[ }); ]]
                    </ul>
                    [[ } ]]
                  </td>
                  <td>
                    [[ if (AEGIS.is('manager')) { ]]
                    <a href="#!/admin/users/edit:uuid:[[= user.uuid ]]">edit</a>
                    [[ } ]]
                  </td>
                </tr>
                [[ }); ]]
              </tbody>
            </table>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:admin-users-new"><!-- {{{ -->
      [[#
        {admin-users-new} template

        Renders a form that administrators can use to create new local
        SHIELD user accounts, specifying their passwords and system roles.
      ]]
          <div class="gutter blk wizard2" id="admin-users">
            <a class="breadcrumb" href="#!/admin/users">&laquo; Back to Local User Management</a>
            <h2>New SHIELD User</h2>
            <form>
              <div class="c12 band">
                <div class="x9">
                  <div class="c12">
                    <div class="field required" data-field="name">
                      <div class="x3"><label for="name">Display Name</label></div>
                      <div class="x9">
                        <input type="text" name="name">
                        <span class="errors">
                          <span data-error="missing">Please provide a display name.</span>
                        </span>
                        <p class="help">A User's display name is primarily how they are identified in the web interface.</p>
                      </div>
                    </div>

                    <div class="field required" data-field="account">
                      <div class="x3"><label for="account">Username</label></div>
                      <div class="x9">
                        <input type="text" name="account">
                        <span class="errors">
                          <span data-error="missing">Please provide a username.</span>
                        </span>
                      </div>
                    </div>

                    <div class="field required" data-field="password">
                      <div class="x3"><label for="-password">Password</label></div>
                      <div class="x9">
                        <input type="password" name="password">
                        <span class="errors">
                          <span data-error="missing">Please provide a password for this new user.</span>
                        </span>
                      </div>
                    </div>

                    <div class="field required" data-field="confirm">
                      <div class="x3"><label for="confirm">Confirm</label></div>
                      <div class="x9">
                        <input type="password" name="confirm">
                        <span class="errors">
                          <span data-error="missing">Please confirm this new user's password.</span>
                          <span data-error="mismatch">These passwords don't match.</span>
                        </span>
                      </div>
                    </div>

                    <div class="field" data-field="sysrole">
                      <div class="x3"><label for="sysrole">System Role</label></div>
                      <div class="x9">
                        <select name="sysrole">
                          <option value="">(none)</option>
                          <option value="engineer">Engineer</option>
                          <option value="manager">Manager</option>
                          <option value="admin">Administrator</option>
                        </select>
                      </div>
                    </div>

                    <div class="x12 buttons">
                      <button class="final">Create</button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:admin-users-edit"><!-- {{{ -->
      [[#
        {admin-users-edit} template

        Renders a form that administrators can use to edit existing local
        SHIELD user accounts, specifying their passwords and system roles.
      ]]
          <div class="gutter blk wizard2" id="admin-users">
            <a class="breadcrumb" href="#!/admin/users">&laquo; Back to Local User Management</a>
            <h2>Update SHIELD User [[= h(_.user.account) ]]</h2>
            <form>
              <div class="c12 band">
                <div class="x9">
                  <div class="c12">
                    <div class="field required" data-field="name">
                      <div class="x3"><label for="name">Display Name</label></div>
                      <div class="x9">
                        <input type="text" name="name" id="edit-user-name" value="[[= _.user.name ]]">
                        <span class="errors">
                          <span data-error="missing">Please provide a display name.</span>
                        </span>
                      </div>
                    </div>

                    <div class="field" data-field="sysrole">
                      <div class="x3"><label for="edit-user-sysrole">System Role</label></div>
                      <div class="x9">
                        <select name="sysrole" id="edit-user-sysrole"
                          [[ if (AEGIS.user.uuid == _.user.uuid || (!AEGIS.is('admin') && _.user.sysrole == "admin")) { ]] disabled[[ } ]]>
                          <option value="">None</option>
                          <option value="engineer"[[ if (_.user.sysrole == "engineer") { ]] selected[[ } ]]>Engineer</option>
                          <option value="manager"[[ if (_.user.sysrole == "manager") { ]] selected[[ } ]]>Manager</option>
                          <option value="admin"[[ if (_.user.sysrole == "admin") { ]] selected[[ } ]]>Administrator</option>
                        </select>
                      </div>
                    </div>

                    <div class="x12 buttons">
                      <button class="final">Update</button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="template:sessions"><!-- {{{ -->
        [[#
          {sessions} template

          Renders the list of all current user sessions
        ]]
            <div class="gutter blk">
              <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
              <h2>Sessions</h2>
              [[ if (_.sessions.length == 0) { ]]
              <div class="no-data">No sessions have been created yet.</div>
              [[ } else { ]]
              <table class="lean sortable">
                <thead><tr>
                  <th class="sortable">Account</th>
                  <th class="sortable">Created At</th>
                  <th class="sortable">Last Seen</th>
                  <th class="sortable">IP Address</th>
                  <th class="sortable">User Agent</th>
                  <th></th>
                </tr></thead>
                <tbody>
                  [[ $.each(_.sessions, function (i, session) { ]]
                  <tr>
                    <td>[[= h(session.user_account) ]]</td>
                    <td data-sort="[[= session.created_at ]]" data-sort-as="number">[[= strftime("%Y-%m-%d %I:%M:%S%P", session.created_at) ]]</td>
                    <td data-sort="[[= session.last_seen_at ]]" data-sort-as="number">[[= trelative(session.last_seen_at, 14*86400) ]]</td>
                    <td>[[= h(session.ip_addr) ]]</td>
                    <td id="user-agent">[[= h(session.user_agent) ]]</td>
                    <td>[[ if (!session.current_session) {]]<a href="#!/admin/sessions/delete:uuid:[[= session.uuid ]]">delete</a> [[ } ]]</td>
                  </tr>
                  [[ }); ]]
                </tbody>
              </table>
              [[ } ]]
            </div>
      <!-- }}} --></script>
    <script type="text/html" id="template:sessions-delete"><!-- {{{ -->
        [[#
          {sessions-delete}

          A modal interaction screen that requires the operator to acknowledge
          that what they are about to do will result in the destruction of
          session data.
        ]]
            <div class="confirm">
              <h2>Delete The Session For Account:<em>[[= h(_.session.user_account) ]]</em>?</h2>

              <p>You have requested that SHIELD remove the session for
              the account "[[= h(_.session.user_account) ]]".</p>

              <p class="q">Are you sure you want to delete the session for <em>[[= h(_.session.user_account) ]]</em>?</p>
              <div class="a">
                <button class="safe" rel="close">No, Keep It</button>
                <button class="danger" rel="yes">Yes, Delete It</button>
              </div>
            </div>
      <!-- }}} --></script>
    <script type="text/html" id="template:"><!-- {{{ -->
    <!-- }}} --></script>

    <!-- 3rd-party libraries -->
    <script type="text/javascript" src="/js/jquery.js"></script>
    <script type="text/javascript" src="/js/showdown.js"></script>
    <script type="text/javascript" src="/js/lens.js"></script>
    <!-- SHIELD-specific libraries -->
    <script type="text/javascript" src="/js/data.js"></script>
    <script type="text/javascript" src="/js/lib.js"></script>
    <script type="text/javascript" src="/js/shield.js"></script>
    <script type="text/javascript" src="/js/sticky-nav.js"></script>
    <script type="text/javascript" src="/js/events.js"></script>
  </body>
</html>
