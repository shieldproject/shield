<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/shield.css" />
    <title>SHIELD</title>
  </head>
  <body>
    <div class="top-bar"><h1>SHIELD</h1></div>
    <div id="viewport" class="full"></div>

    <script type="text/html" id="tpl--layout"><!-- {{{ -->
      [[#
        {layout}

        The main (authenticated) layout for the UI
      ]]
      <div class="story-sidebar">
        <nav>
          [[ if ($global.auth.tenant && $global.auth.is.tenant[$global.auth.tenant.uuid].operator) { ]]
            [[ if ($global.auth.is.tenant[$global.auth.tenant.uuid].operator) { ]]
            <li><a href="#!/do/backup">Run an ad hoc backup</a>
                <p>Run a backup job whenever you need to, regardless of the job's
                schedule.</p></li>

            <li><a href="#!/do/restore">Restore data from a backup</a>
                <p>Restore a protected system back to the state it was in when a
                backup archive was taken.</p></li>
            [[ } ]]
            [[ if ($global.auth.is.tenant[$global.auth.tenant.uuid].engineer) { ]]
              <li><a href="#!/do/configure">Configure a new backup job</a>
                  <p>Set up a new protected system, and configure the how, when,
                  and for how long of managing its backup archives.</p></li>
            [[ } ]]
          [[ } else { ]]
            <li><a>You have no tenants...</a>
                <p>Operator stories will show up on the sidebar here, but only
                if you have been assigned to one or more SHIELD tenants.</p></li>
          [[ } ]]
        </nav>
        <footer>
          <a target="_blank" href="https://github.com/starkandwayne/shield"><img src="/i/social/github.png"></a>
          <a target="_blank" href="https://shieldproject.slack.com"><img src="/i/social/slack.png"></a>
          <a target="_blank" href="https://twitter.com/starkandwayne"><img src="/i/social/twitter.png"></a>
          <p>SHIELD Copyright &copy; 2017 Stark & Wayne</p>
        </footer>
      </div>
      <div class="pane">
        [[ if (($global.auth.tenant && $global.auth.is.tenant[$global.auth.tenant.uuid].operator) || ($global.auth.is.system.engineer)){ ]]
        <div class="hud blk" id="hud">
          <div class="x5"><div class="inst">
            <ul>
              <li class="shield">SHIELD &hellip;</li>
            </ul>
          </div></div>

          <div class="x5"><div class="health">
            <div class="fill"></div>
          </div></div>

          <div class="x6"><div class="prot">
            <div class="fill"></div>
          </div></div>
        </div>
        [[ } ]]

        <div class="nav sticky" id="sticky-nav">
          <nav>
            <li><a href="#!/systems">Systems</a></li>
            <li class="current"><a href="#!/stores">Storage</a></li>
            <li><a href="#!/policies">Retention</a></li>
            [[ if ($global.auth.is.system.engineer) { ]]<li><a href="#!/admin">Admin</a></li>[[ } ]]
          </nav>
        </div>

        <div class="nav">
          <nav>
            <li><a href="#!/systems">Systems</a></li>
            <li class="current"><a href="#!/stores">Storage</a></li>
            <li><a href="#!/policies">Retention</a></li>
            [[ if ($global.auth.is.system.engineer) { ]]<li><a href="#!/admin">Admin</a></li>[[ } ]]
          </nav>
        </div>

        <div class="field" id="main">
          <img id="loading" src="/i/loading.svg"/>
        </div>
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--loading"><!-- {{{ -->
      [[#
        {loading} template

        A simple SVG loading screen that keeps the viewer entertained while we
        go talk to SHIELD over AJAX, asynchronously.
      ]]
      <img id="loading" src="/i/loading.svg"/>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--overlay"><!-- {{{ -->
      [[#
        {overlay}

        A page overlay washes out the main page, makes the viewport fixed
        and non-scrollable, and then displays a message, warning, notice,
        or update to ensure that the viewer sees it.
      ]]
      <div id="overlay">
        <div class="header"><h2>[[= maybe(_.title, "SHIELD") ]]</h2></div>
        <div class="frame">[[= _.html ]]</div>
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--banner"><!-- {{{ -->
      [[#
        {banner} template

        Displays a message at the top of the viewport
      ]]
      <p class="[[= _.type ]]">[[= _.message ]] <a href="#">dismiss</a></p>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--error"><!-- {{{ -->
      [[#
        {error} template

        Displays a page-wide error, for failures involving AJAX requests,
        unhandled exceptions, etc.
      ]]
          <div class="gutter blk error">
            <h2>Uh-oh &mdash; Something broke.</h2>
            <p id="message">[[= _.message ]]</p>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--restore-are-you-sure"><!-- {{{ -->
      [[#
        {restore-are-you-sure}

        A modal interaction screen that requires the operator to acknowledge
        that what they are about to do is in fact to restore data, that it
        might be dangerous, and it might not work out.
      ]]
          <div class="confirm">
            <h2>You Are About To Restore Data</h2>
            <p>You have requested that S.H.I.E.L.D. restore <em>[[= _.target ]]</em>
            from a backup that was taken <em>[[= strftime("on %A, %B %d, %Y at %H:%M%P", _.taken) ]]</em> ([[= duration(tdiff(_.taken, new Date())) ]] ago).
            Any new data created after that point in time <em>will be lost</em>.</p>

            <p>Addtionally, the target system may be <em>offline or non-operational</em>
            while the restore operation is carried out.</p>

            <p class="q">Are you sure you want to restore <em>[[= _.target ]]</em>?</p>
            <div class="a">
              <button class="closes danger" rel="yes">Yes, Initiate Restore</button>
              <button class="closes safe" rel="close">No, Cancel This Operation</button>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--login"><!-- {{{ -->
      [[#
        {login} template

        Displays the login screen, which is a slightly different layout than
        most of the interface.  If OAuth2 backends have been configured, those
        are displayed as links to kick off the necessary OAuth2 flows (although
        they are styled as buttons)
      ]]
          <div id="login" class="frontdoor">
            <div[[ if (_.providers.length == 0) { ]] class="local-only"[[ } ]]>
              <h1>SHIELD<span style="color: [[= $global.shield.color || 'green' ]]">[[= $global.shield.env ]]<span></h1>
              <div class="dialog">
                <p class="motd">[[= $global.shield.motd ]]</p>

                [[ if (_.providers.length > 0) { ]]
                <div class="oauth2">
                  <h2>Sign in using...</h2>

                  <ul>
                    [[ $.each(_.providers, function (i, provider) { ]]
                    <li class="provider-[[= provider.type ]]"><a class="login" href="[[= provider.web_entry ]]">[[= provider.name ]]</a></li>
                    [[ }); ]]
                </div>
                [[ } ]]
                <div class="local">
                  <h2>Sign in with your SHIELD account</h2>
                  [[# FIXME implement signup functionality
                    <p class="divert">Need an account? <a href="#">Sign up for one today.</a></p>]]

                  <form>
                    <div class="error"></div>
                    <div class="ctl" data-field="username">
                      <label for="local-login-username">Username</label>
                      <div class="errors">
                        <span data-error="missing">Please supply your username.</span>
                      </div>
                      <input type="text" id="local-login-username" name="username">
                    </div>
                    <div class="ctl" data-field="password">
                      <label for="local-login-password">Password</label>
                      <div class="errors">
                        <span data-error="missing">Please supply your password.</span>
                      </div>
                      <input type="password" id="local-login-password" name="password">
                      [[# FIXME: implement password reset functionality
                        <a class="forgotpw" href="#">Forgot your password?</a>]]
                    </div>
                    [[# FIXME: implement 'remember me' functionality
                    <div class="ctl cb">
                      <div class="cbdark">
                        <input type="checkbox" id="local-login-remember-me" name="remember-me">
                        <label for="local-login-remember-me"></label>
                      </div>
                      <label for="local-login-remember-me">Remember me</label>
                    </div>]]
                    <button>Sign in</button>
                  <form>
                </div>
              </div>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--init"><!-- {{{ -->
          [[#
            {init} template

            Displays the initialization template screen (displayed after login on an uninitialized SHIELD)
          ]]
              <div id="initialize" class="frontdoor">
                  <h1>SHIELD<span style="color: [[= $global.shield.color || 'green' ]]">[[= $global.shield.env ]]<span></h1>
                  <div class="dialog">
                    <p class="motd">[[= $global.shield.motd ]]</p>
                    <div class="restore">
                       <h2>Restore SHIELD</h2>
                        <p class="restore_divert">If you'd like to initialize this SHIELD installation with a previous SHIELD self-backup, provide the archive file and the fixed key used to encrypt the backup. </p>
                          <form id="restore">
                        <div class="error"></div>
                        <div class="ctl" data-field="archive">
                          <label for="archive">SHIELD Backup
                            <div class="file-upload">Select Archive</div>
                          </label>
                           <input type="file" id="archive" name="archive">
                          <div class="errors">
                            <span data-error="missing">Please supply your SHIELD backup.</span>
                          </div>
                        </div>
                        <div class="ctl" data-field="fixedkey">
                          <label for="fixedkey">Fixed Key</label>
                          <div class="errors">
                            <span data-error="missing">Please supply your fixed key.</span>
                          </div>
                          <input type="password" id="fixedkey" name="fixedkey">
                        </div>
                        <button>Restore</button>
                      </form>
                    </div>
                    <div class="setpass">
                      <h2>Initialize SHIELD</h2>
                        <p class="divert">SHIELD maintains an internal encrypted vault of secrets, for protecting your data archives with strong encryption. This vault must be initialized, and protected with a new master password, before SHIELD will be able to use it</p>
                      <form id="setpass">
                        <div class="error"></div>
                        <div class="ctl" data-field="masterpass">
                          <label for="masterpass">Master Password</label>
                          <div class="errors">
                            <span data-error="missing">Please supply your password.</span>
                          </div>
                          <input type="password" id="masterpass" name="masterpass">
                        </div>
                        <div class="ctl" data-field="masterpassconf">
                          <label for="masterpassconf">Confirm Password</label>
                          <div class="errors">
                            <span data-error="missing">Please supply your password.</span>
                            <span data-error="mismatch">Your passwords do not match</span>
                          </div>
                          <input type="password" id="masterpassconf" name="masterpassconf">
                        </div>
                        <button>Set up</button>
                      </form>
                    </div>
                  </div>
              </div>
        <!-- }}} --></script>
    <script type="text/html" id="tpl--cliauth"><!-- {{{ -->
      [[#
        {cliauth} template

        Displays the session ID for an authenticated session, so that the CLI
        can be told what that session ID is.
      ]]
          <div id="cliauth" class="frontdoor">
            <div>
              <h1>SHIELD<span>[[= $global.shield.env ]]<span></h1>
              <div class="dialog">
                <h2>CLI Authentication Credentials</h2>
                <img src="/i/terminal.png" class="highlight">

                <p>Here are your SHIELD CLI authentication
                credentials:</p>

                <pre id="creds">[[= _.s ]]</pre>

                <p>You will need to copy-and-paste those into
                the terminal session where you ran the SHIELD
                command-line interface, to complete the
                authentication process.</p>
              </div>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--fixedkey"><!-- {{{ -->
        [[#
          {fixedkey} template

          Displays the Shield Fixed Key, so that operators can restore
          fixed-key backups in the event of a disaster.
        ]]
            <div id="fixed-wrapper" class="frontdoor">
              <div>
                <h1>SHIELD<span>[[= $global.shield.env ]]<span></h1>
                <div class="dialog">
                  <h2>Shield Fixed Key</h2>
                  <img src="/i/terminal.png" class="highlight">

                  <p>Here is your SHIELD Fixed Key:</p>

                  <pre id="fixedkey">[[= _.fixed_key ]]</pre>

                  <p id="dr-explain">
                    You will need to save this key in a secure location
                    for use in recovery of fixed-key backups in a disaster scenario.
                    Fixed-key backups must be used to backup shield itself. Once you
                    leave this screen, there is no way to access this key or corresponding
                    fixed-key backups unless you have saved it!
                  </p>
                  <a href="/"><button id="accept">I Understand</button></a>
                </div>
              </div>
            </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--logging-in"><!-- {{{ -->
      [[#
        {logging-in} template

        A simple loading screen that keeps the viewer apprised of
        our login efforts, while the browser processes the actual
        login and/or redirection.
      ]]
      <div id="logging-in">
        <p><img src="/i/loading-icon.svg"/>
           Signing into <span>SHIELD</span> via <span>[[= _.auth ]]</span>...</p>
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--BOOM"><!-- {{{ -->
      [[#
        {BOOM} template

        Displays a viewport-bound error message (without the hud/sidebar chrome)
        when SHIELD fails to boot up properly.  Typically, this means that we
        failed in our AJAX request to get the Authentication Providers to render
        the login page.
      ]]
          <div id="BOOM" class="frontdoor">
            <div>
              <h1>SHIELD<span>Production<span></h1>
              <div class="dialog">
                <h2>SOMETHING BROKE</h2>
                <img src="/i/boom.png" class="highlight">
                <p>An error has occurred, and SHIED was unable to recover from it.
                Your SHIELD site administrator may be able to peruse the SHIELD
                logs on this installation to shed some light on this conundrum.</p>

                <p>Most of the time, this is related to an inability to retrieve
                the authentication parameters for this SHIELD instance.  You may
                want to check to make sure you are connected to the internet, and
                if you need to hook up to any VPNs to access SHIELD, ensure that
                they too are connected.</p>
              </div>
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--top-bar"><!-- {{{ -->
      [[#
        {top-bar} template

        Renders the top-most bar, with the SHIELD name / environment, and the
        current users name / tenant and "personal settings" menu.
      ]]
        <h1><a href="#!/systems">SHIELD [[ if ($global.shield.color) { ]]<span style="color:[[= $global.shield.color ]]">[[ } ]][[= $global.shield.env ]]</span> <span>[[= $global.shield.ip ]]</span></a></h1>
        [[ if (_.user) { ]]
        <a href="#!/account" rel="account">[[= _.user.name ]][[ if (_.tenant) { ]] ([[= _.tenant.name ]] :: [[= _.tenant.role ]])[[ } ]]</a>
        <div class="flyout ephemeral">
          <div class="menu">
            <div class="header">Signed in as [[= _.user.account ]]
              <span>[[= _.user.backend ]]</span>
            </div>
            <div class="divider"></div>
            [[ if (_.tenants.length == 0) { ]]
            <span class="dropdown odd">you have no tenants</span>
            [[ } else { ]]
            [[   $.each(_.tenants.sort(function (a, b) { return a.name > b.name ? 1 : a.name == b.name ? 0 : -1 }), function (i, tenant) { ]]
            <a class="dropdown[[ if (tenant.uuid == _.tenant.uuid) { ]] current-tenant[[ } ]]" href="switchto:[[= tenant.uuid ]]">[[= tenant.name ]]</a>
            [[   }); ]]
            [[ } ]]
            <!--
            [[ if (_.tenant && $global.auth.is.tenant[_.tenant.uuid].admin) { ]]
                <div class="divider"></div>
                <a class="dropdown" href="#!/tenants/edit:uuid:[[= _.tenant.uuid ]]">Tenant Settings</a>
            [[ } ]]
            -->
            <div class="divider"></div>
            <!--a class="dropdown" href="#!/settings">Settings</a-->
            <a class="dropdown" href="#!/logout">Sign Out</a>
          </div>
        </div>
        [[ } ]]
    <!-- }}} --></script>
    <script type="text/html" id="tpl--hud"><!-- {{{ -->
        [[#
          {hud} template

          Renders the "health and wellness" heads-up display (HUD), with more
          information about this SHIELD instance (name / env / IP / version),
          health and key metrics.
        ]]
            <div class="x5"><div class="inst">
              <ul>
                <li class="shield">SHIELD
                  [[ if ($global.shield.version) { ]]<span class="v">[[= $global.shield.version ]]</span>
                  [[ } else { ]]<span class="v dev">(development)</span>
                  [[ } ]]</li>
                [[ if ($global.shield.ip)   { ]]<li class="ip">[[= $global.shield.ip ]]</li>[[ } ]]
                [[ if ($global.shield.fqdn) { ]]<li class="fqdn">[[= $global.shield.fqdn ]]</li>[[ } ]]
                <li class="env"><span style="color: [[= maybe($global.shield.color, "#8CC63F") ]]">[[= $global.shield.env ]]</span></li>
              </ul>
            </div></div>


            <div class="x5"><div class="health">
              <div class="preload" style="display: none">
                <object type="image/svg+xml" data="i/api-ok.svg"></object>
                <object type="image/svg+xml" data="i/api-fail.svg"></object>
                <object type="image/svg+xml" data="i/cloud-ok.svg"></object>
                <object type="image/svg+xml" data="i/cloud-fail.svg"></object>
                <object type="image/svg+xml" data="i/jobs-ok.svg"></object>
                <object type="image/svg+xml" data="i/jobs-fail.svg"></object>
              </div>
              <ul>
                [[ if (_.health.core == "unsealed" || _.health.core == "unlocked") { ]]
                <li class="ok"><object type="image/svg+xml" data="i/api-ok.svg"></object> SHIELD is <span>up</span></li>
                [[ } else if (_.health.core == "sealed" || _.health.core == "locked") { ]]
                <li class="fail"><object type="image/svg+xml" data="i/api-fail.svg"></object> SHIELD is <span>LOCKED</span></li>
                [[ } else if (_.health.core == "uninitialized") { ]]
                <li class="fail"><object type="image/svg+xml" data="i/api-fail.svg"></object> SHIELD is <span>UNINITIALIZED</span></li>
                [[ } else if (_.health.core == "unreachable") { ]]
                <li class="fail"><object type="image/svg+xml" data="i/api-fail.svg"></object> SHIELD is <span>unreachable</span></li>
                [[ } else if (_.health.core == "failing") { ]]
                <li class="fail"><object type="image/svg+xml" data="i/api-fail.svg"></object> SHIELD is <span>FAILING</span></li>
                [[ } else { ]]
                <li class="fail"><object type="image/svg+xml" data="i/api-fail.svg"></object> SHIELD is <span>unknown</span></li>
                [[ } ]]
                [[ if (_.health.storage_ok) { ]]
                <li class="ok"><object type="image/svg+xml" data="i/cloud-ok.svg"></object> Cloud Storage is <span>connected</span></li>
                [[ } else { ]]
                <li class="fail"><object type="image/svg+xml" data="i/cloud-fail.svg"></object> Cloud Storage is <span>failing</span></li>
                [[ } ]]
                [[ if (_.health.jobs_ok) { ]]
                <li class="ok"><object type="image/svg+xml" data="i/jobs-ok.svg"></object> All Jobs <span>succeeding</span></li>
                [[ } else { ]]
                <li class="fail"><object type="image/svg+xml" data="i/jobs-fail.svg"></object> Jobs are <span>failing</span></li>
                [[ } ]]
              </ul>
            </div></div>

            <div class="x6"><div class="prot">
              <h3>Data Protection Summary</h3>
              <ul>
                <li>Scheduled Backup Jobs <span>[[= _.stats.jobs ]]</span></li>
                <li>Backup Archives <span>[[= _.stats.archives ]]</span></li>
                <li class="warn">Cloud Storage Used <span>[[= bytes(_.stats.storage) ]]</span></li>
                <li class="ok">Daily Storage Increase <span>[[= bytes(_.stats.daily) ]]</span></li>
              </ul>
            </div></div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--404"><!-- {{{ -->
      [[#
        {404} template

        Help a lost traveller on their way.
      ]]
          <div class="gutter blk e404">
            <h2>Oops.  We Couldn't Find That...</h2>
            <img src="/i/404.png" width="30%">
            <p>Looks like someone or some<em>thing</em> directed you to a part of the SHIELD
            web interface that just doesn't exist.  Bummer.  If you are sure this is SHIELD's
            fault (and it very well could be), please report an issues over at our
            <a href="https://github.com/starkandwayne/shield/issues/new" target="_blank">Github
            Page</a>.</p>

            <pre>You can paste this additional information
      into your Github issue:

      - **Wanted URL**: [[= _.wanted ]]
      - **Arguments**:  ([[= _.args.join(', ') ]])
      - **Referer**:    [[= maybe(_.referer, '_none_') ]]
      </pre>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--account"><!-- {{{ -->
      [[#
        {account}

        Shows the user their current account information,
        including a form for changing their name (and, if
        local, their password), and a list of all tenants
        that they belong to, and their roles therein.
      ]]
          <div class="gutter blk account">
            <h2>My Account</h2>

            <form>
              <p><label for="name">Display</label>
              <input type="text" value="" /></p>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--roles-menu"><!-- {{{ -->
      [[#
        {roles-menu}

        A flyout menu for selecting roles, on either tenants
        (if given {type: "tenant"}) or the system ({type: "system"}).
      ]]
      <div class="roles-menu ephemeral">
        [[ if (_.type == 'tenant') { ]]
        <div[[ if (_.current == "admin") { ]] class="current"[[ } ]] data-role="admin">
          <strong>Administrator</strong>
          <p>Full control over this tenant.</p>
        </div>
        <div[[ if (_.current == "engineer") { ]] class="current"[[ } ]] data-role="engineer">
          <strong>Engineer</strong>
          <p>Can do everything except manage other peoples
             access to this tenant.</p>
        </div>
        <div[[ if (_.current == "operator") { ]] class="current"[[ } ]] data-role="operator">
          <strong>Operator</strong>
          <p>View access to most things, with the ability to
             pause and unpause jobs, run ad hoc backups, and
             perform restore operations.</p>
        </div>
        [[ } else { ]]
        <div[[ if (_.current == "admin") { ]] class="current"[[ } ]] data-role="admin">
          <strong>Administrator</strong>
          <p>Full control over SHIELD.</p>
        </div>
        <div[[ if (_.current == "manager") { ]] class="current"[[ } ]] data-role="manager">
          <strong>Manager</strong>
          <p>Can create and edit tenants, manage tenant/user
             memberships, and manage user accounts and access rights.</p>
        </div>
        <div[[ if (_.current == "engineer") { ]] class="current"[[ } ]] data-role="engineer">
          <strong>Engineer</strong>
          <p>Manages global configuration, including shared cloud
             storage configurations and retention policy templates.</p>
        </div>
        [[ } ]]
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--you-have-no-tenants"><!-- {{{ -->
      [[#
        {you-have-no-tenants} template

        What do you do when someone tries to access the parts of
        SHIELD that require a tenancy context, yet they have no
        tenants to speak of?  Why, you show them this little screen,
        of course!
      ]]
          <div class="gutter blk e404">
            <h2>Hrmm.  You Don't Seem To Belong To Any Tenants</h2>
            <p>This part of SHIELD only makes sense in the context of a tenant.
            However, it seems that your account has not been invited to participate
            in any tenants yet.</p>

            <p>You may want to reach out to your SHIELD administrator and ask them
            to assign you to a tenant, or check their configuration if they believe
            you ought to just be automagically assigned to one by the system.</p>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--access-denied"><!-- {{{ -->
      [[#
        {access-denied} template

        What do you do when someone tries to access the parts of
        SHIELD that require a certain level of access that is above
        their role assignment?  Try this screen!

        The following data can be provided to tailor the message:

          level: "system"    What level is access being denied at.
                             The value 'system' applies to global,
                             administrative contexts; 'tenant'
                             indicates a per-tenant ACL violation.

          need: "role"       What role is needed to gain access to
                             the given resource.

      ]]
          <div class="gutter blk">
            <h2>Access Denied</h2>
            [[ var want = _.level + '/' + _.need; ]]
            [[ if (want == 'system/admin') { ]]
                 <p>This part of SHIELD requires site-level <strong>administator</strong> access.</p>
                 <p>Only SHIELD site administrators can grant this level of access.</p>
            [[ } else if (want == 'system/manager') { ]]
                 <p>This part of SHIELD requires site-level <strong>manager</strong> access.</p>
                 <p>Only SHIELD site administrators can grant this level of access.</p>
            [[ } else if (want == 'system/engineer') { ]]
                 <p>This part of SHIELD requires site-level <strong>engineer</strong> access.</p>
                 <p>Only SHIELD site administrators can grant this level of access.</p>
            [[ } else if (want == 'tenant/admin') { ]]
                 <p>In order to access this part of SHIELD, you need to be
                 an <strong>administrator</strong> on this tenant.</p>
                 <p>Please contact your SHIELD site operators if you believe
                 you should have this level of access.</p>
            [[ } else if (want == 'tenant/engineer') { ]]
                 <p>In order to modify the configuration of resources on this
                 tenant, you need to be granted <strong>engineer</strong>-level
                 access.</p>
                 <p>Please consult your tenant administrators if you believe
                 you should have this level of access.</p>
            [[ } else if (want == 'tenant/operator') { ]]
                 <p>In order to operate on this tenant, you will need to be
                 granted <strong>operator</strong>-level access.</p>
                 <p>Please consult your tenant administrators if you believe
                 you should have this level of access.</p>
            [[ } else if (want == 'generic/elevated') { ]]
                 <p>This part of SHIELD requires <strong>elevated</strong> access.</p>
                 <p>Please consult your administrators if you believe you should
                 have this level of access.</p>
            [[ } else { ]]
                 <p>This part of SHIELD requires <strong>[[= _.level ]]/[[= _.need ]]</strong>
                    access, which seems to be an invalid role.  Please submit a bug report.</p>
            [[ } ]]
          </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--unlock"><!-- {{{ -->
      [[#
        {unlock} template

        Renders a form allowing anyone with knowledge of the SHIELD master
        password to unlock the SHIELD core, and resume normal operations.
      ]]
        <div class="gutter blk">
          <h2>This SHIELD Core is LOCKED</h2>
          <p>SHIELD maintains an internal encrypted vault of secrets, for protecting
          your data archives with strong encryption.  This vault must be unlocked
          before SHIELD will be able to use it.</p>

          <form class="unlock-shield">
            <div class="ctl" data-field="unlock-master">
              <label for="masterpass">Enter your SHIELD Master Password</label>
              <div class="errors">
                <span class="error"></span>
                <span data-error="missing">Please supply your password.</span>
                <span data-error="incorrect">Incorrect password, please try again.</span>
              </div>
              <input type="password" id="unlock-master" name="master">
            </div>
            <button>Unlock</button>
          </form>
        </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--do-backup"><!-- {{{ -->
      [[#
        {do-backup} - Backup Wizard Template

        Renders a multi-step, interactive wizard to assist operators in
        finding the correct backup archive to restore, based on what
        data system they want to restore, and how fresh the backup needs
        to be.
      ]]
      [[
        var stores = {};
        if (!_.system) {
          _.store = undefined;
          _.policy = undefined;
        }

        if (_.system && !_.store) {
          _.policy = undefined;
          $.each(_.system.jobs, function (i, job) {
            _.store = stores[job.store.uuid] = job.store;
            job.store.plugin = job.to;
          });
          if (_.noauto || Object.keys(stores).length != 1) {
            _.store = undefined;
          }
        }

        var policies = {};
        if (_.system && _.store && !_.policy) {
          $.each(_.system.jobs, function(i, job) {
            if (job.store.uuid = _.store.uuid) {
              _.policy = policies[job.retention.uuid] = job.retention;
            }
          });
          if (_.noauto || Object.keys(policies).length != 1) {
            _.policy = undefined;
          }
        }
      ]]
      <div class="gutter blk wizard do-backup">
        <p class="do-caption">Performing an Ad Hoc Backup</p>
        <div class="picks">
          [[ if (_.system) { ]]
          <div class="job card [[ if (!_.system.ok) { ]]fail[[ } else { ]]ok[[ } ]]">
          <a href="do-backup:unpick">
            <span class="type">System</span>
            <img src="i/shield-[[= _.system.ok ? 'ok' : 'fail' ]].svg">
            <h3>[[= _.system.name ]]</h3>
            <div class="notes">[[= _.system.notes ]]</div>
          </a>
          </div>
          [[ } else { ]]
          <div class="job card empty">Protected System</div>
          [[ } ]]
          [[ if (_.store) { ]]
          <div class="store card [[ if (!_.store.healthy) { ]]fail[[ } else { ]]ok[[ } ]]">
          <a href="do-backup:unpick">
            <span class="type">Cloud Storage</span>
            <img src="i/shield-[[= _.store.healthy ? 'ok' : 'fail' ]].svg">
            <h3>[[= _.store.name ]]</h3>
            <div class="notes">[[ if (_.store.summary) { ]]
              [[= _.store.summary ]]
            [[ } else { ]]
              <div class="no-data">No notes provided.  Too bad.</div>
            [[ } ]]</div>
            <div class="graph[[ if (!_.store.healthy) { ]] fail[[ } ]]">
              <div class="to">[[= _.store.plugin ]]</div>
            </div>
          </a>
          </div>
          [[ } else { ]]
          <div class="store card empty">Cloud Storage</div>
          [[ } ]]
          [[ if (_.policy) { ]]
          <div class="policy card">
          <a href="do-backup:unpick">
            <h3>[[= _.policy.name ]]</h3>
            <ul class="details">
              <li>keep for [[= _.policy.days ]] day[[ if (_.policy.days != 1) { ]]s[[ } ]]</li>
            </ul>
            <div class="notes">[[= _.policy.summary ]]</div>
          </a>
          </div>
          [[ } else { ]]
          <div class="store card empty">Retention Policy</div>
          [[ } ]]
        </div>

        [[ if (!_.system) { ]]
        <div class="step pick-a-system">
          <span class="label">Step 1</span>
          <h3>Pick What You Want To Back Up</h3>
          <p>Which protected system you want to back up?</p>

          <div>
          [[ $.each(_.systems, function (i, target) { ]]
          <div class="job card [[ if (!target.ok) { ]]fail[[ } else { ]]ok[[ } ]]">
            <a href="do-backup:pick:target:[[= target.uuid ]]">
            <img src="i/shield-[[= target.ok ? 'ok' : 'fail' ]].svg">
            <h3>[[= target.name ]]</h3>
            <div class="notes">[[= target.notes ]]</div>
            </a>
          </div>
          [[ }); ]]
          </div>
        </div>
        [[ } ]]

        [[ if (_.system && !_.store) { ]]
        <div class="step pick-a-store">
          <span class="label">Step 2</span>
          <h3>Select Cloud Storage</h3>
          <p>Where would you like to store this backup archive?</p>

          <div>
            [[ $.each(stores, function (uuid, store) { ]]
            <div class="store card [[ if (!store.healthy) { ]]fail[[ } else { ]]ok[[ } ]]">
              <a href="do-backup:pick:store:[[= store.uuid ]]">
              <img src="i/shield-[[= store.healthy ? 'ok' : 'fail' ]].svg">
              <h3>[[= store.name ]]</h3>
              <div class="notes">[[ if (store.summary) { ]]
                [[= store.summary ]]
              [[ } else { ]]
                <div class="no-data">No notes provided.  Too bad.</div>
              [[ } ]]</div>
              <div class="graph[[ if (!store.healthy) { ]] fail[[ } ]]">
                <div class="to">[[= store.plugin ]]</div>
              </div>
              </a>
            </div>
            [[ }); ]]
          </div>
        </div>
        [[ } ]]

        [[ if (_.system && _.store && !_.policy) { ]]
        <div class="step pick-a-retention-policy" style="display: block">
          <span class="label">Step 3</span>
          <h3>Choose a Retention Policy</h3>
          <p>How long should we keep this backup?</p>

          <div>
            [[ $.each(policies, function (uuid, retention) { ]]
              <div class="policy card">
                <a href="do-backup:pick:policy:[[= retention.uuid ]]">
                <h3>[[= retention.name ]]</h3>
                <ul class="details">
                  <li>keep for [[= retention.days ]] days</li>
                </ul>
                <div class="notes">[[= retention.summary ]]</div>
                </a>
              </div>
            [[ }); ]]
          </div>
          </div>
        </div>
        [[ } ]]

        [[ if (_.system && _.store && _.policy) { ]]
        [[
          var uuid;
          for (var i = 0; i < _.system.jobs.length; i++) {
            var job = _.system.jobs[i];
            if (job.store.uuid == _.store.uuid
              && job.retention.uuid == _.policy.uuid) {

              uuid = job.uuid;
              break;
            }
          }
        ]]
        <div class="step run-the-backup" style="display: block">
          <h3>Review Your Choices</h3>
          <p>If everything looks correct, click the big button to
          initiate a manual backup of <strong>[[= _.system.name ]]</strong>
          to <strong>[[= _.store.name ]]</strong> &mdash; backup archive will be kept
          for <strong>[[= _.policy.days ]] days</strong>.</p>

          <button class="final" rel="run:[[= uuid ]]">Run Backup &raquo;</button>
        </div>
        [[ } ]]
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--do-restore"><!-- {{{ -->
      [[#
        {do-restore} - Restore Wizard Template

        Renders a multi-step, interactive wizard to assist operators in
        finding the correct archive to restore, based on what data system
        they want to restore, and how fresh the restore needs to be.
      ]]
      <div class="gutter blk wizard do-restore">
        <p class="do-caption">Restoring Data</p>
        <div class="picks">
          [[ if (_.system) { ]]
          <div class="job card">
          <a href="do-restore:unpick">
            <span class="type">System to Restore</span>
            <h3>[[= _.system.name ]]</h3>
            <div class="notes">[[= _.system.notes ]]</div>
          </a>
          </div>
          [[ } else { ]]
          <div class="job card empty">Protected System</div>
          [[ } ]]
          [[ if (_.archive) { ]]
          <div class="archive card">
          <a href="do-restore:unpick">
            <span class="type">Archive</span>
            <h3>[[= strftime("%x %X", _.archive.taken_at) ]]</h3>
            <div class="notes">
              <strong>[[= bytes(_.archive.size) ]]</strong>,
              in <strong>[[= _.archive.store_name ]]</strong>.
            </div>
            <div class="graph">
              <div class="to">[[= _.archive.store_plugin ]]</div>
            </div>
          </a>
          </div>
          [[ } else { ]]
          <div class="store card empty">Backup Archive to restore</div>
          [[ } ]]
        </div>

        [[ if (!_.system) { ]]
        <div class="step pick-a-system">
          <span class="label">Step 1</span>
          <h3>What system do you want to restore?</h3>
          <div>
          [[ $.each(_.systems, function (i, target) { ]]
          <div class="job card [[ if (!target.ok) { ]]fail[[ } else { ]]ok[[ } ]]">
            <a href="do-restore:pick:target:[[= target.uuid ]]">
            <img src="i/shield-[[= target.ok ? 'ok' : 'fail' ]].svg">
            <h3>[[= target.name ]]</h3>
            <div class="notes">[[= target.notes ]]</div>
            </a>
          </div>
          [[ }); ]]
          </div>
        </div>

        [[ } else if (!_.archive) { ]]
        <div class="step pick-an-archive">
          <span class="label">Step 2</span>
          <h3>Which archive do you want to restore?</h3>

          [[ if (_.system.archives.length == 0) { ]]
          <div class="no-data">This data system has never been backed up successfully.</div>
          [[ } else { ]]
          <div class="archive-row pick-me">
            <h4>Most Recent Backup</h4>
            <dl>
              <dt>Backup Taken</dt>
              <dd>[[= strftime("%x %X", _.system.archives[0].taken_at) ]]<br>
                  <sub>[[= duration(tdiff(_.system.archives[0].taken_at, new Date())) ]] ago</sub></dd>

              <dt>Archive size</dt>
              <dd>[[= bytes(_.system.archives[0].size) ]]</dd>

              <dt>Stored in</dt>
              <dd>[[= _.system.archives[0].store_name ]]</dd>
            </dl>

            <button rel="do-restore:pick:archive:[[= _.system.archives[0].uuid ]]">Go &raquo;</button>
          </div>
            [[ if (_.system.archives.length > 1) { ]]
              <table class="archives">
                <thead><tr>
                  <th>Date of backup</th>
                  <th>Age of backup</th>
                  <th>Archive size</th>
                  <th>Stored in</th>
                  <th></th>
                </tr></thead>
                <tbody>
                [[ $.each(_.system.archives, function (i, archive) { ]]
                  [[ if (i == 0) { return; } ]]
                  <tr>
                    <th>[[= strftime("%x %X", archive.taken_at) ]]</th>
                    <td>[[= duration(tdiff(archive.taken_at, new Date())) ]]</th>
                    <td>[[= bytes(archive.size) ]]</td>
                    <td>[[= archive.store_name ]]</td>
                    <td><a href="do-restore:pick:archive:[[= archive.uuid ]]">restore this one &raquo;</a></td>
                  </tr>
                [[ }); ]]
                </tbody>
              </table>
            [[ } ]]
          [[ } ]]
        </div>
        [[ } ]]

        [[ if (_.system && _.archive) { ]]
        <div class="step run-the-restore" style="display: block">
          <h3>Review Your Choices</h3>
          <p>If everything looks correct, click the big button to
          initiate a manual restore of <strong>[[= _.system.name ]]</strong>
          from the backup archive taken [[= strftime("on %x at %X", _.archive.taken_at) ]].
          </p>

          <button class="final" rel="do-restore:final:[[= _.archive.uuid ]]">Run Restore &raquo;</button>
        </div>
        [[ } ]]
      </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--do-configure"><!-- {{{ -->
      [[#
        {do-configure} - Job Configuration Wizard

      ]]
      <div class="gutter blk wizard do-configure">
        <p class="do-caption">Configuring a New Backup Job</p>
        <div class="picks">[[# {{{ ]]
          [[ if (_.target) { ]]
          <div class="job card">
            <a href="do-configure:unpick">
              <span class="type">[[= _.target.uuid ? '' : '<strong>New</strong> ' ]]System</span>
              <h3>[[= _.target.name ]]</h3>
              <div class="notes">[[ if (_.target.summary) { ]]
                [[= _.target.summary ]]
              [[ } else { ]]
                <div class="no-data">No notes provided.  Too bad.</div>
              [[ } ]]</div>
              <div class="graph">
                <div class="to">[[= _.target.plugin ]]</div>
              </div>
            </a>
          </div>
          [[ } else { ]]
          <div class="job card empty">Protected System</div>
          [[ } ]]

          [[ if (_.schedule) { ]]
          <div class="policy card">
            <a href="do-configure:unpick">
              [[ if (!_.policy) { ]]
              <span class="type">Schedule</span>
              <h3>Runs [[= _.schedule ]]</h3>
              [[ } else { ]]
              <span class="type">Schedule + [[= _.policy.uuid ? '' : '<strong>New</strong> ' ]]Policy</span>
              <h3>Runs [[= _.schedule ]]</h3>
              <h3>Retain [[= _.policy.expires / 86400 ]] day[[= _.policy.expires == 86400 ? '' : 's' ]] of archives</h3>
              <div class="notes">using the <strong>[[= _.policy.name]]</strong> policy</div>
              [[ } ]]
            </a>
          </div>
          [[ } else { ]]
          <div class="schedule card empty">Schedule + Policy</div>
          [[ } ]]

          [[ if (_.store) { ]]
          <div class="store card [[ if (!_.store.healthy) { ]]fail[[ } else { ]]ok[[ } ]]">
            <a href="do-configure:unpick">
              <span class="type">[[= _.store.uuid ? '' : '<strong>New</strong> ' ]]Cloud Storage</span>
              <img src="i/shield-[[= _.store.healthy ? 'ok' : 'fail' ]].svg">
              <h3>[[= _.store.name ]]</h3>
              <div class="notes">[[ if (_.store.summary) { ]]
                [[= _.store.summary ]]
              [[ } else { ]]
                <div class="no-data">No notes provided.  Too bad.</div>
              [[ } ]]</div>
              <div class="graph[[ if (!_.store.healthy) { ]] fail[[ } ]]">
                <div class="to">[[= _.store.plugin ]]</div>
              </div>
            </a>
          </div>
          [[ } else { ]]
          <div class="store card empty">Cloud Storage</div>
          [[ } ]]
        </div>[[# }}} ]]

        [[ if (!_.target) { ]]
        <div class="step pick-a-target">
          <span class="label">Step 1</span>
          [[ if (_.targets.length == 0 || _.new_target === true) { ]]
          [[ if (_.targets.length > 0) { ]]<a class="breadcrumb" href="do-configure:unpick:target:redo">Select a pre-existing system</a>[[ } ]]
          <h3>Configure a New Protected System</h3>[[# {{{ ]]
          <form action="do-configure:make:target">
            <div class="ctl" data-field="name">
              <label for="target-name">Name</label>
              <span class="errors">
                <span data-error="missing">You must name your data system.</span>
              </span>
              <div class="widget">
                <input type="text" id="target-name" name="name" class="autofocus" />
                <p class="help">Pick a memorable or descriptive name for this data system.</p>
              </div>
            </div>

            <div class="ctl" data-field="summary">
              <label for="target-summary">Notes</label>
              <span class="errors">
              </span>
              <div class="widget">
                <textarea id="target-summary" name="summary" class="autofocus"></textarea>
                <p class="help">If you want, you can add a longer description.</p>
              </div>
            </div>

            <div class="ctl" data-field="agent">
              <label for="store-agent">Agent</label>
              <span class="errors">
                <span data-error="missing">You must select which SHIELD Agent to use to access this protected system.</span>
              </span>
              <div class="widget">
                <select id="store-agent" name="agent" value="[[= _.store ? _.store.agent : '' ]]">
                  <option></option>
                  [[ var found = false; ]]
                  [[ $.each(_.agents, function (i, agent) { ]]
                  <option value="[[= agent.uuid ]]|[[= agent.address ]]">[[= agent.name ]] (at [[= agent.address ]])</option>
                  [[ }); ]]
                </select>
              </div>
            </div>

            <div id="choose-plugin"></div>
            <div id="configure-plugin"></div>

            <div class="ctl" data-field="compression">
              <label for="target-compresion">Compression?</label>
              <div class="widget">
                <input class="large-checkbox" name="compression" type="checkbox" value="true" checked />
                <p class="help">By default, SHIELD compresses all backup archives using <tt>bzip2</tt>
                compression.</p>
              </div>
            </div>

            <div class="ctl" data-field="fixed-key">
              <label for="target-fixed-key">Fixed-Key Encryption?</label>
              <div class="widget">
                <input class="large-checkbox" name="fixed_key" type="checkbox" value="true" />
                <p class="help">Select if backups should use the Fixed Key for encryption.
                (Required for backups of Shield itself) </p>
              </div>
            </div>

            <button class="go">Next</button>
          </form>
          [[ } else { ]][[# }}} ]]
          <h3>What Do You Want To Back Up?</h3>[[# {{{ ]]
          <div>
            [[ $.each(_.targets, function (i, target) { ]]
            <div class="job card">
              <a href="do-configure:pick:target:[[= target.uuid ]]">
                <h3>[[= target.name ]]</h3>
                <div class="notes">[[= target.summary ]]</div>
                <div class="graph">
                  <div class="to">[[= target.plugin ]]</div>
                </div>
              </a>
            </div>
            [[ }); ]]
            <div class="shadow card">
              <a href="do-configure:new:target">
              ... or configure a new target
              </a>
            </div>
          </div>[[# }}} ]]
          [[ } ]]
        </div>

        [[ } else if (!_.schedule) { ]]
        <div class="step pick-a-schedule">[[# {{{ ]]
          <span class="label">Step 2</span>
          <h3>Select a Schedule</h3>

          <form class="scheduling" action="do-configure:make:schedule">
            <div class="error"></div>
            <div>
              <label>Run the backup</label>
              <ul class="optgroup">
                <li data-subform="schedule-hourly">Hourly</li>
                <li data-subform="schedule-daily">Daily</li>
                <li data-subform="schedule-weekly">Weekly</li>
                <li data-subform="schedule-monthly">Monthly</li>
              </ul>

              <div id="schedule-hourly" class="subform">
                <div>Every <input name="hourlyn" class="num" type="text" value="1"> hour(s)</div>
                <div>from <input name="hourlyat" class="time" type="text" value="12:15"> <ul class="ampm optgroup">[[= optgroup(['am', 'pm']) ]]</div>
              </div>

              <div id="schedule-daily" class="subform">
                <div>Every day</div>
                <div>at <input name="dailyat" class="time" type="text" value="3:00"> <ul class="ampm optgroup">[[= optgroup(['am', 'pm']) ]]</div>
              </div>

              <div id="schedule-weekly" class="subform">
                <div>Every week</div>
                <div>on <ul class="wday optgroup">[[= optgroup(['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']) ]]</ul></div>
                <div>at <input name="weeklyat" class="time" type="text" value="4:15"> <ul class="ampm optgroup">[[= optgroup(['am', 'pm']) ]]</div>
              </div>

              <div id="schedule-monthly" class="subform">
                <div>Every month(s)</div>
                <div>on the <input name="monthlynth" class="num" type="text" value="1st">
                     <ul class="mday optgroup">[[= optgroup(['day', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']) ]]</ul></div>
                <div>at <input name="monthlyat" class="time" type="text" value="5:30"> <ul class="ampm optgroup">[[= optgroup(['am', 'pm']) ]]</div>
              </div>

            </div>

            <button class="go">Next</button>
          </form>
        </div>[[# }}} ]]

        [[ } else if (!_.policy) { ]]
        <div class="step pick-a-policy">
          <span class="label">Step 3</span>
          [[ if (_.policies.length == 0 || _.new_policy) { ]]
          [[ if (_.policies.length > 0) { ]]<a class="breadcrumb" href="do-configure:unpick:policy:redo">Select a pre-existing retention policy</a>[[ } ]]
          <h3>Configure a New Retention Policy</h3>[[# {{{ ]]
          <form action="do-configure:make:policy">
            <div class="error"></div>

            <div class="ctl" data-field="name">
              <label for="policy-name">Name</label>
              <span class="errors">
                <span data-error="missing">You must provide a name for this new retention policy.</span>
                <span data-error="too-big">The name cannot exceed 100 characters</span>
              </span>
              <div class="widget">
                <input type="text" id="policy-name" name="name" maxlength="100" class="autofocus" tabindex="0" />
                <p class="help">Pick a memorable or descriptive name for this retention policy,
                so that other operators can determine what to use it for.</p>
              </div>
            </div>

            <div class="ctl" data-field="expires">
              <label for="policy-days">Expiry (in days)</label>
              <span class="errors">
                <span data-error="missing">You must specify an expiry of at least 1 day.</span>
                <span data-error="invalid">This must be a positive, non-zero, whole number.</span>
                <span data-error="too-big">Retention expiry cannot exceed 10 years (3660 days)</span>
              </span>
              <div class="widget">
                <input type="text" id="policy-days" name="days" />
                <p class="help">How long should archives be kept, under this retention policy.
                At a minimum, archives must be kept for one day.</p>
              </div>
            </div>

            <button class="go">Create</button>
          </form>
          [[ } else { ]][[# }}} ]]
          <h3>How Long Should SHIELD Keep The Backup Archives?</h3>[[# {{{ ]]
          <div>
          [[ $.each(_.policies, function (i, policy) { ]]
            <div class="policy card">
              <a href="do-configure:pick:policy:[[= policy.uuid ]]">
              <h3>[[= policy.name ]]</h3>
              <div class="days">[[= policy.expires / 86400 ]]<span> days</span></div>
              </a>
            </div>
          [[ }); ]]
            <div class="shadow card">
              <a href="do-configure:new:policy">
              ... or configure a new retention policy
              </a>
            </div>
          </div>[[# }}} ]]
          [[ } ]]
        </div>

        [[ } else if (!_.store) { ]]
        <div class="step pick-a-store">
          <span class="label">Step 4</span>
          [[ if (_.stores.length == 0 || _.new_store) { ]]
          [[ if (_.stores.length > 0) { ]]<a class="breadcrumb" href="do-configure:unpick:store:redo">Select a pre-existing cloud storage system</a>[[ } ]]
          <h3>Configure a New Cloud Storage System</h3>[[# {{{ ]]
          <form action="do-configure:make:store">
            <div class="error"></div>

            <div class="ctl" data-field="name">
              <label for="store-name">Name</label>
              <span class="errors">
                <span data-error="missing">You must provide a name for this new storage system.</span>
              </span>
              <div class="widget">
                <input type="text" id="store-name" name="name" class="autofocus" />
                <p class="help">Pick a memorable or descriptive name for this storage system,
                so that other operators can determine when to use it.</p>
              </div>
            </div>

            <div class="ctl" data-field="summary">
              <label for="store-summary">Notes</label>
              <div class="widget">
                <textarea id="store-summary" name="summary"></textarea>
                <p class="help">If you want, you can add a longer description.</p>
              </div>
            </div>

            <div class="ctl" data-field="threshold">
              <label for="store-threshold">Threshold</label>
              <span class="errors">
                <span data-error="missing">You must provide a threshold for this new storage system.</span>
              </span>
              <div class="widget">
                <input type="text" id="store-threshold" name="threshold" placeholder="10G, 500M, etc."/>
                  <p class="help">Select a reasonable threshold for storage size warnings.</p>
              </div>
            </div>

            <div class="ctl" data-field="agent">
              <label for="store-agent">Agent</label>
              <span class="errors">
                <span data-error="missing">You must select which SHIELD Agent to use to access this storage system.</span>
              </span>
              <div class="widget">
                <select id="store-agent" name="agent">
                  <option></option>
                  [[ $.each(_.agents, function (i, agent) { ]]
                  <option value="[[= agent.uuid ]]|[[= agent.address ]]">[[= agent.name ]] (at [[= agent.address ]])</option>
                  [[ }); ]]
                </select>
              </div>
            </div>

            <div id="choose-plugin"></div>
            <div id="configure-plugin"></div>

            <button class="go">Next</button>
          </form>
          [[ } else { ]][[# }}} ]]
          <h3>Where Should SHIELD Store The Backup Archives?</h3>[[# {{{ ]]

          <div>
            [[ $.each(_.stores, function (uuid, store) { ]]
            <div class="store card [[ if (!store.healthy) { ]]fail[[ } else { ]]ok[[ } ]]">
              <a href="do-configure:pick:store:[[= store.uuid ]]">
              [[ if (store.global) { ]]<span class="type">Shared</span>[[ } ]]
              <img src="i/shield-[[= store.healthy ? 'ok' : 'fail' ]].svg">
              <h3>[[= store.name ]]</h3>
              <div class="notes">[[ if (store.summary) { ]]
                [[= store.summary ]]
              [[ } else { ]]
                <div class="no-data">No notes provided.  Too bad.</div>
              [[ } ]]</div>
              <div class="graph[[ if (!store.healthy) { ]] fail[[ } ]]">
                <div class="to">[[= store.plugin ]]</div>
              </div>
              </a>
            </div>
            [[ }); ]]
            <div class="shadow card">
              <a href="do-configure:new:store">
              ... or configure new cloud storage
              </a>
            </div>
          </div>
        </div>[[# }}} ]]
          [[ } ]]

        [[ } else { ]]
        <div class="step review" style="display: block">[[# {{{ ]]
          <h3>Review Your Choices</h3>
          <form action="do-configure:finalize">
            <div class="ctl" data-field="name">
              <label for="job-name">Job Name</label>
              <div class="widget">
                <div class="errors">
                  <span data-error="missing">You must name your new backup job.</span>
                </div>
                <input type="text" name="name" value="[[= _.name || '' ]]" />
              </div>
            </div>

            <div class="ctl" data-field="summary">
              <label for="job-name">Notes</label>
              <div class="widget">
                <textarea name="summary">[[= _.summary || '' ]]</textarea>
              </div>
            </div>
            <button class="final">Save &raquo;</button>
          </form>
        </div>[[# }}} ]]
        [[ } ]]
      </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--subform-choose-plugin"><!-- {{{ -->
      [[#
        {subform-choose-plugin} template

        Renders the plugin choice dropdown
      ]]
          <div class="ctl" data-field="plugin">
            <label for="the-plugin">[[= _.type == 'store' ? 'Storage' : 'Backup' ]] Plugin</label>
            <span class="errors">
              <span data-error="missing">You must select a [[= _.type == 'store' ? 'storage' : 'backup' ]] plugin to use.</span>
            </span>
            <div class="widget">
              [[
                  var plugins = [];
                  $.each(_.metadata.plugins, function (plugin, metadata) {
                    if (metadata.features[_.type] == 'yes') {
                      plugins.push([plugin, metadata.name + " ("+plugin+")"])
                    }
                  });
                  plugins = plugins.sort(function (a, b) {
                    return a[1] > b[1] ?  1
                         : a[1] < b[1] ? -1 : 0;
                  });
              ]]
              [[ if (plugins.length == 0) { ]]
              <div class="no-data">This agent does not seem to be properly reporting its metadata to SHIELD, and cannot be used.
              Please select another SHIELD agent.</div>
              [[ } else { ]]
              <select id="the-plugin" name="plugin">
                <option></option>
                [[ $.each(plugins, function (i, plugin) { ]]
                <option value="[[= plugin[0] ]]">[[= plugin[1] ]]</option>
                [[ }); ]]
              </select>
              [[ } ]]
            </div>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--subform-configure-plugin"><!-- {{{ -->
      [[#
        {subform-configure-plugin} template

        Renders the plugin / endpoint configuration sub-form
      ]][[

            var esc = function (s) { return s.replace(/`([^`]*)`/g, '<tt>$1</tt>'); }

          ]]
          <div class="subform">
            <h2>[[= _.type == 'store' ? 'Storage' : 'Backup' ]] Plugin Options</h2>
          [[ var n = 0; ]]
          [[ $.each(_.plugin.fields, function (i, field) { ]]
            [[ if (field.mode == 'target' && _.type == 'store') { return; } ]]
            [[ if (field.mode == 'store' && _.type == 'target') { return; } ]]
              [[ n++; ]]
              <div class="ctl[[ if (field.required) { ]] required[[ } ]]" data-field="config.[[= field.name ]]" data-type="[[= field.type ]]">
                <label for="the-plugin-[[= field.name ]]">[[= esc(field.title) ]][[ if (field.required) { ]] <span>(required)</span>[[ } ]]</label>
                <span class="errors">
                  <span data-error="missing">You must provide a value for this plugin configuration.</span>
                  [[ if (field.type == "port") { ]]
                  <span data-error="invalid">Please supply a valid port number, between 1 and 65535 (inclusive).</span>
                  [[ } else if (field.type == "abspath") { ]]
                  <span data-error="invalid">Please supply an absolute filesystem path, starting with a forward slash.</span>
                  [[ } ]]
                </span>
                <div class="widget">
                  [[ if (field.type == 'bool') { ]]
                  <input type="checkbox" id="the-plugin-[[= field.name ]]" name="config.[[= field.name ]]" />
                  [[ } else if (field.type == 'enum') { ]]
                  <select id="the-plugin-[[= field.name ]]" name="config.[[= field.name ]]">
                    [[ if (!field.required || field.default) { ]]<option></option>[[ } ]]
                    [[ $.each(field.enum, function (i, value) { ]]
                    [[   if (_.config && _.config[field.name] == value) { ]]
                    <option selected value="[[= value ]]">[[= value ]]</option>
                    [[   } else { ]]
                    <option value="[[= value ]]">[[= value ]]</option>
                    [[   } ]]
                    [[ }); ]]
                  </select>
                  [[ } else if (field.type == 'password') { ]]
                  <!-- FIXME: this needs to be a smudge field -->
                  <input type="password" id="the-plugin-[[= field.name ]]" name="config.[[= field.name ]]"
                    [[ if (_.config && (field.name in _.config)) { ]]value="[[= _.config[field.name] ]]"[[ } ]]
                    [[ if (field.placeholder && field.placeholder != "") { ]]placeholder="[[= field.placeholder ]]"[[ } ]]/>
                  [[ } else { ]]
                  <input type="text" id="the-plugin-[[= field.name ]]" name="config.[[= field.name ]]"
                    [[ if (_.config && (field.name in _.config)) { ]]value="[[= _.config[field.name] ]]"[[ } ]]
                    [[ if (field.placeholder && field.placeholder != "") { ]]placeholder="[[= field.placeholder ]]"[[ } ]]/>
                  [[ } ]]
                  [[ if (field.help && field.help != '') { ]]
                  <p class="help">[[= esc(field.help) ]]</p>
                  [[ } ]]
                  [[ if (field.example && field.example != '') { ]]
                  <p class="example">For example: [[= esc(field.example) ]]</p>
                  [[ } ]]
                </div>
              </div>
          [[ }); ]]
          [[ if (n == 0) { ]]
          <div class="no-data">
            <p>This [[= _.type == 'store' ? 'storage' : 'backup' ]] plugin is zero-conf, and should just work.</p>
          </div>
          [[ } ]]
          </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--systems"><!-- {{{ -->
      [[#
        {systems} template

        Renders all targets visible to / manageable by the current user.
      ]]
      [[ var view = localStorage.getItem('view-preference') || 'card-view'; ]]
      <div class="gutter blk switch-me [[= view ]]">
        [[ if (_.systems.length == 0) { ]]
          <h2>Protected Data Systems</h2>
          <div class="no-data">You have not yet configured any data systems to protect.</div>
        [[ } else { ]]
          <h2>Protected Data Systems
            <ul class="switcher">
              <li><a href="switch:card-view" title="Card-based View"><img src="/i/cards.png" /></a></li>
              <li><a href="switch:lean-view" title="Lean Table View"><img src="/i/table.png" /></a></li>
            </ul>
          </h2>
          <table class="lean">
            <thead>
              <tr>
                <th>Name</th>
                <th>Schedule</th>
                <th>Retention</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              [[ $.each(_.systems, function (i, target) { ]]
              <tr class="[[ if (!target.ok) { ]]fail[[ } else { ]]ok[[ } ]]">
                <td class="name">
                  <img src="i/shield-[[= target.ok ? 'ok' : 'fail' ]].svg">
                  [[= target.name ]]
                </td>
                <td class="schedule">
                  [[ $.each(target.jobs, function (j, job) { ]]
                  runs [[= job.schedule ]]<br>
                  [[ }); ]]
                </td>
                <td class="retain">
                  [[ $.each(target.jobs, function (j, job) { ]]
                  [[= job.keep.n ]] backups / [[= job.keep.days ]] days<br>
                  [[ }); ]]
                </td>
                <td><a href="#!/systems/system:uuid:[[= target.uuid ]]">view details</a></td>
              </tr>
              [[ }); ]]
            </tbody>
          </table>

          <div class="cards">
            [[ $.each(_.systems, function (i, target) { ]]
            <div class="job card [[ if (!target.ok) { ]]fail[[ } else { ]]ok[[ } ]]">
              <a href="#!/systems/system:uuid:[[= target.uuid ]]">
              <img src="i/shield-[[= target.ok ? 'ok' : 'fail' ]].svg">
              <h3>[[= target.name ]]</h3>
              <ul class="details">
                <li>[[ if (target.compression == "none") { ]]backups will <strong>not</strong> be compressed.
                    [[ } else { ]]backups will be compressed via <tt>[[= target.compression ]]</tt>[[ } ]]</li>
              </ul>
              [[ $.each(target.jobs, function (j, job) { ]]
              <ul class="details">
                <li>runs [[= job.schedule ]]</li>
                <li>keep [[= job.keep.n ]] backups ([[= job.keep.days ]] days)</li>
              </ul>
              <div class="graph[[ if (!job.ok) { ]] fail[[ } ]]">
                <div class="from">[[= job.from ]]</div>
                <div class="bar"></div>
                <div class="to">[[= job.to ]]</div>
              </div>
              [[ }); ]]
              </a>
            </div>
            [[ }); ]]
          </div>
        </div>
        [[ } ]]
    <!-- }}} --></script>
    <script type="text/html" id="tpl--system"><!-- {{{ -->
      [[#
        {system} template

        Renders all of the jobs and backup archives for a single target.
        Enables operators to easily see when a given system is backed up,
        and facilitates quick and easy access to restore valid archives.
      ]]
          <div class="gutter" data-system-uuid="[[= _.target.uuid ]]" data-system-name="[[= _.target.name ]]">
            <div class="job card [[= _.target.ok ? 'ok' : 'fail' ]]">
              <img src="i/shield-[[= _.target.ok ? 'ok' : 'fail' ]].svg">
              <h3>[[= _.target.name ]]</h3>
              <ul class="details">
                <li>[[ if (_.target.compression == "none") { ]]backups will <strong>not</strong> be compressed.
                    [[ } else { ]]backups will be compressed via <tt>[[= _.target.compression ]]</tt>[[ } ]]</li>
              </ul>
              [[ $.each(_.target.jobs, function (i, job) { ]]
              <ul class="details">
                <li>runs [[= job.schedule ]] &mdash; <a href="run:[[= job.uuid ]]">run now</a></li>
                <li>keep [[= job.keep.n ]] backups ([[= job.keep.days ]] days)</li>
              </ul>
              <div class="graph[[ if (!job.ok) { ]] fail[[ } ]]">
                <div class="from">[[= job.from ]]</div>
                <div class="bar"></div>
                <div class="to">[[= job.to ]]</div>
              </div>
              [[ }); ]]
            </div>

            <div class="job summary">
              <h2>Notes</h2>
              <div class="notes">[[ if (_.target.notes) { ]]
                [[= _.target.notes ]]
              [[ } else { ]]
                <div class="no-data">No notes provided.  Too bad.</div>
              [[ } ]]</div>
            </div>

            <h2>Timeline</h2>
            [[ if (_.target.tasks.length > 0) { ]]
            <div class="timeline">
                [[ $.each(_.target.tasks, function (i, task) { ]]
                  [[ task.is = {};
                     task.is.handled  = (task.stopped_at
                                      && task.status != 'done'
                                      && task.ok);
                  ]]
                <div class="event [[= task.type ]] [[= (task.status == 'done' ? 'ok' : task.status) ]][[ if (task.notes != "") { ]] noted[[ } ]][[ if (task.is.handled) { ]] handled[[ } ]]" data-task-uuid="[[= task.uuid ]]"[[ if (task.archive) { ]] data-archive-uuid="[[= task.archive.uuid ]]" data-archive-taken="[[= task.started_at ]]"[[ } ]]>
                  <ul>
                    <li class="date">[[ if (task.started_at == "") { ]]
                      <em>scheduled / pending</em>
                    [[ } else { ]]
                      [[= strftime("%b %d %Y", task.started_at) ]]
                    [[ } ]]</li>
                    [[ if (task.type != "backup") { ]]
                      <li class="tag">[[= task.type ]]</li>
                    [[ } ]]
                    [[ if (task.type == "backup") { ]]
                      [[ if (task.owner == "system") { ]]
                      <li class="desc">[[= maybe(task.archive && task.archive.schedule, 'Scheduled Backup') ]]</li>
                      <li class="meta">run automatically per job schedule at [[= strftime("%l:%M%P", task.requested_at) ]]</li>
                      [[ } else { ]]
                      <li class="desc">Ad Hoc Backup</li>
                      <li class="meta">initiated by [[= task.owner ]] at [[= strftime("%l:%M%P", task.requested_at) ]]</li>
                      [[ } ]]
                    [[ } else if (task.type == "restore") { ]]
                      <li class="desc">Manual Restore</li>
                      <li class="meta">initiated by [[= task.owner ]] at [[= strftime("%l:%M%P", task.requested_at) ]]</li>
                    [[ } else if (task.type == "purge") { ]]
                      <li class="desc">Purge Expired Archive</li>
                      <li class="meta">...</li>
                    [[ } else { ]]
                      <li class="desc">[[= task.type ]] Task</li>
                    [[ } ]]
                    [[ if (task.notes != "") { ]]
                    <li class="note"><strong>Note:</strong> [[= html(task.notes) ]]</li>
                    [[ } ]]
                    <li class="expand"><a href="task:[[= task.uuid ]]">full task log</a></li>
                  </ul>
                  <div class="task"></div>
                </div>
                [[ }); ]]
            </div>
            [[ } else { ]]
            <div class="no-data">No backups or restores have been performed.</div>
            [[ } ]]
            <a class="paginated-loading" href="load_more">Load More</a>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--task"><!-- {{{ -->
      [[#
        {task} template

        Displays the details of a single task, including the task log.
        Optionally, if this is being displayed in the {system} view,
        also display a big RESTORE button in the task output.
      ]]
<pre class="task-[[= _.task.status ]][[ if (_.task.ok) { ]] override[[ } ]]"><code><div>
<button class="close" rel="close">X</button>
<button class="annotate" rel="annotate:[[= _.task.uuid ]]">Annotate</button>[[ if (_.restorable) { ]]<button class="restore" rel="restore:[[= _.task.uuid ]]">Restore</button>[[ } ]]
<form class="annotate">
<input type="hidden" name="uuid" value="[[= _.task.uuid ]]" />
[[ if (_.task.status == "failed") { ]]
<p><input type="checkbox" name="disposition"
            id="annotask-ok"[[ if (_.task.ok) { ]] checked[[ } ]]><label for="annotask-ok">Nothing to worry about</label></p>
[[ } ]]
<p><textarea name="notes" id="notes"
            placeholder="no notes recorded yet...">[[= maybe(_.task.notes, '') ]]</textarea></p>
<button>Save</button>
</form>

</div><em>task <em>[[= _.task.uuid ]]</em></em>
<em>[[= _.task.type ]] task[[ if (_.task.started_at != "") { ]] started <em>[[= strftime("%c", _.task.started_at) ]][[ } ]]</em>[[
if (_.task.type == "purge") { ]]
purging archive <em>[[= _.task.archive_uuid ]]</em>[[
} else if (_.task.type == "restore") { ]]
restoring from archive <em>[[= _.task.archive_uuid ]]</em>[[
} ]]
initiated by <em>[[= _.task.owner ]]</em> at <em>[[= strftime("%c", _.task.requested_at) ]]</em></em>

[[= _.task.log ]]

<em>[[ if (_.task.stopped_at > _.task.started_at && _.task.status != "pending") {
]]task ran for <em>[[= duration(tdiff(_.task.started_at, _.task.stopped_at)) ]]</em>
[[

if (_.task.type == 'backup') {
if (_.task.archive_uuid != "") {
    ]]generated archive <em>[[= _.task.archive_uuid ]]</em>
for job <em>[[= _.task.job_uuid ]]</em>
[[
} else {
]]no archive was generated.
[[
}
} ]][[= _.task.type ]] task finished at <em>[[= strftime("%c", _.task.stopped_at) ]]</em> with status <em>[[= _.task.status ]]</em>
[[
}
]]</em></code></pre>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--stores"><!-- {{{ -->
      [[#
        {stores} template

        Renders the currently defined (visible) storage endpoints,
        and in some cases allows for user-management of their configurations.
      ]]
      [[ var view = localStorage.getItem('view-preference') || 'card-view'; ]]
          <div class="gutter blk switch-me [[= view ]]">
            [[ if ((_.admin  && $global.auth.is.system.engineer)
                || (!_.admin && $global.auth.is.tenant[$global.auth.tenant.uuid].engineer)) { ]]
            <a class="new" href="#!/[[= _.admin ? 'admin/' : '' ]]stores/new">Configure a New Cloud Storage System&raquo;</a>
            [[ } ]]
            [[ if (_.admin) { ]]
              <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
              <h2><strong>Global</strong> Cloud Storage Systems[[ if (_.stores.length > 0) { ]]
                <ul class="switcher">
                  <li><a href="switch:card-view" title="Card-based View"><img src="/i/cards.png" /></a></li>
                  <li><a href="switch:lean-view" title="Lean Table View"><img src="/i/table.png" /></a></li>
                </ul>
              [[ } ]]</h2>
              <p class="notice">These are <strong>global</strong> definitions; these storage
              configurations can be used by any tenant, although they will be unable to see
              any of the sensitive details.</p>
            [[ } else { ]]
            <h2>Cloud Storage Systems[[ if (_.stores.length > 0) { ]]
                <ul class="switcher">
                  <li><a href="switch:card-view" title="Card-based View"><img src="/i/cards.png" /></a></li>
                  <li><a href="switch:lean-view" title="Lean Table View"><img src="/i/table.png" /></a></li>
                </ul>
              [[ } ]]</h2>
            [[ } ]]

            [[ if (_.stores.length == 0) { ]]
            <div class="no-data">No Cloud Storage Systems have been configured yet.</div>
            [[ } else { ]]
            <table class="lean">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Notes</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                [[ $.each(_.stores, function (i, store) { ]]
                <tr class="[[ if (!store.healthy) { ]]fail[[ } else { ]]ok[[ } ]]">
                  <td class="name">
                    <img src="i/shield-[[= store.healthy ? 'ok' : 'fail' ]].svg">
                    [[= store.name ]]
                  </td>
                  <td class="type">[[= store.plugin ]]</td>
                  <td class="notes">
                    [[ if (store.summary) { ]]
                      [[= store.summary ]]
                    [[ } else { ]]
                      <div class="no-data">No notes provided.  Too bad.</div>
                    [[ } ]]
                  </td>
                  <td><a href="#!/[[= _.admin ? 'admin/' : '' ]]stores/store:uuid:[[= store.uuid ]]">view details</a></td>
                </tr>
                [[ }); ]]
              </tbody>
            </table>

            <div class="cards">
            [[ $.each(_.stores, function (i, store) { ]]
            <div class="store card [[ if (!store.healthy) { ]]fail[[ } else { ]]ok[[ } ]]">
              [[ if (store.global) { ]]<span class="type">Shared</span>[[ } ]]
              <a href="#!/[[= _.admin ? 'admin/' : '' ]]stores/store:uuid:[[= store.uuid ]]">
              <img src="i/shield-[[= store.healthy ? 'ok' : 'fail' ]].svg">
              <h3>[[= store.name ]]</h3>
              <div class="notes">[[ if (store.summary) { ]]
                [[= store.summary ]]
              [[ } else { ]]
                <div class="no-data">No notes provided.  Too bad.</div>
              [[ } ]]</div>
              <div class="graph[[ if (!store.healthy) { ]] fail[[ } ]]">
                <div class="to">[[= store.plugin ]]</div>
              </div>
              </a>
            </div>
            [[ }); ]]
            </div>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--store"><!-- {{{ -->
      [[#
        {store} template

        Renders a single storage endpoint configuration, including its
        usage information and provide management capabilities.
      ]]
          <div class="gutter blk store">
            <a class="breadcrumb" href="#!/[[= _.admin ? 'admin/' : '' ]]stores">&laquo; Back to Cloud Storage Systems</a>
            <h2><div class="plugin">[[= _.store.plugin ]]</div>[[= _.store.name ]]</h2>

            [[ if (_.admin || !_.store.global) { ]]
              [[ if ((_.admin && $global.auth.is.system.engineer)
                  || (!_.admin && $global.auth.is.tenant[$global.auth.tenant.uuid].engineer)) { ]]
              <a class="edit"   href="#!/[[= _.admin ? 'admin/' : '' ]]stores/edit:uuid:[[= _.store.uuid ]]">Edit</a>
              <a class="delete" href="#!/[[= _.admin ? 'admin/' : '' ]]stores/delete:uuid:[[= _.store.uuid ]]">Delete</a>
              [[ } ]]
            [[ } ]]

            <div class="summary">[[= _.store.summary ]]</div>

            <div class="side-by-side">
              <h3>Storage Details</h3>
              <dl>
                <dt>Backup Archives</dt>
                <dd>[[= _.store.archives ]]</dd>

                <dt>Storage Used</dt>
                <dd>[[= bytes(_.store.used) ]]</dd>

                <dt>Daily Delta</dt>
                <dd>[[= bytes(_.store.daily_delta) ]]</dd>
              </dl>
            </div>

            <div class="side-by-side">
              <h3>Configuration</h3>
              <dl>
                <dt>SHIELD Agent</dt>
                <dd>[[= _.store.agent ]]</dd>

                [[ $.each(_.store.display_config, function (i, kv) {
                     if (kv.value == "" || kv.value == false) { return; } ]]
                <dt>[[= kv.label ]]</dt>
                <dd>[[= kv.value ]]</dd>
                [[ }); ]]
              </dl>
            </div>

            [[ if (_.store.archives > 0) { ]]
            <div class="meter">
              <svg width="500" height="400" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <style>
                    rect.outer    { fill: #ccc; }
                    rect.fill     { fill: #0071bc; }
                    circle.marker { fill: #333; }
                    line.marker { stroke: #333; stroke-width: 1px; }

                    text.label      { font-size: 20px; font-family: sans-serif; }
                    text.size       { font-size: 40px; font-family: sans-serif; }
                    text.size tspan { font-size: 20px; font-weight: bold; }

                    g.current      .size { fill: #7ac943; }
                    g.current.warn .size { fill: orange; }
                    g.threshold    .size { fill: #0071bc; }
                    g.projected    .size { fill: #ff1d25; }
                  </style>
                </defs>

                [[# Base value of 1M, add 20% padding for spacing ]]
                [[ var total = Math.max(_.store.used, _.store.threshold, readableToBytes("1M")) * 1.2; ]]
                <rect class="outer" x="0" y="200" width="100%" height="36"></rect>
                <rect class="fill" x="2" y="202" width="[[= 100.0 * _.store.used / total ]]%" height="32"></rect>

                [[ if (_.store.threshold > _.store.used) { ]]
                [[# "current" marker ]]
                <g class="current" transform="translate(2)">
                  <line class="marker" x1="[[= 100.0 * _.store.used / total ]]%" x2="[[= 100.0 * _.store.used / total ]]%" y1="198" y2="53"></line>
                  <circle class="marker" cx="[[= 100.0 * _.store.used / total ]]%" cy="53" r="3"></circle>
                  <g transform="translate(6)">
                    <text x="[[= 100.0 * _.store.used / total ]]%" y="60" class="label">Current</text>
                    <text x="[[= 100.0 * _.store.used / total ]]%" y="100" class="size">[[= bytes(_.store.used) ]]</text>
                  </g>
                </g>

                [[# "threshold" marker ]]
                <g class="threshold" transform="translate(2)">
                  <line class="marker" x1="[[= 100.0 * _.store.threshold / total ]]%" x2="[[= 100.0 * _.store.threshold / total ]]%" y1="198" y2="133"></line>
                  <circle class="marker" cx="[[= 100.0 * _.store.threshold / total ]]%" cy="133" r="3"></circle>
                  <g transform="translate(6)">
                    <text x="[[= 100.0 * _.store.threshold / total ]]%" y="140" class="label">Threshold</text>
                    <text x="[[= 100.0 * _.store.threshold / total ]]%" y="180" class="size">[[= bytes(_.store.threshold) ]]</text>
                  </g>
                </g>
                [[ } else { ]]

                [[# "threshold" marker ]]
                <g class="threshold" transform="translate(2)">
                  <line class="marker" x1="[[= 100.0 * _.store.threshold / total ]]%" x2="[[= 100.0 * _.store.threshold / total ]]%" y1="198" y2="53"></line>
                  <circle class="marker" cx="[[= 100.0 * _.store.threshold / total ]]%" cy="53" r="3"></circle>
                  <g transform="translate(6)">
                    <text x="[[= 100.0 * _.store.threshold / total ]]%" y="60" class="label">Threshold</text>
                    <text x="[[= 100.0 * _.store.threshold / total ]]%" y="100" class="size">[[= bytes(_.store.threshold) ]]</text>
                  </g>
                </g>

                [[# "current" marker ]]
                <g class="current warn" transform="translate(2)">
                  <line class="marker" x1="[[= 100.0 * _.store.used / total ]]%" x2="[[= 100.0 * _.store.used / total ]]%" y1="198" y2="133"></line>
                  <circle class="marker" cx="[[= 100.0 * _.store.used / total ]]%" cy="133" r="3"></circle>
                  <g transform="translate(6)">
                    <text x="[[= 100.0 * _.store.used / total ]]%" y="140" class="label">Current</text>
                    <text x="[[= 100.0 * _.store.used / total ]]%" y="180" class="size">[[= bytes(_.store.used) ]]</text>
                  </g>
                </g>
                [[ } ]]

                [[ if (false) { ]]
                [[# "projected" marker ]]
                <g class="projected" transform="translate(-3)">
                  <line class="marker" x1="[[= 100.0 * _.store.projected / total ]]%" x2="[[= 100.0 * _.store.projected / total ]]%" y1="238" y2="293"></line>
                  <circle class="marker" cx="[[= 100.0 * _.store.projected / total ]]%" cy="293" r="3"></circle>
                  <g transform="translate(-6)"><text x="[[= 100.0 * _.store.projected / total ]]%" y="260" class="label" text-anchor="end">Projected</text>
                    <text x="[[= 100.0 * _.store.projected / total ]]%" y="300" class="size" text-anchor="end">[[= bytes(_.store.projected) ]]</text>
                  </g>
                </g>
                [[}]]
              </svg>
            </div>
          </div>
          [[ } ]]
    <!-- }}} --></script>
    <script type="text/html" id="tpl--stores-form"><!-- {{{ -->
      [[#
        {stores-form} template

        Renders a form for creating new storage endpoints, and
        editing existing stores.
      ]]
          <div class="gutter blk">
            [[ if (_.store) { ]]
            <a class="breadcrumb" href="#!/[[= _.admin ? 'admin/' : '' ]]stores/store:uuid:[[= _.store.uuid ]]">&laquo; Back to "[[= _.store.name ]]" Cloud Storage System</a>
            [[ } else { ]]
            <a class="breadcrumb" href="#!/[[= _.admin ? 'admin/' : '' ]]stores">&laquo; Back to Cloud Storage Systems</a>
            [[ } ]]
            <h2>[[ if (_.store) { ]]Edit[[ } else { ]]New[[ } ]] Storage System</h2>

            [[ if (!_.agents || _.agents.length == 0) { ]]
            <p class="notice failure">There are currently no Agents registered with
            this SHIELD Core; you will not be able to configure Storage Systems until
            that changes.</p>
            [[ } else { ]]
            <form>
              <div class="error"></div>

              <div class="ctl" data-field="name">
                <label for="store-name">Name</label>
                <span class="errors">
                  <span data-error="missing">You must provide a name for this new storage system.</span>
                </span>
                <div class="widget">
                  <input type="text" id="store-name" name="name" class="autofocus"
                    [[ if (_.store) { ]]value="[[= _.store.name ]]"[[ } ]]/>
                  <p class="help">Pick a memorable or descriptive name for this storage system,
                  so that other operators can determine when to use it.</p>
                </div>
              </div>

              <div class="ctl" data-field="summary">
                <label for="store-summary">Notes</label>
                <div class="widget">
                  <textarea id="store-summary" name="summary">[[= _.store ? _.store.summary : '' ]]</textarea>
                  <p class="help">If you want, you can add a longer description.</p>
                </div>
              </div>

              <div class="ctl" data-field="threshold">
                <label for="store-threshold">Threshold</label>
                <span class="errors">
                  <span data-error="missing">You must provide a threshold for this new storage system.</span>
                </span>
                <div class="widget">
                  <input type="text" id="store-threshold" name="threshold" placeholder="i.e. 10G, 500M, etc."
                    [[ if (_.store) { ]]value="[[= bytes(_.store.threshold) ]]"[[ } ]]/>
                    <p class="help">Select a reasonable threshold for storage size warnings.</p>
                </div>
              </div>

              <div class="ctl" data-field="agent">
                <label for="store-agent">Agent</label>
                <span class="errors">
                  <span data-error="missing">You must select which SHIELD Agent to use to access this storage system.</span>
                </span>
                <div class="widget">
                  <select id="store-agent" name="agent" value="[[= _.store ? _.store.agent : '' ]]">
                    <option></option>
                    [[ var found = false; ]]
                    [[ $.each(_.agents, function (i, agent) { ]]
                    [[   if (_.store && _.store.agent == agent.address) { ]]
                    <option selected value="[[= agent.uuid ]]|[[= agent.address ]]">[[= agent.name ]] (at [[= agent.address ]])</option>
                    [[   } else { ]]
                    <option value="[[= agent.uuid ]]|[[= agent.address ]]">[[= agent.name ]] (at [[= agent.address ]])</option>
                    [[   } ]]
                    [[ }); ]]
                  </select>
                </div>
              </div>

              <div id="choose-plugin"></div>
              <div id="configure-plugin"></div>

              <button class="go">[[ if (_.store) { ]]Save[[ } else { ]]Create[[ } ]]</button>
            </form>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--stores-delete"><!-- {{{ -->
      [[#
        {stores-delete}

        A modal interaction screen that requires the operator to acknowledge
        that what they are about to do will result in the destruction of
        configuration data.
      ]]
          <div class="confirm">
            <h2>Delete The <em>[[= _.store.name ]]</em> Cloud Storage System?</h2>

            <p>You have requested that S.H.I.E.L.D. remove the configuration for
            the cloud storage system "[[= _.store.name ]]".  <em>This is a
            irreversible action; it cannot be undone.</em></p>

            <p class="q">Are you sure you want to delete <em>[[= _.store.name ]]</em>?</p>
            <div class="a">
              <button class="danger" rel="yes">Yes, Delete It</button>
              <button class="safe" rel="close">No, Cancel This Operation</button>
            </div>
          </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--policies"><!-- {{{ -->
      [[#
        {policies} template

        Renders the list of all retention policies
      ]]
          <div class="gutter blk">
            [[ if ((_.admin  && $global.auth.is.system.engineer)
                || (!_.admin && $global.auth.is.tenant[$global.auth.tenant.uuid].engineer)) { ]]
            <a class="new" href="#!/[[= _.admin ? 'admin/' : '' ]]policies/new">Create a New Retention Policy [[= _.admin ? 'Template ' : '' ]]&raquo;</a>
            [[ } ]]
            [[ if (_.admin) { ]]
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <h2>Retention Policy <strong>Templates</strong></h2>
            <p class="notice">These are <strong>template</strong> definitions; they will be
            copied into new tenants as they are created.  Changes here will <strong>not</strong>
            take effect on pre-existing tenants.</p>
            [[ } else { ]]
            <h2>Retention Policies</h2>
            [[ } ]]
            [[ if (_.policies.length == 0) { ]]
            <div class="no-data">No Retention [[= _.admin ? 'Policy Templates' : 'Policies' ]] have been created yet.</div>
            [[ } else { ]]
            <table>
              <thead><tr>
                <th>Name</th>
                <th>Retention Period</th>
                <th></th>
                <th></th>
              </tr></thead>
              <tbody>
                [[ $.each(_.policies, function (i, policy) { ]]
                <tr>
                  <td>[[= policy.name ]]</td>
                  <td>[[= policy.days ]] day[[ if (policy.days != 1) { ]]s[[ } ]]</td>
                  <td><a href="#!/[[= _.admin ? 'admin/' : '']]policies/edit:uuid:[[= policy.uuid ]]">edit</a></td>
                  <td><a href="#!/[[= _.admin ? 'admin/' : '']]policies/delete:uuid:[[= policy.uuid ]]">delete</a></td>
                </tr>
                [[ }); ]]
              </tbody>
            </table>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--policies-form"><!-- {{{ -->
      [[#
        {policies-form} template

        Renders a form for creating new retention policies, and
        editing existing retention policies.
      ]]
          <div class="gutter blk">
            <a class="breadcrumb" href="#!/[[= _.admin ? 'admin/' : '' ]]policies">&laquo; Back to Retention [[= _.admin ? 'Policy Templates' : 'Policies' ]]</a>
            <h2>[[ if (_.policy) { ]]Edit[[ } else { ]]New[[ } ]] Retention Policy[[= _.admin ? ' Template' : '' ]]</h2>

            <form>
              <div class="error"></div>

              <div class="ctl" data-field="name">
                <label for="policy-name">Name</label>
                <span class="errors">
                  <span data-error="missing">You must provide a name for this [[=  (_.policy) ? "existing" : "new" ]] retention policy.</span>
                  <span data-error="too-big">The name cannot exceed 100 characters</span>
                </span>
                <div class="widget">
                  <input type="text" id="policy-name" name="name" maxlength="100" class="autofocus" tabindex="0"
                    [[ if (_.policy) { ]]value="[[= _.policy.name ]]"[[ } ]]/>
                  <p class="help">Pick a memorable or descriptive name for this retention policy,
                  so that other operators can determine what to use it for.</p>
                </div>
              </div>

              <div class="ctl" data-field="expires">
                <label for="policy-days">Expiry (in days)</label>
                <span class="errors">
                  <span data-error="missing">You must specify an expiry of at least 1 day.</span>
                  <span data-error="invalid">This must be a positive, non-zero, whole number.</span>
                  <span data-error="too-big">Retention expiry cannot exceed 10 years (3660 days)</span>

                </span>
                <div class="widget">
                  <input type="text" id="policy-days" name="days"
                    [[ if (_.policy) { ]]value="[[= _.policy.days ]]"[[ } ]]/>
                  <p class="help">How long should archives be kept, under this retention policy.
                  At a minimum, archives must be kept for one day.</p>
                </div>
              </div>

              <button class="go">[[ if (_.policy) { ]]Save[[ } else { ]]Create[[ } ]]</button>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--policies-delete"><!-- {{{ -->
      [[#
        {policies-delete}

        A modal interaction screen that requires the operator to acknowledge
        that what they are about to do will result in the destruction of
        configuration data.
      ]]
          <div class="confirm">
            <h2>Delete The <em>[[= _.policy.name ]]</em> Retention Policy[[= _.admin ? ' Template' : '' ]]?</h2>

            <p>You have requested that S.H.I.E.L.D. remove the configuration for
            the retention policy[[= _.admin ? ' template' : '' ]] "[[= _.policy.name ]]".</p>

            <p class="q">Are you sure you want to delete <em>[[= _.policy.name ]]</em>?</p>
            <div class="a">
              <button class="danger" rel="yes">Yes, Delete It</button>
              <button class="safe" rel="close">No, Cancel This Operation</button>
            </div>
          </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--tenants"><!-- {{{ -->
      [[#
        {tenants} template

        Renders the list of all tenants (for site managers)
      ]]
          <div class="gutter blk">
            [[ if (_.admin) { ]]
              <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
              <a class="new" href="#!/admin/tenants/new">Create a New Tenant &raquo;</a>
            [[ } ]]
            <h2>Tenants</h2>
            [[ if (_.tenants.length == 0) { ]]
            <div class="no-data">No Tenants have been created yet.</div>
            [[ } else { ]]
            <table>
              <thead><tr>
                <th>Name</th>
                <th></th>
              </tr></thead>
              <tbody>
                [[ $.each(_.tenants, function (i, tenant) { ]]
                <tr>
                  <td>[[= tenant.name ]]</td>
                  <td><a href="#!/[[= _.admin ? 'admin/' : '' ]]tenants/edit:uuid:[[= tenant.uuid ]]">edit</a></td>
                </tr>
                [[ }); ]]
              </tbody>
            </table>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--tenants-form"><!-- {{{ -->
      [[#
        {tenants-form} template

        Renders a form for creating new tenants, and editing
        existing tenants.
      ]]
          <div class="gutter blk">
            [[ if (_.admin) { ]]
                <a class="breadcrumb" href="#!/admin/tenants">&laquo; Back to Tenants</a>
                <h2>[[ if (_.tenant) { ]]Edit[[ } else { ]]New[[ } ]] Tenant</h2>
            [[ } else { ]]
                <a class="breadcrumb" href="#!/systems">&laquo; Back to Systems</a>
                <h2> [[= _.tenant.name ]] - Tenant Settings</h2>
            [[ } ]]

            <form>
              <div class="error"></div>
              [[ if (_.admin) { ]]
              <div class="ctl" data-field="name">
                    <label for="tenant-name">Name</label>
                    <span class="errors">
                    <span data-error="missing">You must provide a name for this new tenant.</span>
                    </span>
                    <div class="widget">
                    <input type="text" id="tenant-name" name="name" class="autofocus"
                        [[ if (_.tenant) { ]]value="[[= _.tenant.name ]]"[[ } ]]/>
                    <p class="help">Pick a memorable or descriptive name for this tenant.</p>
                    </div>
              </div>
              [[ } ]]

              <div class="ctl">
                <label for="tenant-invite">People In This Tenant</label>
                <div class="widget">
                  <input type="text" name="invite" id="tenant-invite" autocomplete="off"
                         class="invite" placeholder="Invite people to join..." />

                  <table class="tenant-members">
                    <thead><tr>
                      <th></th>
                      <th>Display Name</th>
                      <th>Username</th>
                      <th>Role</th>
                    </tr></thead>
                    <tbody data-type="tenant">
                      [[ if (_.tenant) { ]]
                        [[ $.each(_.tenant.members, function (i, user) { ]]
                        <tr data-uuid="[[= user.uuid ]]" data-account="[[= user.account ]]">
                          <td><a href="banish:user"><img src="/i/delete.png"></a></td>
                          <td>[[= user.name ]]</td>
                          <td>[[= user.account ]]</td>
                          <td><span class="role" data-role="[[= user.role ]]">
                          [[= { admin      : "Administrator",
                                engineer   : "Engineer",
                                operator   : "Operator" }[user.role] ]]
                          </span></td>
                        </tr>
                        [[ }); ]]
                      [[ } ]]
                    </tbody>
                  </table>
                </div>
              </div>
              [[ if (_.admin) { ]]
                <button class="go">[[ if (_.tenant) { ]]Save[[ } else { ]]Create[[ } ]]</button>
              [[ } ]]
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--tenants-form-invitee"><!-- {{{ -->
      [[#
        {tenants-form-invitee} template

        Renders a table row in the invitee management UI control.
      ]]
                      <tr data-uuid="[[= _.user.uuid ]]" data-account="[[= _.user.account ]]">
                        <td><a href="banish:user"><img src="/i/delete.png"></a></td>
                        <td>[[= _.user.name ]]</td>
                        <td>[[= _.user.account ]]</td>
                        <td><span class="role" data-role="[[= _.user.role ]]">
                        [[= { admin      : "Administrator",
                              engineer   : "Engineer",
                              operator   : "Operator" }[_.user.role] ]]
                        </span></td>
                      </tr>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--userlookup-results"><!-- {{{ -->
      [[#
        {userlookup-results} template

        Displays the "dropdown" list of user information,
        after the /v2/ui/users endpoint has fired in a
        userlookup control.
      ]]
      <div class="userlookup-results">
        <ul>
          [[ $.each(_, function (i, user) { ]]
          <li data-idx="[[= i ]]" data-uuid="[[= user.uuid ]]"><strong>[[= user.name ]]</strong><p>[[= user.account ]]</p></li>
          [[ }); ]]
        </ul>
      </div>
    <!-- }}} --></script>

    <script type="text/html" id="tpl--admin"><!-- {{{ -->
      [[#
        {admin} template

        Renders the administrator control panel.
      ]]
          <div class="gutter blk" id="admin-home">
            <h2>SHIELD Administration</h2>
            <ul>
              [[ if ($global.auth.is.system.manager) { ]]
              <li><a href="#!/admin/tenants">Tenants</a>
                <p>Tenants separate and isolate subsets of your users from one another, so that
                they can neither see nor affect the systems, storage, and retention policies
                of one another.</p>
              </li>
              [[ } ]]

              <li><a href="#!/admin/stores">Global Storage Systems</a>
                <p>You may elect to configure some global storage systems, which can be used,
                but not modified, by all tenants; only SHIELD technicians, engineers, and
                admins are able to view and edit their configuration.</p>
              </li>

              <li><a href="#!/admin/policies">Retention Policy Templates</a>
                <p>You can define retention policy templates that will be copied into each
                new tenant as they are created.  This can be handy for getting people started
                quickly, and using your best practices for data retention.</p>
              </li>

              [[ if ($global.auth.is.system.admin) { ]]
              <li><a href="#!/admin/agents">Agents of SHIELD</a>
                <p>SHIELD performs backup and restore operations through <em>agents</em> that run
                on other machines.  These agents register with the SHIELD Core, and provide
                metadata that is essential to the configuration of your data protection jobs.</p>
              </li>
              <li><a href="#!/admin/auth">Authentication Providers</a>
                <p>SHIELD can authenticate (and authorize) users against 3rd party OAuth2
                implementations like Github and UAA.  These authentication <em>providers</em>
                are configured in the SHIELD Core configuration file, but you can review their
                configuration here.</p>
              </li>
              [[ } ]]

              [[ if ($global.auth.is.system.manager) { ]]
              <li><a href="#!/admin/users">Local User Management</a>
                <p>Local SHIELD user accounts can be set up to provide access to your SHIELD if
                you do not want to use a 3rd party authentication provider.  Local users can be
                granted system roles and be given roles on tenants.</p>
              </li>
              [[ } ]]

              <li><a href="#!/admin/rekey">Rekey SHIELD Core</a>
                <p>The SHIELD Core stores all of the archive encryption keys in a secure storage
                vault, which is protected by the SHIELD <em>master password</em>.  If you need or
                want to, you can rekey this SHIELD Core and pick a new master password.</p>
              </li>

              [[ if ($global.auth.is.system.admin) { ]]
              <li><a href="#!/admin/sessions">Manage User Sessions</a>
                <p>Upon login, users are granted a session token to be used for the duration of
                their access. These sessions can be revoked via this interface, or expire
                naturally over time requiring the user to reauthenticate.</p>
              </li>
              [[ } ]]
            </ul>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--agents"><!-- {{{ -->
      [[#
        {agents} template

        Renders the list of registered agents, with information about each
        registered agent, its version, health, etc.
      ]]
          <div class="gutter blk">
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <h2>Agents of SHIELD</h2>
            [[ if (_.agents.length == 0) { ]]
            <div class="no-data">No Agents have registered with this S.H.I.E.L.D. instance yet.</div>
            [[ } else { ]]
            <table>
              <thead><tr>
                <th>Name</th>
                <th>Address</th>
                <th>Version</th>
                <th>Status</th>
                <th>Last Seen</th>
                <th>Visible?</th>
                <th></th>
              </tr></thead>
              <tbody>
                [[ $.each(_.agents, function (i, agent) { ]]
                    [[ var problems = _.problems[agent.uuid]; ]]
                <tr data-agent-uuid="[[= agent.uuid ]]"[[ if (problems.length != 0) { ]] class="noted fail"[[ } ]]>
                  <td class="k">[[= agent.name ]]</td>
                  <td>[[= agent.address ]]</td>
                  <td>[[= agent.version ]]</td>
                  <td>[[ if (agent.status == "ok") { ]]
                    <span class="ok">[[= agent.status ]]</span>
                  [[ } else { ]]
                    <span class="fail">[[= agent.status ]]</span>
                  [[ } ]]
                  </td>
                  <td>[[= trelative(agent.last_seen_at, 90*86400) ]]</td>
                  <td>[[ if (agent.hidden) { ]]no[[ } else { ]]yes[[ } ]]</td>
                  <td>[[ if (agent.hidden) { ]]<a href="#" rel="show">show</a>
                      [[ } else            { ]]<a href="#" rel="hide">hide</a>[[ } ]]
                      | <a href="#" rel="resync">resync</a></td>
                </tr>
                [[ if (problems.length != 0) { ]]
                <tr class="note fail">
                  <td colspan="7">
                    [[ $.each(problems, function (j, problem) { ]]
                    <strong>Note:</strong><div>[[= problem ]]</div>
                    [[ }); ]]
                  </td>
                </tr>
                [[ } ]]
                [[ }); ]]
              </tbody>
            </table>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--auth-providers"><!-- {{{ -->
      [[#
        {auth-providers} template

        Renders the list of configured authentication providers, including
        details about how to integrate with their respective 3rd party auth
        systems, i.e. Github OAuth2 App registration, CF/UAA client creation,
        etc.
      ]]
          <div class="gutter blk" id="auth-providers">
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <h2>Authentication Providers</h2>
            <table>
              <thead><tr>
                <th>Name</th>
                <th>Identifier</th>
                <th>Type</th>
                <th>Usage</th>
              </tr></thead>
              <tbody>
              [[ $.each(_.providers, function (i, provider) { ]]
                <tr>
                  <td>[[= provider.name ]]</td>
                  <td><span class="tag">[[= provider.identifier ]]</span></td>
                  <td>[[= provider.type ]] (<a href="#!/admin/auth/config:name:[[= provider.identifier ]]">configuration</a>)</td>
                  <td>[[= provider.usage ]]</td>
                </tr>
              [[ }); ]]
              </tbody>
            </table>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--auth-provider-config"><!-- {{{ -->
      [[#
        {auth-provider-config} template

        Renders the configuration of a single authentication provider,
        to help administrators set up the external endpoints, i.e. by
        showing the uaac commands to run to configure UAA, or the fields
        to fill out in the Github OAuth UI.
      ]]
          <div class="gutter blk" id="auth-provider">
            <a class="breadcrumb" href="#!/admin/auth">&laquo; Back to Authentication Providers</a>
            <h2>[[= _.provider.name ]] Authentication Provider ([[= _.provider.identifier ]])</h2>
            [[ var p = _.provider.properties; ]]
            [[ if (_.provider.type == 'github') { ]]
            <p>This is a <strong>Github</strong>-backed authentication provider, targeting
            [[ if (!p.github_endpoint || p.github_endpoint == "" || p.github_endpoint.match(/github\.com/)) { ]]
            public Github.
            [[ } else { ]]
            a private, on-premise Github Enterprise (<a href="[[= p.github_endpoint ]]">[[= p.github_endpoint ]]</a>).
            [[ } ]]</p>
            <h3>Configuring Github</h3>
            <p>First, you will need
            to <a href="https://github.com/settings/applications/new">register a new
            OAuth2 application</a> for this SHIELD:</p>

            <div class="github-auth-overlay-register">
              <span class="appname">SHIELD</span>
              <span class="homepage">[[= website() ]]</span>
              <span class="callback">[[= website() ]][[= _.provider.redirect ]]</span>
            </div>

            <p>Once your application is registered, Github will provide you
            with a new Client ID and Client Secret:</p>

            <div class="github-auth-overlay-app">
              <span class="client-id"></span>
              <span class="client-secret"></span>
            </div>

            <p>These <strong>must</strong> match the values you configure
            in the SHIELD Core configuration YAML file.</p>

            [[ } else { ]]
            <p>This is a <strong>UAA</strong>-backed authentication provider.</p>

            <h3>Configuring Your UAA Client</h2>
            <p>In order for this authentication provider to function, you may need
            to add a new UAA client for this SHIELD.  The following commands should
            suffice:</p>

<pre><code>$ uaac target <span class="hi">[[= p.uaa_endpoint ]]</span>
$ uaac token client get admin

$ uaac client add '<span class="hi">[[= p.client_id ]]</span>' \
    --name S.H.I.E.L.D. \
    --scope openid \
    --authorities uaa.none \
    --authorized_grant_types authorization_code \
    --redirect_uri <span class="hi">[[= website() ]][[= _.provider.redirect ]]</span> \
    --access_token_validity  180 \
    --refresh_token_validity 180 \
    --secret '<span class="hi">[[= p.client_secret ]]</span>'</code>
</pre>

            [[ } ]]
            <h3>Raw Configuration</h3>
            <pre><code>[[= JSON.stringify(_.provider, null, 2) ]]</code></pre>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--rekey"><!-- {{{ -->
      [[#
        {rekey} template

        Renders the list of configured authentication providers, including
        details about how to integrate with their respective 3rd party auth
        systems, i.e. Github OAuth2 App registration, CF/UAA client creation,
        etc.
      ]]
          <div class="gutter blk" id="rekey">
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            <h2>Rekey Shield Master Password</h2>

            <form class="rekey">
              <div class="error"></div>

              <div class="ctl" data-field="current">
                <label for="rekey-current">Current Master Password</label>
                <span class="errors">
                  <span data-error="missing">You must supply the current SHIELD master password</span>
                </span>
                <div class="widget">
                  <input type="password" id="rekey-current" name="current"
                         class="autofocus">
                  <p class="help">In order to rekey this SHIELD core, you must specify your
                  current master password so that SHIELD can temporarily decrypt the secure
                  storage credentials.</p>
                </div>
              </div>

              <div class="ctl" data-field="new">
                <label for="rekey-new">New Master Password</label>
                <span class="errors">
                  <span data-error="missing">You must supply a new master password</span>
                </span>
                <div class="widget">
                  <input type="password" id="rekey-new" name="new">
                </div>
              </div>

              <div class="ctl" data-field="confirm">
                <label for="rekey-confirm">Confirm</label>
                <span class="errors">
                  <span data-error="missing">You must confirm your new master password</span>
                  <span data-error="mismatch">Your passwords do not match</span>
                </span>
                <div class="widget">
                  <input type="password" id="rekey-confirm" name="confirm">
                  <p class="help">Once your SHIELD is rekeyed, you will have to use the
                  <strong>new master password</strong> to unlock it.</p>
                </div>
              </div>

              <div class="ctl" data-field="confirm">
                    <label for="rekey-fixed">Rekey Shield Fixed Key?</label>
                    <div class="widget">
                      <input class="large-checkbox" name="rotate_fixed_key" type="checkbox" value="true" />
                      <p class="help">This rotates the <strong>Shield Fixed Key</strong>
                      used for fixed-key backups. Once rekeyed, this new key must be used to manually
                      restore all future fixed-key backups in a disaster scenario.</p>
                    </div>
                </div>

              <button class="go">Rekey</button>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--admin-users"><!-- {{{ -->
      [[#
        {admin-users} template

        Renders the list of local users, in the SHIELD database, allowing
        administrators to manage them, assigne them to tenants, etc.
      ]]
          <div class="gutter blk" id="admin-users">
            <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
            [[ if ($global.auth.is.system.manager) { ]]
            <a class="new" href="#!/admin/users/new">Create a New Local User &raquo;</a>
            [[ } ]]
            <h2>Local User Management</h2>
            [[ if (_.users.length == 0) { ]]
            <div class="no-data">No local SHIELD users have been created yet.</div>
            [[ } else { ]]
            <table>
              <thead><tr>
                <th>Name</th>
                <th>Username</th>
                <th>System Role</th>
                <th>Tenants</th>
                <th></th>
              </tr></thead>
              <tbody>
                [[ $.each(_.users, function (i, user) { ]]
                <tr>
                  <td><strong>[[= user.name ]]</strong></td>
                  <td>[[= user.account ]]</td>
                  <td>[[ if (user.sysrole == "") { ]]<span class="none">none</span>[[ } else { ]][[= user.sysrole ]][[ } ]]</td>
                  <td>
                    [[ if ((user.tenants || []).length == 0) { ]]
                    <span class="none">none</span>
                    [[ } else { ]]
                    <ul>
                      [[ $.each(user.tenants || [], function (j, tenant) { ]]
                      <li><strong>[[= tenant.name ]]</strong> ([[= tenant.role ]])</li>
                      [[ }); ]]
                    </ul>
                    [[ } ]]
                  </td>
                  <td>
                    [[ if ($global.auth.is.system.manager) { ]]
                    <a href="#!/admin/users/edit:uuid:[[= user.uuid ]]">edit</a>
                    [[ } ]]
                  </td>
                </tr>
                [[ }); ]]
              </tbody>
            </table>
            [[ } ]]
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--admin-users-new"><!-- {{{ -->
      [[#
        {admin-users-new} template

        Renders a form that administrators can use to create new local
        SHIELD user accounts, specifying their passwords and system roles.
      ]]
          <div class="gutter blk" id="admin-users">
            <a class="breadcrumb" href="#!/admin/users">&laquo; Back to Local User Management</a>
            <h2>New SHIELD User</h2>
            <form>
              <div class="ctl" data-field="name">
                <label for="new-user-name">Display Name</label>
                <span class="errors">
                  <span data-error="missing">Please provide a display name.</span>
                </span>
                <div class="widget">
                  <input type="text" name="name" id="new-user-name">
                  <p class="help"></p>
                </div>
              </div>

              <div class="ctl" data-field="account">
                <label for="new-user-account">Username</label>
                <span class="errors">
                  <span data-error="missing">Please provide a username.</span>
                </span>
                <div class="widget">
                  <input type="text" name="account" id="new-user-account">
                </div>
              </div>

              <div class="ctl" data-field="password">
                <label for="new-user-password">Password</label>
                <span class="errors">
                  <span data-error="missing">Please provide a password for this new user.</span>
                </span>
                <div class="widget">
                  <input type="password" name="password" id="new-user-password">
                </div>
              </div>

              <div class="ctl" data-field="confirm">
                <label for="new-user-confirm">Confirm</label>
                <span class="errors">
                  <span data-error="missing">Please confirm this new user's password.</span>
                  <span data-error="mismatch">These passwords don't match.</span>
                </span>
                <div class="widget">
                  <input type="password" name="confirm" id="new-user-confirm">
                </div>
              </div>

              <div class="ctl" data-field="sysrole">
                <label for="new-user-sysrole">System Role</label>
                <div class="widget">
                  <select name="sysrole" id="new-user-sysrole">
                    <option value="">None</option>
                    <option value="engineer">Engineer</option>
                    <option value="manager">Manager</option>
                    <option value="admin">Administrator</option>
                  </select>
                </div>
              </div>

              <button class="go">Create</button>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--admin-users-edit"><!-- {{{ -->
      [[#
        {admin-users-edit} template

        Renders a form that administrators can use to edit existing local
        SHIELD user accounts, specifying their passwords and system roles.
      ]]
          <div class="gutter blk" id="admin-users">
            <a class="breadcrumb" href="#!/admin/users">&laquo; Back to Local User Management</a>
            <h2>Update SHIELD User [[= _.user.account ]]</h2>
            <form>
              <div class="ctl" data-field="name">
                <label for="edit-user-name">Display Name</label>
                <span class="errors">
                  <span data-error="missing">Please provide a display name.</span>
                </span>
                <div class="widget">
                  <input type="text" name="name" id="edit-user-name" value="[[= _.user.name ]]">
                  <p class="help"></p>
                </div>
              </div>

              <div class="ctl" data-field="sysrole">
                <label for="edit-user-sysrole">System Role</label>
                <div class="widget">
                  <select name="sysrole" id="edit-user-sysrole"
                    [[ if ($global.auth.user.uuid == _.user.uuid || (!$global.auth.is.system.admin && _.user.sysrole == "admin")) { ]] disabled[[ } ]]>
                    <option value="">None</option>
                    <option value="engineer"[[ if (_.user.sysrole == "engineer") { ]] selected[[ } ]]>Engineer</option>
                    <option value="manager"[[ if (_.user.sysrole == "manager") { ]] selected[[ } ]]>Manager</option>
                    <option value="admin"[[ if (_.user.sysrole == "admin") { ]] selected[[ } ]]>Administrator</option>
                  </select>
                </div>
              </div>

              <button class="go">Update</button>
            </form>
          </div>
    <!-- }}} --></script>
    <script type="text/html" id="tpl--sessions"><!-- {{{ -->
        [[#
          {sessions} template

          Renders the list of all current user sessions
        ]]
            <div class="gutter blk">
              <a class="breadcrumb" href="#!/admin">&laquo; Back to Administration</a>
              <h2>Sessions</h2>
              [[ if (_.sessions.length == 0) { ]]
              <div class="no-data">No sessions have been created yet.</div>
              [[ } else { ]]
              <table>
                <thead><tr>
                  <th>Account</th>
                  <th>Created At</th>
                  <th>Last Seen</th>
                  <th>IP Address</th>
                  <th>User Agent</th>
                  <th></th>
                </tr></thead>
                <tbody>
                  [[ $.each(_.sessions, function (i, session) { ]]
                  <tr>
                    <td>[[= session.user_account ]]</td>
                    <td>[[= strftime("%Y-%m-%d %I:%M:%S%P", session.created_at) ]]</td>
                    <td>[[= trelative(session.last_seen_at, 14*86400) ]]</td>
                    <td>[[= session.ip_addr ]]</td>
                    <td id="user-agent">[[= session.user_agent ]]</td>
                    <td>[[ if (!session.current_session) {]]<a href="#!/admin/sessions/delete:uuid:[[= session.uuid ]]">delete</a> [[ } ]]</td>
                  </tr>
                  [[ }); ]]
                </tbody>
              </table>
              [[ } ]]
            </div>
      <!-- }}} --></script>
    <script type="text/html" id="tpl--sessions-delete"><!-- {{{ -->
        [[#
          {sessions-delete}

          A modal interaction screen that requires the operator to acknowledge
          that what they are about to do will result in the destruction of
          session data.
        ]]
            <div class="confirm">
              <h2>Delete The Session For Account:<em>[[= _.session.user_account ]]</em>?</h2>

              <p>You have requested that S.H.I.E.L.D. remove the session for
              the account "[[= _.session.user_account ]]".</p>

              <p class="q">Are you sure you want to delete the session for <em>[[= _.session.user_account ]]</em>?</p>
              <div class="a">
                <button class="danger" rel="yes">Yes, Delete It</button>
                <button class="safe" rel="close">No, Cancel This Operation</button>
              </div>
            </div>
      <!-- }}} --></script>
    <script type="text/html" id="tpl--"><!-- {{{ -->
    <!-- }}} --></script>

    <script src="/init.js"></script>
    <script src="/shield.js"></script>
  </body>
</html>
