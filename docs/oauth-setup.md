# Using an external OAuth provider with S.H.I.E.L.D

## Github

### Open the Github settings page

![Github Config Image](https://raw.githubusercontent.com/starkandwayne/shield/oauth-docs/docs/images/githubAuth/github1.png "github OAuth")

![Github Config Image](https://raw.githubusercontent.com/starkandwayne/shield/oauth-docs/docs/images/githubAuth/github2.png "github OAuth")

### Open "OAuth Apps" under the "Developer settings" field on the lower left menu

![Github Config Image](https://raw.githubusercontent.com/starkandwayne/shield/oauth-docs/docs/images/githubAuth/github3.png "github OAuth")

### Register a new Github OAuth client with the "Register a new application" button

![Github Config Image](https://raw.githubusercontent.com/starkandwayne/shield/oauth-docs/docs/images/githubAuth/github4.png "github OAuth")

- The only field that is SHIELD specific here is the "Authorization callback URL" field, which needs to be:
  - `http://<YOUR_SHIELD_ADDRESSS_HERE>/auth/oauth/<YOUR_GH_IDENTIFIER_FROM_YOUR_SHIELD_CONFIG_HERE>/redir`
- The other fields can contain any information that you'd like, as this client will be specific to your instance of SHIELD
- Github will now generate a client id and client secret that you will need to copy to the config yaml file you feed to SHIELD.

### Add the configuration for your Github OAuth client

This will be added to the already existing configuration YAML file you use to deploy shield under a new field called `auth:`

#### required fields are:

- name - this is the name that will be displayed in the UI and CLI when your users are interacting with SHIELD 
- identifier - this is the field that you put in the "Authorization callback URL" field when you set up your Github OAuth client. The SHIELD backend will use this to identify which OAuth Client was in use for things like logs and auditing.
- backend - this is a static value defined by SHIELD, and will always be `github` for this configuration
- properties:
  - client_id - this was auto generated by Github when you created your OAuth client
  - client_secret - this was also auto generated by Github when you created your OAuth client
  - mapping - this section will contain the mapping from github orgs to SHIELD tenants.  For each Github organization you may configure a mapping from a SHIELD tenant (that you make up the name of) to a github org name.  Then, underneath that,  you may define, based on the Github teams within the above Github org, what Role a given user will have in SHIELD.  You may also define a base case role that all users will get if they do not belong to one of the matching Github teams that you have provided.
    - <github_tenant_name> - this can be any name you would like.  SHIELD will create an internal SHIELD tenant with this given name
    - rights - this section will contain the mappings from Github team to a predefined SHIELD role, as wel as a default role for all users that don't belong to any of the specified Github teams
      - the shield roles are as follows:
        - admin
        - operator
        - engineer

#### Here is an example config used for SHIELD development:

```yaml
auth:
  - name:       Github
    identifier: public-gh
    backend:    github
    properties:
      client_id:     435abbcea49c948f8ab3
      client_secret: ffab373bc287d40ba73476bff3f449
      mapping:
        starkandwayne:           # <-- github org name
          tenant: starkandwayne  # <-- shield tenant name
          rights:
            - team: Owners       # <-- github team name
              role: admin        # <-- shield role name
            - team: Engineering  #   (first match wins)
              role: engineer
            - role: operator     # = (default match)
        cloudfoundry-community:
          tenant: CF Community
          rights:
            - role: engineer

  - name:       UAA
  ...
```

## UAA

This configuration gives you a single admin user with the password "PASSWORD"

### Have a working UAA instance

### Install cf-uaac Gem

```shell
gem install cf-uaac
uaac version
```

### Authenticate to UAA

```shell
uaac target --skip-ssl-validation http(s)://<your uaa address>

uaac token client get admin
```

### Create a new UAA Client for SHIELD

```shell
uaac client add shield-dev \
  --name S.H.I.E.L.D. \
  --scope openid \
  --authorities uaa.none \
  --authorized_grant_types authorization_code \
  --redirect_uri http://<YOUR_SHIELD_ADDRESSS_HERE>/auth/oauth/<YOUR_UAA_IDENTIFIER_FROM_YOUR_SHIELD_CONFIG_HERE>/redir \
  --access_token_validity  180 \
  --refresh_token_validity 180 \
  --secret s.h.i.e.l.d.
```

SHIELD requires the openid scope as this scope is required to access the /userinfo endpoint, which gives SHIELD the various standard user profile/group fields that it needs in order to exectue on the mapping in the configuration.

### Add the configuration for your UAA OAuth client

This will have identical required fields to the Github OAuth client defined above, with the exception of the backend being `uaa`, and the mapping section.  For UAA, SHIELD maps based on a users scim rights rather than the Github team they belong to.

#### Here is the other section of the config used for SHIELD development:

```yaml
auth:
  - name:       Github
    ...

  - name:       UAA
    identifier: uaa1
    backend:    uaa
    properties:
      client_id:       shield-dev
      client_secret:   s.h.i.e.l.d.
      uaa_endpoint:    https://uaa.shield.10.244.156.2.netip.cc:8443
      skip_verify_tls: true
      mapping:
        - tenant: UAA          # <-- shield tenant name
          rights:
            - scim: uaa.admin  # <-- uaa scim right
              role: admin      # <-- shield role
                               #   (first match wins)
            - scim: cloud_controller.write
              role: engineer

            - role: operator   # = (default match)

        - tenant: UAA Admins Club
          rights:
            - scim: uaa.admin
              role: admin
```
